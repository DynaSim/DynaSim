<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ds.monitorStudy</title>
  <meta name="keywords" content="ds.monitorStudy">
  <meta name="description" content="MONITORSTUDY - display information on study progress.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html functions -->
<h1>ds.monitorStudy
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>MONITORSTUDY - display information on study progress.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [studyinfo,study_status]=ds.monitorStudy(studyinfo,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">MONITORSTUDY - display information on study progress.

 Usage:
   [studyinfo,status]=ds.monitorStudy(studyinfo,key/value options)

 Inputs:
   - studyinfo: DynaSim studyinfo structure, study directory, or studyinfo MAT filename
   - options: TODO

 Outputs:
   - studyinfo: DynaSim studyinfo structure
   - status: numeric code
       0 (study in progress)
       1 (study finished)
       2 (error in study)
       -1 (function failed)

 See also: <a href="ds.simulateModel.html" class="code" title="function [data,studyinfo]=ds.simulateModel(model,varargin)">ds.simulateModel</a>, <a href="ds.createBatch.html" class="code" title="function studyinfo = ds.createBatch(base_model,modifications_set,varargin)">ds.createBatch</a>, <a href="ds.checkStudyinfo.html" class="code" title="function studyinfo=ds.checkStudyinfo(studyinfo,varargin)">ds.checkStudyinfo</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="ds.checkOptions.html" class="code" title="function [parms, params_unspecified ] = ds.checkOptions(options, options_schema, strict)">ds.checkOptions</a>	CHECKOPTIONS - organize key/value pairs in structure with default or user-supplied values according to a schema</li><li><a href="ds.checkStudyinfo.html" class="code" title="function studyinfo=ds.checkStudyinfo(studyinfo,varargin)">ds.checkStudyinfo</a>	CHECKSTUDYINFO - Standardize studyinfo structure and auto-populate missing fields</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="ds.createBatch.html" class="code" title="function studyinfo = ds.createBatch(base_model,modifications_set,varargin)">ds.createBatch</a>	CREATEBATCH - create and submit jobs to run sets of simulations or analyses.</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [studyinfo,study_status]=ds.monitorStudy(studyinfo,varargin)</a>
0002 <span class="comment">%MONITORSTUDY - display information on study progress.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Usage:</span>
0005 <span class="comment">%   [studyinfo,status]=ds.monitorStudy(studyinfo,key/value options)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% Inputs:</span>
0008 <span class="comment">%   - studyinfo: DynaSim studyinfo structure, study directory, or studyinfo MAT filename</span>
0009 <span class="comment">%   - options: TODO</span>
0010 <span class="comment">%</span>
0011 <span class="comment">% Outputs:</span>
0012 <span class="comment">%   - studyinfo: DynaSim studyinfo structure</span>
0013 <span class="comment">%   - status: numeric code</span>
0014 <span class="comment">%       0 (study in progress)</span>
0015 <span class="comment">%       1 (study finished)</span>
0016 <span class="comment">%       2 (error in study)</span>
0017 <span class="comment">%       -1 (function failed)</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% See also: ds.simulateModel, ds.createBatch, ds.checkStudyinfo</span>
0020 
0021 <span class="comment">% Check inputs</span>
0022 options=<a href="ds.checkOptions.html" class="code" title="function [parms, params_unspecified ] = ds.checkOptions(options, options_schema, strict)">ds.checkOptions</a>(varargin,{<span class="keyword">...</span>
0023   <span class="string">'verbose_flag'</span>,1,{0,1},<span class="keyword">...</span>
0024   <span class="string">'process_id'</span>,[],[],<span class="keyword">...</span><span class="comment"> % process identifier for loading studyinfo if necessary</span>
0025   },false);
0026 <span class="keyword">if</span> isstruct(studyinfo) &amp;&amp; isfield(studyinfo,<span class="string">'study_dir'</span>)
0027   <span class="comment">% retrieve most up-to-date studyinfo structure from studyinfo.mat file</span>
0028   studyinfo=<a href="ds.checkStudyinfo.html" class="code" title="function studyinfo=ds.checkStudyinfo(studyinfo,varargin)">ds.checkStudyinfo</a>(studyinfo.study_dir,<span class="string">'process_id'</span>,options.process_id);
0029 <span class="keyword">else</span>
0030   <span class="comment">% process the provided studyinfo structure</span>
0031   studyinfo=<a href="ds.checkStudyinfo.html" class="code" title="function studyinfo=ds.checkStudyinfo(studyinfo,varargin)">ds.checkStudyinfo</a>(studyinfo,<span class="string">'process_id'</span>,options.process_id);
0032 <span class="keyword">end</span>
0033 
0034 <span class="comment">% Check status of study</span>
0035 <span class="keyword">if</span> all(strcmp(<span class="string">'finished'</span>,{studyinfo.simulations.status}))
0036   study_status=1; <span class="comment">% study finished</span>
0037 <span class="keyword">elseif</span> any(~cellfun(@isempty,{studyinfo.simulations.error_log}))
0038   study_status=-1; <span class="comment">% errors in study</span>
0039 <span class="keyword">else</span>
0040   study_status=0; <span class="comment">% study in progress</span>
0041 <span class="keyword">end</span>
0042 
0043 <span class="keyword">if</span> options.verbose_flag==0
0044   <span class="keyword">return</span>;
0045 <span class="keyword">end</span>
0046 
0047 fprintf(<span class="string">'-------------------------------------------------------------\n'</span>);
0048 <span class="comment">%% 1.0 Processing statistics by host (e.g., compute times)</span>
0049 <span class="comment">% get host for each simulation</span>
0050 running=find(~arrayfun(@(x)isempty(x.machine_info),studyinfo.simulations));
0051 <span class="keyword">if</span> any(running)
0052   hosts=arrayfun(@(x)x.machine_info.host_name,studyinfo.simulations(running),<span class="string">'uni'</span>,0);
0053   <span class="comment">% make list of unique hosts</span>
0054   uniq_hosts=unique(hosts);
0055   num_hosts=length(uniq_hosts);
0056   <span class="comment">% collect info for each host</span>
0057   num_simulations=zeros(1,num_hosts);
0058   num_finished=zeros(1,num_hosts);
0059   mean_duration=zeros(1,num_hosts);
0060   num_running=zeros(1,num_hosts);
0061   num_failed=zeros(1,num_hosts);
0062   num_cores=zeros(1,num_hosts);
0063   <span class="keyword">for</span> i=1:num_hosts
0064     <span class="comment">% get list of simulations on this host</span>
0065     these_sims=running(strcmp(uniq_hosts{i},hosts));
0066     <span class="comment">% store the number of simulations processed on this host</span>
0067     num_simulations(i)=length(these_sims);
0068     <span class="comment">% get list of simulations that are running on this host</span>
0069     started=strcmp(<span class="string">'started'</span>,{studyinfo.simulations(these_sims).status});
0070     num_running(i)=length(find(started));
0071     <span class="comment">% get list of simulations that have finished</span>
0072     finished=strcmp(<span class="string">'finished'</span>,{studyinfo.simulations(these_sims).status});
0073     num_finished(i)=length(find(finished));
0074     <span class="comment">% get mean duration of simulations that have finished</span>
0075     <span class="keyword">if</span> num_finished(i)&gt;0
0076       mean_duration(i)=mean([studyinfo.simulations(these_sims(finished)).duration]);
0077     <span class="keyword">else</span>
0078       mean_duration(i)=nan;
0079     <span class="keyword">end</span>
0080     <span class="comment">% get list of simulations that have failed</span>
0081     failed=strcmp(<span class="string">'failed'</span>,{studyinfo.simulations(these_sims).status});
0082     num_failed(i)=length(find(failed));
0083     <span class="comment">% tech info</span>
0084     <span class="keyword">try</span>
0085       num_cores(i)=studyinfo.simulations(these_sims(1)).machine_info.num_cores;
0086     <span class="keyword">catch</span>
0087       num_cores(i)=nan;
0088     <span class="keyword">end</span>
0089     <span class="comment">%total_memory=studyinfo.simulations(these_sims(1)).machine_info.total_memory; % string</span>
0090   <span class="keyword">end</span>
0091   <span class="comment">% sort hosts by mean_duration</span>
0092   [~,I]=sort(mean_duration,2,<span class="string">'descend'</span>);
0093   <span class="comment">% display info for each host</span>
0094   fprintf(<span class="string">'Processing statistics (hosts sorted by mean compute time T):\n'</span>);
0095   <span class="keyword">for</span> i=1:num_hosts
0096     index=I(i);
0097     fprintf(<span class="string">'  @%s (%g cores)\n'</span>,uniq_hosts{index},num_cores(index));<span class="comment">%,num_finished(index),num_simulations(index),mean_duration(index),num_failed(index),num_running(index));</span>
0098     fprintf(<span class="string">'    %g of %g sims finished (T: %gsec); %g failed; %g running.\n'</span>,num_finished(index),num_simulations(index),mean_duration(index),num_failed(index),num_running(index));
0099   <span class="keyword">end</span>
0100 <span class="keyword">end</span>
0101 
0102 <span class="comment">%% 2.0 Errors</span>
0103 <span class="comment">% get list of errors over all simulations</span>
0104 errors={studyinfo.simulations.error_log};
0105 <span class="comment">% collapse into list of unique errors</span>
0106 uniq_errors=unique(errors(cellfun(@ischar,errors)));
0107 <span class="comment">% number of unique errors</span>
0108 num_uniq_errors=length(uniq_errors);
0109 <span class="comment">% indices to simulations with errors</span>
0110 error_inds=find(~cellfun(@isempty,errors)); 
0111 <span class="keyword">if</span> options.verbose_flag
0112   <span class="comment">% Display errors for each simulation</span>
0113   <span class="keyword">if</span> any(error_inds) <span class="comment">% some sims had errors</span>
0114     fprintf(<span class="string">'Errors:\n'</span>);
0115     <span class="keyword">for</span> i=1:length(error_inds)
0116       siminfo=studyinfo.simulations(error_inds(i));
0117       <span class="keyword">if</span> strcmp(siminfo.status,<span class="string">'finished'</span>)
0118         fprintf(<span class="string">'  Simulation %g (error corrected, now %s):\n'</span>,siminfo.sim_id,siminfo.status);
0119       <span class="keyword">elseif</span> ~strcmp(siminfo.status,<span class="string">'failed'</span>)
0120         fprintf(<span class="string">'  Simulation %g (now re-%s):\n'</span>,siminfo.sim_id,siminfo.status);
0121       <span class="keyword">else</span>
0122         fprintf(<span class="string">'  Simulation %g (%s):\n'</span>,siminfo.sim_id,siminfo.status);
0123       <span class="keyword">end</span>
0124       <span class="keyword">try</span> fprintf(<span class="string">'    Host name: %s\n'</span>,siminfo.machine_info.host_name); <span class="keyword">end</span>
0125       fprintf(<span class="string">'    Start time: %s\n'</span>,siminfo.start_time);  
0126       fprintf(<span class="string">'    Error log: %s\n'</span>,siminfo.error_log);
0127     <span class="keyword">end</span>
0128   <span class="keyword">end</span>
0129 <span class="keyword">else</span>
0130   <span class="comment">% Display each unique error message only once</span>
0131   <span class="keyword">if</span> any(error_inds) <span class="comment">% some sims had errors</span>
0132     fprintf(<span class="string">'Unique Errors:\n'</span>);
0133     <span class="comment">% display each unique error message once and list the simulation IDs with</span>
0134     <span class="comment">% matching errors</span>
0135     <span class="keyword">for</span> i=1:num_uniq_errors
0136       <span class="comment">% do nothing if there is no error message</span>
0137       <span class="keyword">if</span> isempty(uniq_errors{i})
0138         <span class="keyword">continue</span>; 
0139       <span class="keyword">end</span>
0140       <span class="comment">% get list of simulations with this error</span>
0141       matches=strcmp(uniq_errors{i},errors);
0142       sim_ids=[studyinfo.simulations(matches).sim_id];
0143       fprintf(<span class="string">'  Simulation(s) %s:\n'</span>,num2str(sim_ids));
0144       fprintf(<span class="string">'    Error log: %s\n'</span>,uniq_errors{i});
0145     <span class="keyword">end</span>
0146   <span class="keyword">end</span>
0147 <span class="keyword">end</span>
0148 
0149 <span class="comment">%% 3.0 Paths</span>
0150 fprintf(<span class="string">'Paths:\n'</span>);
0151 fprintf(<span class="string">'  Study directory: %s\n'</span>,studyinfo.study_dir);
0152 <span class="keyword">if</span> ~isempty(studyinfo.paths)
0153   <span class="keyword">if</span> isfield(studyinfo.paths,<span class="string">'mechanisms'</span>) &amp;&amp; iscell(studyinfo.paths.mechanisms)
0154     <span class="keyword">if</span> length(studyinfo.paths.mechanisms)==1 <span class="comment">% print path on one line</span>
0155       fprintf(<span class="string">'  Model files:     %s\n'</span>,studyinfo.paths.mechanisms{1});
0156     <span class="keyword">else</span> <span class="comment">% print each mech path on a separate line</span>
0157       fprintf(<span class="string">'  Model files:\n'</span>);
0158       <span class="keyword">for</span> i=1:length(studyinfo.paths.mechanisms)
0159         fprintf(<span class="string">'    %s\n'</span>,studyinfo.paths.mechanisms{i});
0160       <span class="keyword">end</span>
0161     <span class="keyword">end</span>
0162   <span class="keyword">end</span>
0163   <span class="keyword">if</span> isfield(studyinfo.paths,<span class="string">'dynasim_functions'</span>)  
0164     fprintf(<span class="string">'  DynaSim functions: %s\n'</span>,studyinfo.paths.dynasim_functions);
0165   <span class="keyword">end</span>
0166   <span class="keyword">if</span> isfield(studyinfo.paths,<span class="string">'batch_dir'</span>)
0167     fprintf(<span class="string">'  Batch directory: %s\n'</span>,studyinfo.paths.batch_dir);
0168   <span class="keyword">end</span>
0169 <span class="keyword">end</span>
0170 
0171 <span class="comment">%% 4.0 Status summary</span>
0172 <span class="comment">% get status for each simulation</span>
0173 status={studyinfo.simulations.status};
0174 <span class="comment">% make list of status types</span>
0175 uniq_status=unique(status);
0176 <span class="comment">% display counts for each status type</span>
0177 fprintf(<span class="string">'Simulation status summary:\n'</span>);
0178 <span class="keyword">for</span> i=1:length(uniq_status)
0179   count=length(find(strcmp(uniq_status{i},status)));
0180   fprintf(<span class="string">'  %g %s\n'</span>,count,uniq_status{i});
0181 <span class="keyword">end</span>
0182 
0183 <span class="comment">%% notify about special cases</span>
0184 <span class="keyword">if</span> all(strcmp(<span class="string">'finished'</span>,status))
0185   fprintf(<span class="string">'**** ALL SIMULATIONS HAVE FINISHED ****\n'</span>);
0186 <span class="keyword">end</span>
0187 <span class="keyword">if</span> all(strcmp(<span class="string">'initialized'</span>,status))
0188   fprintf(<span class="string">'**** NO SIMULATIONS HAVE STARTED ****\n'</span>);
0189 <span class="keyword">end</span>
0190 <span class="keyword">if</span> all(strcmp(<span class="string">'started'</span>,status))
0191   fprintf(<span class="string">'**** ALL SIMULATIONS ARE RUNNING ****\n'</span>);
0192 <span class="keyword">end</span>
0193 <span class="keyword">if</span> all(strcmp(<span class="string">'failed'</span>,status))
0194   fprintf(<span class="string">'**** ALL SIMULATIONS FAILED ****\n'</span>);
0195 <span class="keyword">end</span>
0196 
0197 fprintf(<span class="string">'-------------------------------------------------------------\n'</span>);
0198</pre></div>
<hr><address>Generated on Fri 07-Apr-2017 20:01:20 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>