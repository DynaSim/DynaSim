<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of dsAnalyze</title>
  <meta name="keywords" content="dsAnalyze">
  <meta name="description" content="DSANALYZE - Apply an analysis function to DynaSim data, optionally saving data">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html functions -->
<h1>dsAnalyze
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>DSANALYZE - Apply an analysis function to DynaSim data, optionally saving data</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function result=dsAnalyze(data,func,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">DSANALYZE - Apply an analysis function to DynaSim data, optionally saving data

 Pass a single DynaSim data structure or an array of data structures to a
 user-specified analysis function, add varied info to the results and
 optionally save the output structure.

 Usage:
   result = dsAnalyze(data,func,'option1',value1,...)

 Inputs:
   - data: DynaSim data structure (also accepted: data file name)
   - func: function handle pointing to analysis function
   - options: (key/value pairs are passed on to the analysis function)
     'save_results_flag'   : whether to save result {0 or 1} (default: 0)
     'result_file'         : where to save result (default: 'result.mat')
     'format'              : format for saved plots if figures are generated
                             {'svg','jpg','eps','png'} (default: 'svg')
     'varied_filename_flag': whether to make filename based on the varied
                             parameters and type of plot {0 or 1} (default: 0)

 Outputs:
   - result: structure returned by the analysis function

 TODO: annotate figures with data set-specific modifications

 See also: <a href="dsSimulate.html" class="code" title="function [data,studyinfo]=dsSimulate(model,varargin)">dsSimulate</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="ds.checkOptions.html" class="code" title="function [parms, params_unspecified ] = ds.checkOptions(options, options_schema, strict)">ds.checkOptions</a>	CHECKOPTIONS - organize key/value pairs in structure with default or user-supplied values according to a schema</li><li><a href="ds.importData.html" class="code" title="function [data,studyinfo] = ds.importData(file,varargin)">ds.importData</a>	IMPORTDATA - load data into DynaSim formatted data structure.</li><li><a href="ds.nameFromVaried.html" class="code" title="function new_result_file = ds.nameFromVaried(data, file_type, old_result_file)">ds.nameFromVaried</a>	NAMEFROMVARIED - makes a filename based on the parameters in data.varied.</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="dsSimulate.html" class="code" title="function [data,studyinfo]=dsSimulate(model,varargin)">dsSimulate</a>	% data=dsSimulate(model,'option',value,...)</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function result = add_modifications(result)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function result=dsAnalyze(data,func,varargin)</a>
0002 <span class="comment">%DSANALYZE - Apply an analysis function to DynaSim data, optionally saving data</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Pass a single DynaSim data structure or an array of data structures to a</span>
0005 <span class="comment">% user-specified analysis function, add varied info to the results and</span>
0006 <span class="comment">% optionally save the output structure.</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% Usage:</span>
0009 <span class="comment">%   result = dsAnalyze(data,func,'option1',value1,...)</span>
0010 <span class="comment">%</span>
0011 <span class="comment">% Inputs:</span>
0012 <span class="comment">%   - data: DynaSim data structure (also accepted: data file name)</span>
0013 <span class="comment">%   - func: function handle pointing to analysis function</span>
0014 <span class="comment">%   - options: (key/value pairs are passed on to the analysis function)</span>
0015 <span class="comment">%     'save_results_flag'   : whether to save result {0 or 1} (default: 0)</span>
0016 <span class="comment">%     'result_file'         : where to save result (default: 'result.mat')</span>
0017 <span class="comment">%     'format'              : format for saved plots if figures are generated</span>
0018 <span class="comment">%                             {'svg','jpg','eps','png'} (default: 'svg')</span>
0019 <span class="comment">%     'varied_filename_flag': whether to make filename based on the varied</span>
0020 <span class="comment">%                             parameters and type of plot {0 or 1} (default: 0)</span>
0021 <span class="comment">%</span>
0022 <span class="comment">% Outputs:</span>
0023 <span class="comment">%   - result: structure returned by the analysis function</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% TODO: annotate figures with data set-specific modifications</span>
0026 <span class="comment">%</span>
0027 <span class="comment">% See also: dsSimulate</span>
0028 
0029 <span class="comment">% check inputs</span>
0030 options=<a href="ds.checkOptions.html" class="code" title="function [parms, params_unspecified ] = ds.checkOptions(options, options_schema, strict)">ds.checkOptions</a>(varargin,{<span class="keyword">...</span>
0031   <span class="string">'result_file'</span>,<span class="string">'result'</span>,[],<span class="keyword">...</span>
0032   <span class="string">'save_results_flag'</span>,0,{0,1},<span class="keyword">...</span>
0033   <span class="string">'format'</span>,<span class="string">'svg'</span>,{<span class="string">'svg'</span>,<span class="string">'jpg'</span>,<span class="string">'eps'</span>,<span class="string">'png'</span>,<span class="string">'fig'</span>},<span class="keyword">...</span>
0034   <span class="string">'varied_filename_flag'</span>,0,{0,1},<span class="keyword">...</span>
0035   <span class="string">'plot_type'</span>,<span class="string">'waveform'</span>,{<span class="string">'waveform'</span>,<span class="string">'rastergram'</span>,<span class="string">'raster'</span>,<span class="string">'power'</span>,<span class="string">'rates'</span>,<span class="string">'imagesc'</span>,<span class="string">'heatmapFR'</span>,<span class="string">'heatmap_sortedFR'</span>,<span class="string">'meanFR'</span>,<span class="string">'meanFRdens'</span>},<span class="keyword">...</span>
0036   <span class="string">'save_prefix'</span>,[],[],<span class="keyword">...</span>
0037   },false);
0038 
0039 <span class="comment">% change result_file</span>
0040 <span class="keyword">if</span> options.varied_filename_flag &amp;&amp; isfield(data, <span class="string">'varied'</span>)
0041   <span class="keyword">if</span> isfield(options, <span class="string">'save_prefix'</span>) &amp;&amp; ~isempty(options.save_prefix)
0042     prefix = options.save_prefix;
0043   <span class="keyword">else</span>
0044     <span class="keyword">if</span> regexpi(func2str(func), <span class="string">'plot'</span>)
0045       prefix = options.plot_type;
0046     <span class="keyword">else</span>
0047       prefix = func2str(func);
0048     <span class="keyword">end</span>
0049   <span class="keyword">end</span>
0050   options.result_file = <a href="ds.nameFromVaried.html" class="code" title="function new_result_file = ds.nameFromVaried(data, file_type, old_result_file)">ds.nameFromVaried</a>(data, prefix, options.result_file);
0051 <span class="keyword">end</span>
0052 
0053 <span class="comment">% load data if input is not a DynaSim data structure</span>
0054 <span class="keyword">if</span> ~(isstruct(data) &amp;&amp; isfield(data,<span class="string">'time'</span>))
0055   data=<a href="ds.importData.html" class="code" title="function [data,studyinfo] = ds.importData(file,varargin)">ds.importData</a>(data,varargin{:}); <span class="comment">% load data</span>
0056 <span class="keyword">end</span>
0057 
0058 <span class="comment">% confirm function handle</span>
0059 <span class="keyword">if</span> ~isa(func,<span class="string">'function_handle'</span>)
0060   error(<span class="string">'post-processing function must be supplied as a function handle'</span>);
0061 <span class="keyword">end</span>
0062 <span class="comment">% confirm single analysis function</span>
0063 <span class="keyword">if</span> numel(func)&gt;1
0064   error(<span class="string">'Too many function handles were supplied. dsAnalyze only applies a single function to a single data set.'</span>);
0065 <span class="keyword">end</span>
0066 <span class="comment">% save data if no output is requested</span>
0067 <span class="keyword">if</span> nargout&lt;1
0068   options.save_results_flag=1;
0069 <span class="keyword">end</span>
0070 
0071 <span class="comment">% convert data to double precision before analysis</span>
0072 <span class="keyword">for</span> j=1:length(data)
0073   <span class="keyword">for</span> k=1:length(data(j).labels)
0074     fld=data(j).labels{k};
0075   data(j).(fld)=double(data(j).(fld));
0076   <span class="keyword">end</span>
0077 <span class="keyword">end</span>
0078 
0079 <span class="comment">% do analysis</span>
0080 fprintf(<span class="string">'\tExecuting post-processing function: %s\n'</span>,func2str(func));
0081 tstart=tic;
0082 result=feval(func,data,varargin{:});
0083 fprintf(<span class="string">'\t\tElapsed time: %g sec\n'</span>,toc(tstart));
0084 
0085 <span class="comment">% Dave: Not all plotting functions will return a plot handle. For</span>
0086 <span class="comment">% example, dsPlot2 returns a nested structure of figure, axis, and plot</span>
0087 <span class="comment">% handles. This command updates it.</span>
0088 <span class="keyword">if</span> isstruct(result)
0089     <span class="keyword">if</span> isfield(result,<span class="string">'hcurr'</span>)
0090         result = result.hcurr;
0091     <span class="keyword">end</span>
0092 <span class="keyword">end</span>
0093 
0094 <span class="comment">% determine if result is a plot handle or derived data</span>
0095 <span class="keyword">if</span> all(ishandle(result)) <span class="comment">% analysis function returned a graphics handle</span>
0096   <span class="keyword">for</span> i=1:length(result)
0097     <span class="comment">% save plot</span>
0098     <span class="keyword">if</span> options.save_results_flag
0099       extension=[<span class="string">'.'</span> options.format];<span class="comment">%'.svg'; % {.jpg,.svg}</span>
0100       <span class="comment">% temporary default: jpg</span>
0101       <span class="keyword">if</span> length(result)==1
0102         fname=[options.result_file extension];
0103       <span class="keyword">else</span>
0104         fname=[options.result_file <span class="string">'_page'</span> num2str(i) extension];
0105       <span class="keyword">end</span>
0106       set(gcf,<span class="string">'PaperPositionMode'</span>,<span class="string">'auto'</span>);
0107       fprintf(<span class="string">'\t\tSaving plot: %s\n'</span>,fname);
0108       
0109       <span class="keyword">switch</span> extension
0110         <span class="keyword">case</span> <span class="string">'.svg'</span>
0111           plot2svg(fname,result(i));
0112         <span class="keyword">case</span> <span class="string">'.jpg'</span>
0113           print(result(i),fname,<span class="string">'-djpeg'</span>);
0114         <span class="keyword">case</span> <span class="string">'.eps'</span>
0115           print(result(i),fname,<span class="string">'-depsc'</span>);
0116         <span class="keyword">case</span> <span class="string">'.png'</span>
0117           print(result(i),fname,<span class="string">'-dpng'</span>);
0118         <span class="keyword">case</span> <span class="string">'.fig'</span>
0119           savefig(result(i),fname);
0120       <span class="keyword">end</span>
0121     <span class="keyword">end</span>
0122   <span class="keyword">end</span>
0123 <span class="keyword">else</span> <span class="comment">% analysis function returned derived data</span>
0124   <span class="keyword">if</span> isstruct(result)
0125     result = <a href="#_sub1" class="code" title="subfunction result = add_modifications(result)">add_modifications</a>(result);
0126     
0127     <span class="keyword">for</span> i=1:length(result)
0128       <span class="comment">% add options to result structure</span>
0129       <span class="keyword">if</span> length(varargin)&gt;1
0130         <span class="keyword">for</span> j=1:2:length(varargin)
0131           result(i).options.(varargin{j})=varargin{j+1};
0132         <span class="keyword">end</span>
0133       <span class="keyword">else</span>
0134         result(i).options=[];
0135       <span class="keyword">end</span>
0136     <span class="keyword">end</span>
0137   <span class="keyword">end</span>
0138   <span class="comment">% save derived data</span>
0139   <span class="keyword">if</span> options.save_results_flag
0140     fname=options.result_file;
0141     extension = <span class="string">'.mat'</span>;
0142     <span class="keyword">if</span> ~strcmp(fname(end-3:end), extension) <span class="comment">%check for .mat extension</span>
0143       fname=[fname extension];
0144     <span class="keyword">end</span>
0145     fprintf(<span class="string">'\t\tSaving derived data: %s\n'</span>, fname);
0146     save(fname,<span class="string">'result'</span>,<span class="string">'-v7.3'</span>);
0147   <span class="keyword">end</span>
0148 <span class="keyword">end</span>
0149 
0150   <a name="_sub1" href="#_subfunctions" class="code">function result = add_modifications(result)</a>
0151     <span class="comment">% add modifications to result structure, excluding modifications made</span>
0152     <span class="comment">% within experiments. note: while this nested function is similar to</span>
0153     <span class="comment">% prepare_varied_metadata in dsSimulate, the data structure contains</span>
0154     <span class="comment">% all modifications (those within and across experiments; listed in 'varied').</span>
0155     <span class="comment">% the result structure collapses data sets from an experiment into a single</span>
0156     <span class="comment">% result; thus, each result corresponds to modifications across</span>
0157     <span class="comment">% experiments but not within them; those modifications are stored in</span>
0158     <span class="comment">% the simulator options.</span>
0159     <span class="keyword">if</span> ~isempty(data(1).simulator_options.modifications)
0160       varied={};
0161       mods=data(1).simulator_options.modifications;
0162       <span class="keyword">for</span> ii=1:length(result)
0163         <span class="keyword">for</span> jj=1:size(mods,1) 
0164           <span class="comment">% prepare valid field name for thing varied:</span>
0165           fld=[mods{jj,1} <span class="string">'_'</span> mods{jj,2}];
0166           
0167           <span class="comment">% convert arrows and periods to underscores</span>
0168           fld=regexprep(fld,<span class="string">'(-&gt;)|(&lt;-)|(-)|(\.)'</span>,<span class="string">'_'</span>);
0169           
0170           <span class="comment">% remove brackets and parentheses</span>
0171           fld=regexprep(fld,<span class="string">'[\[\]\(\)\{\}]'</span>,<span class="string">''</span>);
0172           result(ii).(fld)=mods{jj,3};
0173           varied{end+1}=fld;
0174         <span class="keyword">end</span>
0175         result(ii).varied=varied;
0176         result(ii).modifications=mods;
0177       <span class="keyword">end</span>
0178     <span class="keyword">elseif</span> isfield(data,<span class="string">'varied'</span>) &amp;&amp; length(data)==1
0179       <span class="comment">% add 'varied' info from data to result structure</span>
0180       <span class="keyword">for</span> ii=1:length(result)
0181         result(ii).varied=data(1).varied;
0182         <span class="keyword">for</span> jj=1:length(data(1).varied)
0183           result(ii).(data(1).varied{jj})=data(1).(data(1).varied{jj});
0184         <span class="keyword">end</span>
0185       <span class="keyword">end</span>
0186     <span class="keyword">end</span>
0187   <span class="keyword">end</span>
0188 
0189 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 07-Apr-2017 20:01:20 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>