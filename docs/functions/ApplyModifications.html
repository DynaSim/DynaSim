<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ds.applyModifications</title>
  <meta name="keywords" content="ds.applyModifications">
  <meta name="description" content="APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html functions -->
<h1>ds.applyModifications
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [output,modifications]=ds.applyModifications(model,modifications) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure

 ds.applyModifications returns the same kind of structure with
 modifications applied. In all cases it first modifies the specification
 (model.specification if input is a model structure). Then it returns
 the modified specification or regenerates the model using the new
 specification.

 Inputs:
   - model: DynaSim model or specification structure
     - see ds.checkModel and ds.checkSpecification for details
   - modifications: modifications to make to specification structure
       {X,Y,Z; X,Y,Z; ...}
       X = population name or connection source-&gt;target
       Y = thing to modify ('name', 'size', or parameter name)
       set Y=Z if Y = name, size, or value
       Note: (X1,X2) or (Y1,Y2): modify these simultaneously in the same way

 Outputs:
   - TODO

 Examples:
   - modifying population size and parameters:
       modifications={'E','size',5; 'E','gNa',120};
       model=ds.applyModifications(model,modifications);

   - modifying mechanism_list:
       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','mechanism_list','-iNa'});
       m.populations.mechanism_list
       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','mechanism_list','+iCa'});
       m.populations.mechanism_list
       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','mechanism_list','+(iCa,iCan,CaBuffer)'});
       m.populations.mechanism_list

   - modifying equations (using special &quot;cat()&quot; operator or direct substitution)
       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','equations','cat(dv/dt,+I)'});
       m.populations.equations
       m=ds.applyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...
                            {'pop1','equations','cat(I(t),+sin(2*pi*t))'});
       m.populations.equations
       m=ds.applyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...
                            {'pop1','equations','dv/dt=10+@current'});
       m.populations.equations
       m.populations.mechanism_list

   - modifying equations with reserved keywords &quot;ODEn&quot; and &quot;FUNCTIONn&quot;
     - Note:
       'ODEn' = reserved keyword referencing the n-th ODE in equations
       'ODE' = aliases ODE1
       similarly: 'FUNCTIONn' and 'FUNCTION'

       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','equations','cat(ODE,+I)'});
       m.populations.equations
       m=ds.applyModifications('dv/dt=10+@current; du/dt=-u; {iNa,iK}',...
                            {'pop1','equations','cat(ODE2,+I)'});
       m.populations.equations
       m=ds.applyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...
                            {'pop1','equations','cat(FUNCTION,+sin(2*pi*t))'});
       m.populations.equations

 See also: <a href="ds.generateModel.html" class="code" title="function [model,name_map]=ds.generateModel(specification,varargin)">ds.generateModel</a>, <a href="ds.simulateModel.html" class="code" title="function [data,studyinfo]=ds.simulateModel(model,varargin)">ds.simulateModel</a>, <a href="ds.vary2Modifications.html" class="code" title="function modifications_set = ds.vary2Modifications(vary,model)">ds.vary2Modifications</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="ds.checkSpecification.html" class="code" title="function spec=ds.checkSpecification(specification)">ds.checkSpecification</a>	CHECKSPECIFICATION - standardize specification structure and auto-populate missing fields</li><li><a href="ds.generateModel.html" class="code" title="function [model,name_map]=ds.generateModel(specification,varargin)">ds.generateModel</a>	GENERATEMODEL - Parse DynaSim specification and organize model data in DynaSim model structure</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="ds.generateModel.html" class="code" title="function [model,name_map]=ds.generateModel(specification,varargin)">ds.generateModel</a>	GENERATEMODEL - Parse DynaSim specification and organize model data in DynaSim model structure</li><li><a href="ds.probeCellProperties.html" class="code" title="function data = ds.probeCellProperties(model,varargin)">ds.probeCellProperties</a>	data = ds.probeCellProperties(model,'option1',option1,...)</li><li><a href="ds.probeFI.html" class="code" title="function data=ds.probeFI(model,varargin)">ds.probeFI</a>	% data=ds.probeFI(model,varargin)</li><li><a href="ds.simulateModel.html" class="code" title="function [data,studyinfo]=ds.simulateModel(model,varargin)">ds.simulateModel</a>	% data=ds.simulateModel(model,'option',value,...)</li><li><a href="ds.writeDynaSimSolver.html" class="code" title="function [outfile,options]=ds.writeDynaSimSolver(model,varargin)">ds.writeDynaSimSolver</a>	WRITEDYNASIMSOLVER - write m-file that numerically inteegrates the model</li><li><a href="ds.writeMatlabSolver.html" class="code" title="function solve_ode_filepath = ds.writeMatlabSolver(model,varargin)">ds.writeMatlabSolver</a>	WRITEMATLABSOLVER - write m-file that numerically inteegrates the model</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function modifications=standardize_modifications(modifications,specification)</a></li><li><a href="#_sub2" class="code">function spec=modify_specification(spec,mods)</a></li><li><a href="#_sub3" class="code">function modifications=backward_compatibility(modifications)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [output,modifications]=ds.applyModifications(model,modifications)</a>
0002 <span class="comment">%APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% ds.applyModifications returns the same kind of structure with</span>
0005 <span class="comment">% modifications applied. In all cases it first modifies the specification</span>
0006 <span class="comment">% (model.specification if input is a model structure). Then it returns</span>
0007 <span class="comment">% the modified specification or regenerates the model using the new</span>
0008 <span class="comment">% specification.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% Inputs:</span>
0011 <span class="comment">%   - model: DynaSim model or specification structure</span>
0012 <span class="comment">%     - see ds.checkModel and ds.checkSpecification for details</span>
0013 <span class="comment">%   - modifications: modifications to make to specification structure</span>
0014 <span class="comment">%       {X,Y,Z; X,Y,Z; ...}</span>
0015 <span class="comment">%       X = population name or connection source-&gt;target</span>
0016 <span class="comment">%       Y = thing to modify ('name', 'size', or parameter name)</span>
0017 <span class="comment">%       set Y=Z if Y = name, size, or value</span>
0018 <span class="comment">%       Note: (X1,X2) or (Y1,Y2): modify these simultaneously in the same way</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Outputs:</span>
0021 <span class="comment">%   - TODO</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% Examples:</span>
0024 <span class="comment">%   - modifying population size and parameters:</span>
0025 <span class="comment">%       modifications={'E','size',5; 'E','gNa',120};</span>
0026 <span class="comment">%       model=ds.applyModifications(model,modifications);</span>
0027 <span class="comment">%</span>
0028 <span class="comment">%   - modifying mechanism_list:</span>
0029 <span class="comment">%       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0030 <span class="comment">%                            {'pop1','mechanism_list','-iNa'});</span>
0031 <span class="comment">%       m.populations.mechanism_list</span>
0032 <span class="comment">%       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0033 <span class="comment">%                            {'pop1','mechanism_list','+iCa'});</span>
0034 <span class="comment">%       m.populations.mechanism_list</span>
0035 <span class="comment">%       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0036 <span class="comment">%                            {'pop1','mechanism_list','+(iCa,iCan,CaBuffer)'});</span>
0037 <span class="comment">%       m.populations.mechanism_list</span>
0038 <span class="comment">%</span>
0039 <span class="comment">%   - modifying equations (using special &quot;cat()&quot; operator or direct substitution)</span>
0040 <span class="comment">%       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0041 <span class="comment">%                            {'pop1','equations','cat(dv/dt,+I)'});</span>
0042 <span class="comment">%       m.populations.equations</span>
0043 <span class="comment">%       m=ds.applyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...</span>
0044 <span class="comment">%                            {'pop1','equations','cat(I(t),+sin(2*pi*t))'});</span>
0045 <span class="comment">%       m.populations.equations</span>
0046 <span class="comment">%       m=ds.applyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...</span>
0047 <span class="comment">%                            {'pop1','equations','dv/dt=10+@current'});</span>
0048 <span class="comment">%       m.populations.equations</span>
0049 <span class="comment">%       m.populations.mechanism_list</span>
0050 <span class="comment">%</span>
0051 <span class="comment">%   - modifying equations with reserved keywords &quot;ODEn&quot; and &quot;FUNCTIONn&quot;</span>
0052 <span class="comment">%     - Note:</span>
0053 <span class="comment">%       'ODEn' = reserved keyword referencing the n-th ODE in equations</span>
0054 <span class="comment">%       'ODE' = aliases ODE1</span>
0055 <span class="comment">%       similarly: 'FUNCTIONn' and 'FUNCTION'</span>
0056 <span class="comment">%</span>
0057 <span class="comment">%       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0058 <span class="comment">%                            {'pop1','equations','cat(ODE,+I)'});</span>
0059 <span class="comment">%       m.populations.equations</span>
0060 <span class="comment">%       m=ds.applyModifications('dv/dt=10+@current; du/dt=-u; {iNa,iK}',...</span>
0061 <span class="comment">%                            {'pop1','equations','cat(ODE2,+I)'});</span>
0062 <span class="comment">%       m.populations.equations</span>
0063 <span class="comment">%       m=ds.applyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...</span>
0064 <span class="comment">%                            {'pop1','equations','cat(FUNCTION,+sin(2*pi*t))'});</span>
0065 <span class="comment">%       m.populations.equations</span>
0066 <span class="comment">%</span>
0067 <span class="comment">% See also: ds.generateModel, ds.simulateModel, ds.vary2Modifications</span>
0068 
0069 <span class="comment">% check for modifications</span>
0070 <span class="keyword">if</span> isempty(modifications)
0071   <span class="comment">% nothing to do</span>
0072   output=model;
0073   <span class="keyword">return</span>;
0074 <span class="keyword">end</span>
0075 
0076 <span class="comment">% check input type</span>
0077 <span class="keyword">if</span> ~isfield(model,<span class="string">'state_variables'</span>)
0078   ismodel=0;
0079 <span class="keyword">else</span>
0080   ismodel=1;
0081 <span class="keyword">end</span>
0082 
0083 <span class="comment">% check specification</span>
0084 <span class="keyword">if</span> ismodel
0085   specification=<a href="ds.checkSpecification.html" class="code" title="function spec=ds.checkSpecification(specification)">ds.checkSpecification</a>(model.specification);
0086 <span class="keyword">else</span>
0087   specification=<a href="ds.checkSpecification.html" class="code" title="function spec=ds.checkSpecification(specification)">ds.checkSpecification</a>(model);
0088 <span class="keyword">end</span>
0089 
0090 <span class="comment">% update specification with whatever is in modifications</span>
0091 modifications = <a href="#_sub1" class="code" title="subfunction modifications=standardize_modifications(modifications,specification)">standardize_modifications</a>(modifications,specification);
0092 <span class="keyword">if</span> ismodel <span class="comment">% TODO: test this</span>
0093   specification = <a href="#_sub2" class="code" title="subfunction spec=modify_specification(spec,mods)">modify_specification</a>(specification,modifications);
0094 <span class="keyword">end</span>
0095 
0096 <span class="comment">% update model if input was a model structure</span>
0097 <span class="keyword">if</span> ismodel
0098   output=<a href="ds.generateModel.html" class="code" title="function [model,name_map]=ds.generateModel(specification,varargin)">ds.generateModel</a>(specification);
0099 <span class="keyword">else</span>
0100   output=specification;
0101 <span class="keyword">end</span>
0102 
0103 <a name="_sub1" href="#_subfunctions" class="code">function modifications=standardize_modifications(modifications,specification)</a>
0104 <span class="comment">% convert all modifications into 3-column cell matrix format</span>
0105 <span class="comment">% (namespace,variable,value)</span>
0106 
0107 <span class="comment">% 1. modifications structure</span>
0108 <span class="comment">% 2. partial specification structure</span>
0109 
0110 <span class="keyword">if</span> isstruct(modifications)
0111   <span class="comment">% TODO</span>
0112   <span class="comment">% convert structure to cell matrix</span>
0113   <span class="comment">% ...</span>
0114 <span class="keyword">end</span>
0115 
0116 <span class="comment">% check backward compatibility</span>
0117 modifications=<a href="#_sub3" class="code" title="subfunction modifications=backward_compatibility(modifications)">backward_compatibility</a>(modifications);
0118 
0119 <span class="comment">% check for empty object specification</span>
0120 missing_objects=find(cellfun(@isempty,modifications(:,1)));
0121 <span class="keyword">if</span> any(missing_objects)
0122   <span class="comment">% set to default population name</span>
0123   <span class="keyword">for</span> i=1:length(missing_objects)
0124     modifications{missing_objects(i),1}=specification.populations(1).name;<span class="comment">%'pop1';</span>
0125   <span class="keyword">end</span>
0126 <span class="keyword">end</span>
0127 
0128 <span class="comment">% support modifying multiple elements (of namespace or variable) simultaneously</span>
0129 <span class="comment">% approach -- add extra entry for each thing to modify</span>
0130 <span class="comment">% eg) expand {'(E,I)','Cm',2} to {'E','Cm',2; 'I','Cm',2}</span>
0131 <span class="comment">% note: should be able to support {'(E,I)','(EK,EK2)',-80}</span>
0132 <span class="keyword">if</span> any(~cellfun(@isempty,regexp(modifications(:,1),<span class="string">'^\(.*\)$'</span>))) || <span class="keyword">...</span>
0133    any(~cellfun(@isempty,regexp(modifications(:,2),<span class="string">'^\(.*\)$'</span>)))
0134  
0135   <span class="comment">% loop over modifications</span>
0136   modifications_={};
0137   <span class="keyword">for</span> i=1:size(modifications,1)
0138     <span class="comment">% check namespace for ()</span>
0139     namespaces=regexp(modifications{i,1},<span class="string">'[\w\.\-&lt;&gt;]+'</span>,<span class="string">'match'</span>);
0140     
0141     <span class="comment">% check variable for ()</span>
0142     variables=regexp(modifications{i,2},<span class="string">'[\w\.-]+'</span>,<span class="string">'match'</span>);
0143     
0144     <span class="comment">% check size of values matches number of namespaces, variables</span>
0145     <span class="keyword">if</span> isscalar(modifications{i,3}) <span class="comment">% in case number of values is one</span>
0146         modifications{i,3} = repmat(modifications{i,3},length(variables),length(namespaces));
0147     <span class="keyword">elseif</span> size(modifications{i,3},1) ~= length(variables) || size(modifications{i,3},2) ~= length(namespaces) 
0148         <span class="comment">% in case values is number of variables x 1</span>
0149         <span class="keyword">if</span> size(modifications{i,3},1) == length(variables) &amp;&amp; size(modifications{i,3},2) == 1
0150             modifications{i,3} = repmat(modifications{i,3},1,length(namespaces));
0151         <span class="comment">% in case values is 1 x number of namespaces</span>
0152         <span class="keyword">elseif</span> size(modifications{i,3},2) == length(namespaces) &amp;&amp; size(modifications{i,3},1) == 1
0153             modifications{i,3} = repmat(modifications{i,3},length(variables),1);
0154         <span class="comment">% TODO: char inputs</span>
0155         <span class="comment">% elseif ischar(modifications{i,3})</span>
0156           <span class="comment">% string input</span>
0157         <span class="keyword">else</span>
0158             error([<span class="string">'Numerical values varied over must be in array format,'</span>,<span class="keyword">...</span>
0159                 <span class="string">'where dimensions 1, 2, and 3 correspond to mechanisms, values, and populations varied over.'</span>])
0160         <span class="keyword">end</span>
0161     <span class="keyword">end</span>
0162     
0163     <span class="comment">% expand list of modifications</span>
0164     <span class="keyword">for</span> j=1:length(namespaces)
0165       <span class="keyword">for</span> k=1:length(variables)
0166         modifications_(end+1,1:3)={namespaces{j},variables{k},modifications{i,3}(k,j)};
0167       <span class="keyword">end</span>
0168     <span class="keyword">end</span>
0169   <span class="keyword">end</span>
0170   modifications=modifications_;
0171 <span class="keyword">end</span>
0172 
0173 <a name="_sub2" href="#_subfunctions" class="code">function spec=modify_specification(spec,mods)</a>
0174 precision=8; <span class="comment">% number of digits allowed for user-supplied values</span>
0175 predefined_variables={<span class="string">'name'</span>,<span class="string">'size'</span>,<span class="string">'parameters'</span>,<span class="string">'mechanism_list'</span>,<span class="string">'equations'</span>};
0176 pop_names={spec.populations.name};
0177 <span class="keyword">if</span> ~isempty(spec.connections)
0178   con_names=arrayfun(@(x)[x.source <span class="string">'-&gt;'</span> x.target],spec.connections,<span class="string">'uni'</span>,0);
0179 <span class="keyword">else</span>
0180   con_names=[];
0181 <span class="keyword">end</span>
0182 
0183 <span class="comment">% loop over modifications to apply</span>
0184 <span class="keyword">for</span> i=1:size(mods,1)
0185   obj=mods{i,1}; <span class="comment">% population name or connection source-target</span>
0186   fld=mods{i,2}; <span class="comment">% population name, size, or parameter name</span>
0187   
0188   <span class="keyword">if</span> ~ischar(obj)
0189     error(<span class="string">'modification must be applied to population name or connection source-target'</span>);
0190   <span class="keyword">end</span>
0191   
0192   <span class="keyword">if</span> ~ischar(fld) <span class="comment">%|| ~ismember(fld,{'name','size','parameters','mechanism_list','equations'})</span>
0193     error(<span class="string">'modification must be applied to population ''name'',''size'',or a parameter referenced by its name'</span>);
0194   <span class="keyword">end</span>
0195   
0196   <span class="comment">% standardize connection object: convert target&lt;-source to source-&gt;target</span>
0197   <span class="keyword">if</span> any(strfind(obj,<span class="string">'&lt;-'</span>))
0198     ind=strfind(obj,<span class="string">'&lt;-'</span>);
0199     obj=[obj(ind(1)+2:end) <span class="string">'-&gt;'</span> obj(1:ind(1)-1)];
0200   <span class="keyword">end</span>
0201   
0202   val=mods{i,3}; <span class="comment">% value for population name or size, or parameter to modify</span>
0203   <span class="keyword">if</span> ismember(obj,pop_names)
0204     type=<span class="string">'populations'</span>;
0205     names=pop_names;
0206   <span class="keyword">elseif</span> ismember(obj,con_names)
0207     type=<span class="string">'connections'</span>;
0208     names=con_names;
0209   <span class="keyword">else</span>
0210     warning(<span class="string">'name of object to modify not found in populations or connections.'</span>);
0211     <span class="keyword">continue</span>
0212   <span class="keyword">end</span>
0213   
0214   index=ismember(names,obj);
0215   
0216   <span class="keyword">if</span> strcmp(fld,<span class="string">'mechanism_list'</span>)
0217     <span class="comment">% support --</span>
0218     <span class="comment">% 'E'    'mechanism_list'    '(iNa,iK)'</span>
0219     <span class="comment">% 'E'    'mechanism_list'    '-(iNa,iK)'</span>
0220     <span class="comment">% 'E'    'mechanism_list'    '+(iK)'</span>
0221     <span class="comment">% 'E'    'mechanism_list'    '+iK'</span>
0222     <span class="comment">% 'E'    'mechanism_list'    'iK'</span>
0223     
0224     elems=regexp(val,<span class="string">'[\w@]+'</span>,<span class="string">'match'</span>);
0225     
0226     <span class="keyword">if</span> strcmp(val(1),<span class="string">'+'</span>)
0227       <span class="comment">% add mechanisms to existing list</span>
0228       spec.(type)(index).mechanism_list=unique(cat(2,spec.(type)(index).mechanism_list,elems),<span class="string">'stable'</span>);
0229     <span class="keyword">elseif</span> strcmp(val(1),<span class="string">'-'</span>)
0230       <span class="comment">% remove mechanisms from existing list</span>
0231       spec.(type)(index).mechanism_list=setdiff(spec.(type)(index).mechanism_list,elems,<span class="string">'stable'</span>);
0232     <span class="keyword">else</span>
0233       <span class="comment">% redefine mechanism list</span>
0234       spec.(type)(index).mechanism_list=elems;
0235     <span class="keyword">end</span>
0236   <span class="keyword">elseif</span> strcmp(fld,<span class="string">'equations'</span>) &amp;&amp; ~isempty(regexp(val,<span class="string">'^cat('</span>,<span class="string">'once'</span>))
0237     <span class="comment">% process special case: cat(TARGET,EXPRESSION)</span>
0238     eqns=spec.(type)(index).equations;
0239     args=regexp(val,<span class="string">'cat\((.+)\)'</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0240     ind=find(args{1}==<span class="string">','</span>,1,<span class="string">'first'</span>);
0241     target=args{1}(1:ind-1);
0242     expression=args{1}(ind+1:end);
0243 <span class="comment">%     args=regexp(args{1},',','split');</span>
0244 <span class="comment">%     target=args{1};</span>
0245 <span class="comment">%     expression=args{2};</span>
0246     <span class="comment">% support keywords: ODEn, ODE=ODE1, FUNCTIONn, FUNCTION=FUNCTION1</span>
0247     <span class="keyword">if</span> strncmp(<span class="string">'ODE'</span>,target,3)
0248       <span class="comment">% support target = ODEn and ODE=ODE1</span>
0249       <span class="comment">% replace target by n-th ODE LHS</span>
0250       lines=cellfun(@strtrim,strsplit(eqns,<span class="string">';'</span>),<span class="string">'uni'</span>,0); <span class="comment">% split equations into statements</span>
0251       lines=lines(~cellfun(@isempty,lines)); <span class="comment">% eliminate empty elements</span>
0252       pattern=<span class="string">'^((\w+'')|(d\w+/dt))\s*='</span>; <span class="comment">% pattern for ODEs</span>
0253       inds=regexp(lines,pattern,<span class="string">'once'</span>); <span class="comment">% indices to ODE statements</span>
0254       inds=find(~cellfun(@isempty,inds));
0255       <span class="comment">% get index to the ODE statement to modify</span>
0256       <span class="keyword">if</span> strcmp(target,<span class="string">'ODE'</span>)
0257         ind=inds(1);
0258       <span class="keyword">else</span>
0259         n=str2num(target(4:end));
0260         ind=inds(n);
0261       <span class="keyword">end</span>
0262       <span class="comment">% get LHS of ODE</span>
0263       <span class="comment">%LHS=regexp(lines{ind},'^(.+)=','tokens','once');</span>
0264       LHS=regexp(lines{ind},<span class="string">'^([^=]+)='</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0265       target=LHS{1};
0266     <span class="keyword">elseif</span> strncmp(<span class="string">'FUNCTION'</span>,target,8)
0267       <span class="comment">% support target = FUNCTIONn and FUNCTION=FUNCTION1</span>
0268       <span class="comment">% replace target by n-th FUNCTION LHS</span>
0269       lines=cellfun(@strtrim,strsplit(eqns,<span class="string">';'</span>),<span class="string">'uni'</span>,0); <span class="comment">% split equations into statements</span>
0270       lines=lines(~cellfun(@isempty,lines)); <span class="comment">% eliminate empty elements</span>
0271       pattern=<span class="string">'^\w+\([a-zA-Z][\w,]*\)\s*='</span>; <span class="comment">% pattern for functions</span>
0272       inds=regexp(lines,pattern,<span class="string">'once'</span>); <span class="comment">% indices to function statements</span>
0273       inds=find(~cellfun(@isempty,inds));
0274       
0275       <span class="comment">% get index to the function statement to modify</span>
0276       <span class="keyword">if</span> strcmp(target,<span class="string">'FUNCTION'</span>)
0277         ind=inds(1);
0278       <span class="keyword">else</span>
0279         n=str2num(target(9:end));
0280         ind=inds(n);
0281       <span class="keyword">end</span>
0282       <span class="comment">% get LHS of ODE</span>
0283       <span class="comment">%LHS=regexp(lines{ind},'^(.+)=','tokens','once');</span>
0284       LHS=regexp(lines{ind},<span class="string">'^([^=]+)='</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0285       target=LHS{1};
0286     <span class="keyword">end</span>
0287     <span class="comment">% add escape character for using regular expression to match function statements</span>
0288     target=strrep(target,<span class="string">'('</span>,<span class="string">'\('</span>);
0289     target=strrep(target,<span class="string">')'</span>,<span class="string">'\)'</span>);
0290     
0291     <span class="comment">% modify equations</span>
0292     old=regexp(eqns,[target <span class="string">'\s*=[^;]+'</span>],<span class="string">'match'</span>);
0293     <span class="keyword">if</span> ~isempty(old)
0294       eqns=strrep(eqns,old{1},[old{1} expression]);
0295       spec.(type)(index).equations=eqns;
0296     <span class="keyword">end</span>
0297   <span class="keyword">elseif</span> ismember(fld,predefined_variables) <span class="comment">% not a single parameter to modify</span>
0298     spec.(type)(index).(fld)=val;
0299     <span class="keyword">if</span> strcmp(type,<span class="string">'populations'</span>) &amp;&amp; strcmp(fld,<span class="string">'name'</span>)
0300       <span class="comment">% update name in connections</span>
0301       <span class="keyword">for</span> j=1:length(spec.connections)
0302         <span class="keyword">if</span> strcmp(pop_names{index},spec.connections(j).source)
0303           spec.connections(j).source=val;
0304         <span class="keyword">end</span>
0305         
0306         <span class="keyword">if</span> strcmp(pop_names{index},spec.connections(j).target)
0307           spec.connections(j).target=val;
0308         <span class="keyword">end</span>
0309       <span class="keyword">end</span>
0310     <span class="keyword">end</span>
0311   <span class="keyword">else</span> <span class="comment">% modify a single parameter in the populations.parameters cell array</span>
0312     param_names=spec.(type)(index).parameters(1:2:end);
0313     <span class="keyword">if</span> isempty(spec.(type)(index).parameters)
0314       <span class="comment">% no parameters set; start cell array of parameters</span>
0315       spec.(type)(index).parameters={fld,val};<span class="comment">%toString(val2,precision)};</span>
0316     <span class="keyword">elseif</span> ismember(fld,param_names)
0317       <span class="comment">% parameter found in list; update its value</span>
0318       val_pos=2*find(ismember(param_names,fld));
0319       spec.(type)(index).parameters{val_pos}=val;<span class="comment">%toString(val2,precision);</span>
0320     <span class="keyword">else</span>
0321       <span class="comment">% parameter not in existing list; append to end</span>
0322       spec.(type)(index).parameters{end+1}=fld;
0323       spec.(type)(index).parameters{end+1}=val;<span class="comment">%toString(val2,precision);</span>
0324     <span class="keyword">end</span>
0325   <span class="keyword">end</span>
0326 <span class="keyword">end</span>
0327 
0328 <a name="_sub3" href="#_subfunctions" class="code">function modifications=backward_compatibility(modifications)</a>
0329 <span class="comment">% convert 2-column specification to 3-column specification with empty object name</span>
0330 <span class="keyword">if</span> size(modifications,2)==2
0331   tmp={};
0332   <span class="keyword">for</span> i=1:size(modifications,1)
0333     tmp{i,1}=<span class="string">''</span>;
0334     tmp{i,2}=modifications{i,1};
0335     tmp{i,3}=modifications{i,2};
0336   <span class="keyword">end</span>
0337   modifications=tmp;
0338 <span class="keyword">end</span>
0339 
0340 <span class="comment">% convert 4-column specification to 3-column</span>
0341 <span class="keyword">if</span> size(modifications,2)==4
0342   <span class="keyword">for</span> i=1:size(modifications,1)
0343     <span class="keyword">if</span> strcmp(modifications{i,2},<span class="string">'parameters'</span>)
0344       <span class="comment">% shift parameter name to 2nd column</span>
0345       modifications{i,2}=modifications{i,3};
0346       
0347       <span class="comment">% shift parameter value to 3rd column</span>
0348       modifications{i,3}=modifications{i,4};
0349     <span class="keyword">end</span>
0350   <span class="keyword">end</span>
0351   
0352   <span class="comment">% remove fourth column</span>
0353   modifications=modifications(:,1:3);
0354 <span class="keyword">end</span>
0355 
0356 <span class="comment">% convert connection reference source-target to source-&gt;target</span>
0357 <span class="keyword">if</span> any(~cellfun(@isempty,regexp(modifications(:,1),<span class="string">'\w-\w'</span>)))
0358   <span class="comment">% find elements to adjust</span>
0359   inds=find(~cellfun(@isempty,regexp(modifications(:,1),<span class="string">'\w-\w'</span>)));
0360   <span class="keyword">for</span> i=1:length(inds)
0361     modifications{inds(i),1}=strrep(modifications{inds(i),1},<span class="string">'-'</span>,<span class="string">'-&gt;'</span>);
0362   <span class="keyword">end</span>
0363 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 07-Apr-2017 20:01:20 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>