<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ds.importData</title>
  <meta name="keywords" content="ds.importData">
  <meta name="description" content="IMPORTDATA - load data into DynaSim formatted data structure.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html functions -->
<h1>ds.importData
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>IMPORTDATA - load data into DynaSim formatted data structure.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [data,studyinfo] = ds.importData(file,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">IMPORTDATA - load data into DynaSim formatted data structure.

 Usage:
   [data,studyinfo]=ds.importData(data_file)
   data=ds.importData(data_file)

 Inputs:
   - data_file data file name in accepted format (csv, mat, ...), or also
     accepted: list of data files, studyinfo structure, study_dir, or studyinfo
     file
   - studyinfo: DynaSim studyinfo structure (see ds.checkStudyinfo)
   - options:
     'verbose_flag': {0,1} (default: 1)
     'process_id'  : process identifier for loading studyinfo if necessary
     'time_limits' : [beg,end] ms (see NOTE 2)
     'variables'   : cell array of matrix names (see NOTE 2)
     'simIDs'      : array of simIDs to import (default: [])

 Outputs:
   - DynaSim data structure:
     data.labels           : list of state variables and monitors recorded
     data.(state_variables): state variable data matrix [time x cells]
     data.(monitors)       : monitor data matrix [time x cells]
     data.time             : time vector [time x 1]
     data.simulator_options: simulator options used to generate simulated data
     data.model            : model used to generate simulated data
     [data.varied]         : list of varied model components
     [data.results]        : list of derived data sets created by post-processing

 Notes:
   - NOTE 1: CSV file structure assumes CSV file contains data organized
   according to output from ds.writeDynaSimSolver: time points along rows; state
   variables and monitors are columns; first column is time vector; next
   columns are state variables; final columns are monitors. first row has
   headers for each column. if a population has more than one cell, different
   cells are sequential columns with same header repeated for each cell.

   - NOTE 2: DynaSim data exported to MAT-files are HDF-compatible. To obtain
   partial data sets without having to load the entire file, use ds.importData
   with options 'time_limits' and/or 'variables'. Alternatively, the entire
   data set can be loaded using ds.importData with default options, then subsets
   extracted using ds.selectData with appropriate options.

 Examples:
   - Example 1: full data set
       data=ds.importData('data.mat'); % load single data set
       data=ds.importData(studyinfo); % load all data sets in studyinfo.study_dir
   - Example 2: partial data set with HDF-style loading
       data=ds.importData('data.mat','variables','pop1_v','time_limits',[1000 4000])

 TODO:
 - specify subsets to return in terms of varied parameters, time_limits, ROIs,
   etc possible format for specifying range_varied: {'E','gNa',[.1 .3];
   'I-&gt;E','tauI',[15 25]; 'I','mechanism_list','+iM'}
 - achieve by calling function ds.selectData() at end of this function.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="ds.checkOptions.html" class="code" title="function [parms, params_unspecified ] = ds.checkOptions(options, options_schema, strict)">ds.checkOptions</a>	CHECKOPTIONS - organize key/value pairs in structure with default or user-supplied values according to a schema</li><li><a href="ds.checkStudyinfo.html" class="code" title="function studyinfo=ds.checkStudyinfo(studyinfo,varargin)">ds.checkStudyinfo</a>	CHECKSTUDYINFO - Standardize studyinfo structure and auto-populate missing fields</li><li><a href="ds.importCSV.html" class="code" title="function data=ds.importCSV(file)">ds.importCSV</a>	IMPORTCSV - load CSV data into DynaSim formatted data structure.</li><li><a href="ds.importData.html" class="code" title="function [data,studyinfo] = ds.importData(file,varargin)">ds.importData</a>	IMPORTDATA - load data into DynaSim formatted data structure.</li><li><a href="ds.options2Keyval.html" class="code" title="function keyval = ds.options2Keyval(options)">ds.options2Keyval</a>	OPTIONS2KEYVAL - Convert from options structure to a list of key/value pairs.</li><li><a href="ds.selectData.html" class="code" title="function data=ds.selectData(data,varargin)">ds.selectData</a>	SELECTDATA -  select subset of data</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="ds.analyzeData.html" class="code" title="function result=ds.analyzeData(data,func,varargin)">ds.analyzeData</a>	ANALYZEDATA - Apply an analysis function to DynaSim data, optionally saving data</li><li><a href="AnalyzeStudy.html" class="code" title="function [results,studyinfo]=AnalyzeStudy(data,func,varargin)">AnalyzeStudy</a>	ANALYZESTUDY - Apply an analysis function to DynaSim data, optionally saving data</li><li><a href="ds.importData.html" class="code" title="function [data,studyinfo] = ds.importData(file,varargin)">ds.importData</a>	IMPORTDATA - load data into DynaSim formatted data structure.</li><li><a href="ds.simulateModel.html" class="code" title="function [data,studyinfo]=ds.simulateModel(model,varargin)">ds.simulateModel</a>	% data=ds.simulateModel(model,'option',value,...)</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [data,studyinfo] = ds.importData(file,varargin)</a>
0002 <span class="comment">%IMPORTDATA - load data into DynaSim formatted data structure.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Usage:</span>
0005 <span class="comment">%   [data,studyinfo]=ds.importData(data_file)</span>
0006 <span class="comment">%   data=ds.importData(data_file)</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% Inputs:</span>
0009 <span class="comment">%   - data_file data file name in accepted format (csv, mat, ...), or also</span>
0010 <span class="comment">%     accepted: list of data files, studyinfo structure, study_dir, or studyinfo</span>
0011 <span class="comment">%     file</span>
0012 <span class="comment">%   - studyinfo: DynaSim studyinfo structure (see ds.checkStudyinfo)</span>
0013 <span class="comment">%   - options:</span>
0014 <span class="comment">%     'verbose_flag': {0,1} (default: 1)</span>
0015 <span class="comment">%     'process_id'  : process identifier for loading studyinfo if necessary</span>
0016 <span class="comment">%     'time_limits' : [beg,end] ms (see NOTE 2)</span>
0017 <span class="comment">%     'variables'   : cell array of matrix names (see NOTE 2)</span>
0018 <span class="comment">%     'simIDs'      : array of simIDs to import (default: [])</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Outputs:</span>
0021 <span class="comment">%   - DynaSim data structure:</span>
0022 <span class="comment">%     data.labels           : list of state variables and monitors recorded</span>
0023 <span class="comment">%     data.(state_variables): state variable data matrix [time x cells]</span>
0024 <span class="comment">%     data.(monitors)       : monitor data matrix [time x cells]</span>
0025 <span class="comment">%     data.time             : time vector [time x 1]</span>
0026 <span class="comment">%     data.simulator_options: simulator options used to generate simulated data</span>
0027 <span class="comment">%     data.model            : model used to generate simulated data</span>
0028 <span class="comment">%     [data.varied]         : list of varied model components</span>
0029 <span class="comment">%     [data.results]        : list of derived data sets created by post-processing</span>
0030 <span class="comment">%</span>
0031 <span class="comment">% Notes:</span>
0032 <span class="comment">%   - NOTE 1: CSV file structure assumes CSV file contains data organized</span>
0033 <span class="comment">%   according to output from ds.writeDynaSimSolver: time points along rows; state</span>
0034 <span class="comment">%   variables and monitors are columns; first column is time vector; next</span>
0035 <span class="comment">%   columns are state variables; final columns are monitors. first row has</span>
0036 <span class="comment">%   headers for each column. if a population has more than one cell, different</span>
0037 <span class="comment">%   cells are sequential columns with same header repeated for each cell.</span>
0038 <span class="comment">%</span>
0039 <span class="comment">%   - NOTE 2: DynaSim data exported to MAT-files are HDF-compatible. To obtain</span>
0040 <span class="comment">%   partial data sets without having to load the entire file, use ds.importData</span>
0041 <span class="comment">%   with options 'time_limits' and/or 'variables'. Alternatively, the entire</span>
0042 <span class="comment">%   data set can be loaded using ds.importData with default options, then subsets</span>
0043 <span class="comment">%   extracted using ds.selectData with appropriate options.</span>
0044 <span class="comment">%</span>
0045 <span class="comment">% Examples:</span>
0046 <span class="comment">%   - Example 1: full data set</span>
0047 <span class="comment">%       data=ds.importData('data.mat'); % load single data set</span>
0048 <span class="comment">%       data=ds.importData(studyinfo); % load all data sets in studyinfo.study_dir</span>
0049 <span class="comment">%   - Example 2: partial data set with HDF-style loading</span>
0050 <span class="comment">%       data=ds.importData('data.mat','variables','pop1_v','time_limits',[1000 4000])</span>
0051 <span class="comment">%</span>
0052 <span class="comment">% TODO:</span>
0053 <span class="comment">% - specify subsets to return in terms of varied parameters, time_limits, ROIs,</span>
0054 <span class="comment">%   etc possible format for specifying range_varied: {'E','gNa',[.1 .3];</span>
0055 <span class="comment">%   'I-&gt;E','tauI',[15 25]; 'I','mechanism_list','+iM'}</span>
0056 <span class="comment">% - achieve by calling function ds.selectData() at end of this function.</span>
0057 
0058 <span class="comment">% See also: ds.simulateModel, ds.exportData, ds.checkData, ds.selectData</span>
0059 
0060 
0061 <span class="comment">% Check inputs</span>
0062 options=<a href="ds.checkOptions.html" class="code" title="function [parms, params_unspecified ] = ds.checkOptions(options, options_schema, strict)">ds.checkOptions</a>(varargin,{<span class="keyword">...</span>
0063   <span class="string">'verbose_flag'</span>,1,{0,1},<span class="keyword">...</span>
0064   <span class="string">'process_id'</span>,[],[],<span class="keyword">...</span><span class="comment"> % process identifier for loading studyinfo if necessary</span>
0065   <span class="string">'time_limits'</span>,[],[],<span class="keyword">...</span>
0066   <span class="string">'variables'</span>,[],[],<span class="keyword">...</span>
0067   <span class="string">'simIDs'</span>,[],[],<span class="keyword">...</span>
0068   },false);
0069 
0070 <span class="keyword">if</span> ischar(options.variables)
0071   options.variables = {options.variables};
0072 <span class="keyword">end</span>
0073 
0074 <span class="comment">% check if input is a DynaSim studyinfo structure</span>
0075 <span class="keyword">if</span> ischar(file) &amp;&amp; isdir(file) <span class="comment">% study directory</span>
0076   study_dir = file;
0077   clear file
0078   file.study_dir = study_dir;
0079 <span class="keyword">end</span>
0080 
0081 <span class="keyword">if</span> isstruct(file) &amp;&amp; isfield(file,<span class="string">'study_dir'</span>)
0082   <span class="comment">% &quot;file&quot; is a studyinfo structure.</span>
0083   <span class="comment">% retrieve most up-to-date studyinfo structure from studyinfo.mat file</span>
0084   studyinfo = <a href="ds.checkStudyinfo.html" class="code" title="function studyinfo=ds.checkStudyinfo(studyinfo,varargin)">ds.checkStudyinfo</a>(file.study_dir,<span class="string">'process_id'</span>,options.process_id);
0085   
0086   <span class="comment">% compare simIDs to sim_id</span>
0087   <span class="keyword">if</span> ~isempty(options.simIDs)
0088      [~,~,simsInds] = intersect(options.simIDs, [studyinfo.simulations.sim_id]);
0089   <span class="keyword">end</span>
0090   
0091   <span class="comment">% get list of data_files from studyinfo</span>
0092   <span class="keyword">if</span> isempty(options.simIDs)
0093     data_files = {studyinfo.simulations.data_file};
0094   <span class="keyword">else</span>
0095     data_files = {studyinfo.simulations(simsInds).data_file};
0096   <span class="keyword">end</span>
0097   success = cellfun(@exist,data_files)==2;
0098   
0099   <span class="keyword">if</span> ~all(success)
0100     <span class="comment">% convert original absolute paths to paths relative to study_dir</span>
0101     <span class="keyword">for</span> i = 1:length(data_files)
0102       [~,fname,fext] = fileparts(data_files{i});
0103       data_files{i} = fullfile(file.study_dir,<span class="string">'data'</span>,[fname fext]);
0104     <span class="keyword">end</span>
0105     
0106     success = cellfun(@exist,data_files)==2;
0107   <span class="keyword">end</span>
0108   
0109   data_files = data_files(success);
0110   sim_info = studyinfo.simulations(success);
0111   
0112   <span class="comment">% load each data set recursively</span>
0113   keyvals = <a href="ds.options2Keyval.html" class="code" title="function keyval = ds.options2Keyval(options)">ds.options2Keyval</a>(options);
0114   num_files = length(data_files);
0115   
0116   <span class="keyword">for</span> i = 1:num_files
0117     fprintf(<span class="string">'loading file %g/%g: %s\n'</span>,i,num_files,data_files{i});
0118     tmp_data=<a href="ds.importData.html" class="code" title="function [data,studyinfo] = ds.importData(file,varargin)">ds.importData</a>(data_files{i},keyvals{:});
0119     num_sets_per_file=length(tmp_data);
0120     <span class="keyword">if</span> ~isfield(tmp_data,<span class="string">'varied'</span>)
0121     <span class="comment">% add varied info</span>
0122       <span class="comment">% this is necessary here when loading .csv data lacking metadata</span>
0123       tmp_data.varied={};
0124       modifications=sim_info(i).modifications;
0125       modifications(:,1:2) = cellfun( @(x) strrep(x,<span class="string">'-&gt;'</span>,<span class="string">'_'</span>),modifications(:,1:2),<span class="string">'UniformOutput'</span>,0);
0126       
0127       <span class="keyword">for</span> j=1:size(modifications,1)
0128         varied=[modifications{j,1} <span class="string">'_'</span> modifications{j,2}];
0129         <span class="keyword">for</span> k=1:num_sets_per_file
0130           tmp_data(k).varied{end+1}=varied;
0131           tmp_data(k).(varied)=modifications{j,3};
0132         <span class="keyword">end</span>
0133       <span class="keyword">end</span>
0134     <span class="keyword">end</span>
0135     
0136     <span class="comment">% store this data</span>
0137     <span class="keyword">if</span> i==1
0138       total_num_sets=num_sets_per_file*num_files;
0139       set_indices=0:num_sets_per_file:total_num_sets-1;
0140       
0141       <span class="comment">% preallocate full data matrix based on first data file</span>
0142       data(1:total_num_sets)=tmp_data(1);
0143 <span class="comment">%       data(1:length(data_files))=tmp_data;</span>
0144 <span class="comment">%     else</span>
0145 <span class="comment">%       data(i)=tmp_data;</span>
0146     <span class="keyword">end</span>
0147     <span class="comment">% replace i-th set of data sets by these data sets</span>
0148     data(set_indices(i)+(1:num_sets_per_file))=tmp_data;
0149   <span class="keyword">end</span>
0150   
0151   <span class="keyword">return</span>;
0152 <span class="keyword">else</span>
0153   studyinfo=[];
0154 <span class="keyword">end</span>
0155 
0156 <span class="comment">% check if input is a list of data files (todo: eliminate duplicate code by</span>
0157 <span class="comment">% combining with the above recursive loading for studyinfo data_files)</span>
0158 <span class="keyword">if</span> iscellstr(file)
0159   data_files=file;
0160   success=cellfun(@exist,data_files)==2;
0161   data_files=data_files(success);
0162   keyvals=<a href="ds.options2Keyval.html" class="code" title="function keyval = ds.options2Keyval(options)">ds.options2Keyval</a>(options);
0163   
0164   <span class="comment">% load each data set recursively</span>
0165   <span class="keyword">for</span> i=1:length(data_files)
0166     tmp_data=<a href="ds.importData.html" class="code" title="function [data,studyinfo] = ds.importData(file,varargin)">ds.importData</a>(data_files{i},keyvals{:});
0167     <span class="comment">% store this data</span>
0168     <span class="keyword">if</span> i==1
0169       <span class="comment">% preallocate full data matrix based on first data file</span>
0170       data(1:length(data_files))=tmp_data;
0171     <span class="keyword">else</span>
0172       <span class="comment">% replace i-th data element by this data set</span>
0173       data(i)=tmp_data;
0174     <span class="keyword">end</span>
0175   <span class="keyword">end</span>
0176   <span class="keyword">return</span>;
0177 <span class="keyword">end</span>
0178 
0179 <span class="keyword">if</span> ischar(file)
0180   [~,~,ext]=fileparts(file);
0181   <span class="keyword">switch</span> lower(ext)
0182     <span class="keyword">case</span> <span class="string">'.mat'</span>
0183       <span class="comment">% MAT-file contains data fields as separate variables (-v7.3 for HDF)</span>
0184       <span class="keyword">if</span> isempty(options.time_limits) &amp;&amp; isempty(options.variables)
0185         <span class="comment">% load full data set</span>
0186         data=load(file);
0187         
0188         <span class="comment">% if file only contains a structure called 'data' then return that</span>
0189         <span class="keyword">if</span> isfield(data,<span class="string">'data'</span>) &amp;&amp; length(fieldnames(data))==1
0190           data=data.data;
0191         <span class="keyword">end</span>
0192       <span class="keyword">else</span>
0193         <span class="comment">% load partial data set</span>
0194         <span class="comment">% use matfile() to load HDF subsets given varargin options...</span>
0195         obj=matfile(file); <span class="comment">% MAT-file object</span>
0196         varlist=who(obj); <span class="comment">% variables stored in mat-file</span>
0197         labels=obj.labels; <span class="comment">% list of state variables and monitors</span>
0198         
0199         <span class="keyword">if</span> iscellstr(options.variables) <span class="comment">% restrict variables to load</span>
0200           labels=labels(ismember(labels,options.variables));
0201         <span class="keyword">end</span>
0202         
0203         simulator_options=obj.simulator_options;
0204         time=(simulator_options.tspan(1):simulator_options.dt:simulator_options.tspan(2))';
0205         time=time(1:simulator_options.downsample_factor:length(time));
0206         
0207         <span class="keyword">if</span> ~isempty(options.time_limits)
0208           <span class="comment">% determine time indices to load</span>
0209           time_indices=nearest(time,options.time_limits(1)):nearest(time,options.time_limits(2));
0210         <span class="keyword">else</span>
0211           <span class="comment">% load all time points</span>
0212           time_indices=1:length(time);
0213         <span class="keyword">end</span>
0214         
0215         <span class="comment">% create DynaSim data structure:</span>
0216         data=[];
0217         data.labels=labels;
0218         
0219         <span class="comment">% load state variables and monitors</span>
0220         <span class="keyword">for</span> i=1:length(labels)
0221           data.(labels{i})=obj.(labels{i})(time_indices,:);
0222         <span class="keyword">end</span>
0223         
0224         data.time=time(time_indices);
0225         data.simulator_options=simulator_options;
0226         
0227         <span class="keyword">if</span> ismember(<span class="string">'model'</span>,varlist)
0228           data.model=obj.model;
0229         <span class="keyword">end</span>
0230         
0231         <span class="keyword">if</span> ismember(<span class="string">'varied'</span>,varlist)
0232           varied=obj.varied;
0233           data.varied=varied;
0234           <span class="keyword">for</span> i=1:length(varied)
0235             data.(varied{i})=obj.(varied{i});
0236           <span class="keyword">end</span>
0237         <span class="keyword">end</span>
0238         
0239         <span class="keyword">if</span> ismember(<span class="string">'results'</span>,varlist)
0240           results=obj.results;
0241           <span class="keyword">if</span> iscellstr(options.variables)
0242             results=results(ismember(results,options.variables));
0243           <span class="keyword">end</span>
0244           data.results=results;
0245           
0246           <span class="comment">% load results</span>
0247           <span class="keyword">for</span> i=1:length(results)
0248             data.(results{i})=obj.(results{i})(time_indices,:);
0249           <span class="keyword">end</span>
0250         <span class="keyword">end</span>
0251       <span class="keyword">end</span>
0252     <span class="keyword">case</span> <span class="string">'.csv'</span>
0253       <span class="comment">% assumes CSV file contains data organized according to output from ds.writeDynaSimSolver:</span>
0254       data=<a href="ds.importCSV.html" class="code" title="function data=ds.importCSV(file)">ds.importCSV</a>(file);
0255       
0256       <span class="keyword">if</span> ~(isempty(options.time_limits) &amp;&amp; isempty(options.variables))
0257         <span class="comment">% limit to select subsets</span>
0258         data=<a href="ds.selectData.html" class="code" title="function data=ds.selectData(data,varargin)">ds.selectData</a>(data,varargin{:}); <span class="comment">% todo: create ds.selectData()</span>
0259       <span class="keyword">end</span>
0260     <span class="keyword">otherwise</span>
0261       error(<span class="string">'file type not recognized. ds.importData currently supports DynaSim data structure in MAT file, data values in CSV file.'</span>);
0262   <span class="keyword">end</span>
0263 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 07-Apr-2017 20:01:20 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>