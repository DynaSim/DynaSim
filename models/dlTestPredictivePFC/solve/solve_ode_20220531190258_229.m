function [T,supE_V,supE_iNa_m,supE_iNa_h,supE_iK_n,supI_V,supI_iNa_m,supI_iNa_h,supI_iK_n,midE_V,midE_iNa_m,midE_iNa_h,midE_iK_n,midI_V,midI_iNa_m,midI_iNa_h,midI_iK_n,deepE_V,deepE_iNa_m,deepE_iNa_h,deepE_iK_n,deepI_V,deepI_iNa_m,deepI_iNa_h,deepI_iK_n,IO_SA1_V,IO_SA1_iNa_m,IO_SA1_iNa_h,IO_SA1_iK_n,IO_SB1_V,IO_SB1_iNa_m,IO_SB1_iNa_h,IO_SB1_iK_n,IO_SC1_V,IO_SC1_iNa_m,IO_SC1_iNa_h,IO_SC1_iK_n,IO_SA2_V,IO_SA2_iNa_m,IO_SA2_iNa_h,IO_SA2_iK_n,IO_SB2_V,IO_SB2_iNa_m,IO_SB2_iNa_h,IO_SB2_iK_n,IO_SC2_V,IO_SC2_iNa_m,IO_SC2_iNa_h,IO_SC2_iK_n,IO_Cx1_V,IO_Cx1_iNa_m,IO_Cx1_iNa_h,IO_Cx1_iK_n,IO_Cx2_V,IO_Cx2_iNa_m,IO_Cx2_iNa_h,IO_Cx2_iK_n,supI_supE_iAMPActx_s,supE_supE_iAMPActx_s,supE_supI_iGABActx_s,supI_supI_iGABActx_s,midI_midE_iAMPActx_s,midE_midE_iAMPActx_s,midE_midI_iGABActx_s,midI_midI_iGABActx_s,deepI_deepE_iAMPActx_s,deepE_deepE_iAMPActx_s,deepE_deepI_iGABActx_s,deepI_deepI_iGABActx_s,midE_IO_SB1_iAMPActx_s,midE_IO_SB2_iAMPActx_s,midE_IO_SC1_iAMPActx_s,midE_IO_SC2_iAMPActx_s,midE_IO_Cx1_iAMPActx_s,midE_IO_Cx2_iAMPActx_s,supE_midE_iAMPActx_s,deepE_midE_iAMPActx_s,deepE_midI_iGABActx_s,deepE_supE_iAMPActx_s,supE_ctx_iPoisson_g_poisson,supE_ctx_iPoisson_I_poisson,supI_ctx_iPoisson_g_poisson,supI_ctx_iPoisson_I_poisson,midE_ctx_iPoisson_g_poisson,midE_ctx_iPoisson_I_poisson,midI_ctx_iPoisson_g_poisson,midI_ctx_iPoisson_I_poisson,deepE_ctx_iPoisson_g_poisson,deepE_ctx_iPoisson_I_poisson,deepI_ctx_iPoisson_g_poisson,deepI_ctx_iPoisson_I_poisson,IO_SA1_ctx_iPoisson_g_poisson,IO_SA1_ctx_iPoisson_I_poisson,IO_SB1_ctx_iPoisson_g_poisson,IO_SB1_ctx_iPoisson_I_poisson,IO_SC1_ctx_iPoisson_g_poisson,IO_SC1_ctx_iPoisson_I_poisson,IO_SA2_ctx_iPoisson_g_poisson,IO_SA2_ctx_iPoisson_I_poisson,IO_SB2_ctx_iPoisson_g_poisson,IO_SB2_ctx_iPoisson_I_poisson,IO_SC2_ctx_iPoisson_g_poisson,IO_SC2_ctx_iPoisson_I_poisson,IO_Cx1_ctx_iPoisson_g_poisson,IO_Cx1_ctx_iPoisson_I_poisson,IO_Cx2_ctx_iPoisson_g_poisson,IO_Cx2_ctx_iPoisson_I_poisson,IO_SB1_IO_SA1_iPoisson_gPoisson,IO_SA1_IO_SA1_iPoisson_gPoisson,IO_SA1_IO_SB1_iPoisson_gPoisson,IO_SB1_IO_SB1_iPoisson_gPoisson,IO_SA2_IO_SC1_iPoisson_gPoisson,IO_SC1_IO_SC1_iPoisson_gPoisson,IO_SC1_IO_SA2_iPoisson_gPoisson,IO_SA2_IO_SA2_iPoisson_gPoisson,IO_SC2_IO_SB2_iPoisson_gPoisson,IO_SB2_IO_SB2_iPoisson_gPoisson,IO_SB2_IO_SC2_iPoisson_gPoisson,IO_SC2_IO_SC2_iPoisson_gPoisson,IO_Cx2_IO_Cx1_iPoisson_gPoisson,IO_Cx1_IO_Cx1_iPoisson_gPoisson,IO_Cx1_IO_Cx2_iPoisson_gPoisson,IO_Cx2_IO_Cx2_iPoisson_gPoisson,midE_IO_SA1_iPoisson_gPoisson,midE_IO_SA2_iPoisson_gPoisson,supE_ctx_iPoisson_s_poisson,supI_ctx_iPoisson_s_poisson,midE_ctx_iPoisson_s_poisson,midI_ctx_iPoisson_s_poisson,deepE_ctx_iPoisson_s_poisson,deepI_ctx_iPoisson_s_poisson,IO_SA1_ctx_iPoisson_s_poisson,IO_SB1_ctx_iPoisson_s_poisson,IO_SC1_ctx_iPoisson_s_poisson,IO_SA2_ctx_iPoisson_s_poisson,IO_SB2_ctx_iPoisson_s_poisson,IO_SC2_ctx_iPoisson_s_poisson,IO_Cx1_ctx_iPoisson_s_poisson,IO_Cx2_ctx_iPoisson_s_poisson,IO_SB1_IO_SA1_iPoisson_s,IO_SA1_IO_SA1_iPoisson_s,IO_SA1_IO_SB1_iPoisson_s,IO_SB1_IO_SB1_iPoisson_s,IO_SA2_IO_SC1_iPoisson_s,IO_SC1_IO_SC1_iPoisson_s,IO_SC1_IO_SA2_iPoisson_s,IO_SA2_IO_SA2_iPoisson_s,IO_SC2_IO_SB2_iPoisson_s,IO_SB2_IO_SB2_iPoisson_s,IO_SB2_IO_SC2_iPoisson_s,IO_SC2_IO_SC2_iPoisson_s,IO_Cx2_IO_Cx1_iPoisson_s,IO_Cx1_IO_Cx1_iPoisson_s,IO_Cx1_IO_Cx2_iPoisson_s,IO_Cx2_IO_Cx2_iPoisson_s,midE_IO_SA1_iPoisson_s,midE_IO_SA2_iPoisson_s]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% the 'shuffle' random seed has been set in advance.

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
supE_ctx_iPoisson_s_poisson = getPoissonDutyCycleGating(p.supE_ctx_iPoisson_onset_poisson,p.supE_ctx_iPoisson_offset_poisson,p.supE_ctx_iPoisson_latency_poisson,p.supE_ctx_iPoisson_f_poisson,p.supE_ctx_iPoisson_fsigma_poisson,p.supE_ctx_iPoisson_phi_poisson,p.supE_ctx_iPoisson_connsigma_poisson,p.supE_ctx_iPoisson_baseline_poisson,p.supE_ctx_iPoisson_DC_poisson,p.supE_ctx_iPoisson_AC_poisson,p.supE_ctx_iPoisson_slopedutycycle_poisson,p.supE_ctx_iPoisson_thresholddutycycle_poisson,p.supE_ctx_iPoisson_tau_poisson,p.supE_ctx_iPoisson_kick_poisson,T,p.supE_Npop);
supI_ctx_iPoisson_s_poisson = getPoissonDutyCycleGating(p.supI_ctx_iPoisson_onset_poisson,p.supI_ctx_iPoisson_offset_poisson,p.supI_ctx_iPoisson_latency_poisson,p.supI_ctx_iPoisson_f_poisson,p.supI_ctx_iPoisson_fsigma_poisson,p.supI_ctx_iPoisson_phi_poisson,p.supI_ctx_iPoisson_connsigma_poisson,p.supI_ctx_iPoisson_baseline_poisson,p.supI_ctx_iPoisson_DC_poisson,p.supI_ctx_iPoisson_AC_poisson,p.supI_ctx_iPoisson_slopedutycycle_poisson,p.supI_ctx_iPoisson_thresholddutycycle_poisson,p.supI_ctx_iPoisson_tau_poisson,p.supI_ctx_iPoisson_kick_poisson,T,p.supI_Npop);
midE_ctx_iPoisson_s_poisson = getPoissonDutyCycleGating(p.midE_ctx_iPoisson_onset_poisson,p.midE_ctx_iPoisson_offset_poisson,p.midE_ctx_iPoisson_latency_poisson,p.midE_ctx_iPoisson_f_poisson,p.midE_ctx_iPoisson_fsigma_poisson,p.midE_ctx_iPoisson_phi_poisson,p.midE_ctx_iPoisson_connsigma_poisson,p.midE_ctx_iPoisson_baseline_poisson,p.midE_ctx_iPoisson_DC_poisson,p.midE_ctx_iPoisson_AC_poisson,p.midE_ctx_iPoisson_slopedutycycle_poisson,p.midE_ctx_iPoisson_thresholddutycycle_poisson,p.midE_ctx_iPoisson_tau_poisson,p.midE_ctx_iPoisson_kick_poisson,T,p.midE_Npop);
midI_ctx_iPoisson_s_poisson = getPoissonDutyCycleGating(p.midI_ctx_iPoisson_onset_poisson,p.midI_ctx_iPoisson_offset_poisson,p.midI_ctx_iPoisson_latency_poisson,p.midI_ctx_iPoisson_f_poisson,p.midI_ctx_iPoisson_fsigma_poisson,p.midI_ctx_iPoisson_phi_poisson,p.midI_ctx_iPoisson_connsigma_poisson,p.midI_ctx_iPoisson_baseline_poisson,p.midI_ctx_iPoisson_DC_poisson,p.midI_ctx_iPoisson_AC_poisson,p.midI_ctx_iPoisson_slopedutycycle_poisson,p.midI_ctx_iPoisson_thresholddutycycle_poisson,p.midI_ctx_iPoisson_tau_poisson,p.midI_ctx_iPoisson_kick_poisson,T,p.midI_Npop);
deepE_ctx_iPoisson_s_poisson = getPoissonDutyCycleGating(p.deepE_ctx_iPoisson_onset_poisson,p.deepE_ctx_iPoisson_offset_poisson,p.deepE_ctx_iPoisson_latency_poisson,p.deepE_ctx_iPoisson_f_poisson,p.deepE_ctx_iPoisson_fsigma_poisson,p.deepE_ctx_iPoisson_phi_poisson,p.deepE_ctx_iPoisson_connsigma_poisson,p.deepE_ctx_iPoisson_baseline_poisson,p.deepE_ctx_iPoisson_DC_poisson,p.deepE_ctx_iPoisson_AC_poisson,p.deepE_ctx_iPoisson_slopedutycycle_poisson,p.deepE_ctx_iPoisson_thresholddutycycle_poisson,p.deepE_ctx_iPoisson_tau_poisson,p.deepE_ctx_iPoisson_kick_poisson,T,p.deepE_Npop);
deepI_ctx_iPoisson_s_poisson = getPoissonDutyCycleGating(p.deepI_ctx_iPoisson_onset_poisson,p.deepI_ctx_iPoisson_offset_poisson,p.deepI_ctx_iPoisson_latency_poisson,p.deepI_ctx_iPoisson_f_poisson,p.deepI_ctx_iPoisson_fsigma_poisson,p.deepI_ctx_iPoisson_phi_poisson,p.deepI_ctx_iPoisson_connsigma_poisson,p.deepI_ctx_iPoisson_baseline_poisson,p.deepI_ctx_iPoisson_DC_poisson,p.deepI_ctx_iPoisson_AC_poisson,p.deepI_ctx_iPoisson_slopedutycycle_poisson,p.deepI_ctx_iPoisson_thresholddutycycle_poisson,p.deepI_ctx_iPoisson_tau_poisson,p.deepI_ctx_iPoisson_kick_poisson,T,p.deepI_Npop);
IO_SA1_ctx_iPoisson_s_poisson = getPoissonDutyCycleGating(p.IO_SA1_ctx_iPoisson_onset_poisson,p.IO_SA1_ctx_iPoisson_offset_poisson,p.IO_SA1_ctx_iPoisson_latency_poisson,p.IO_SA1_ctx_iPoisson_f_poisson,p.IO_SA1_ctx_iPoisson_fsigma_poisson,p.IO_SA1_ctx_iPoisson_phi_poisson,p.IO_SA1_ctx_iPoisson_connsigma_poisson,p.IO_SA1_ctx_iPoisson_baseline_poisson,p.IO_SA1_ctx_iPoisson_DC_poisson,p.IO_SA1_ctx_iPoisson_AC_poisson,p.IO_SA1_ctx_iPoisson_slopedutycycle_poisson,p.IO_SA1_ctx_iPoisson_thresholddutycycle_poisson,p.IO_SA1_ctx_iPoisson_tau_poisson,p.IO_SA1_ctx_iPoisson_kick_poisson,T,p.IO_SA1_Npop);
IO_SB1_ctx_iPoisson_s_poisson = getPoissonDutyCycleGating(p.IO_SB1_ctx_iPoisson_onset_poisson,p.IO_SB1_ctx_iPoisson_offset_poisson,p.IO_SB1_ctx_iPoisson_latency_poisson,p.IO_SB1_ctx_iPoisson_f_poisson,p.IO_SB1_ctx_iPoisson_fsigma_poisson,p.IO_SB1_ctx_iPoisson_phi_poisson,p.IO_SB1_ctx_iPoisson_connsigma_poisson,p.IO_SB1_ctx_iPoisson_baseline_poisson,p.IO_SB1_ctx_iPoisson_DC_poisson,p.IO_SB1_ctx_iPoisson_AC_poisson,p.IO_SB1_ctx_iPoisson_slopedutycycle_poisson,p.IO_SB1_ctx_iPoisson_thresholddutycycle_poisson,p.IO_SB1_ctx_iPoisson_tau_poisson,p.IO_SB1_ctx_iPoisson_kick_poisson,T,p.IO_SB1_Npop);
IO_SC1_ctx_iPoisson_s_poisson = getPoissonDutyCycleGating(p.IO_SC1_ctx_iPoisson_onset_poisson,p.IO_SC1_ctx_iPoisson_offset_poisson,p.IO_SC1_ctx_iPoisson_latency_poisson,p.IO_SC1_ctx_iPoisson_f_poisson,p.IO_SC1_ctx_iPoisson_fsigma_poisson,p.IO_SC1_ctx_iPoisson_phi_poisson,p.IO_SC1_ctx_iPoisson_connsigma_poisson,p.IO_SC1_ctx_iPoisson_baseline_poisson,p.IO_SC1_ctx_iPoisson_DC_poisson,p.IO_SC1_ctx_iPoisson_AC_poisson,p.IO_SC1_ctx_iPoisson_slopedutycycle_poisson,p.IO_SC1_ctx_iPoisson_thresholddutycycle_poisson,p.IO_SC1_ctx_iPoisson_tau_poisson,p.IO_SC1_ctx_iPoisson_kick_poisson,T,p.IO_SC1_Npop);
IO_SA2_ctx_iPoisson_s_poisson = getPoissonDutyCycleGating(p.IO_SA2_ctx_iPoisson_onset_poisson,p.IO_SA2_ctx_iPoisson_offset_poisson,p.IO_SA2_ctx_iPoisson_latency_poisson,p.IO_SA2_ctx_iPoisson_f_poisson,p.IO_SA2_ctx_iPoisson_fsigma_poisson,p.IO_SA2_ctx_iPoisson_phi_poisson,p.IO_SA2_ctx_iPoisson_connsigma_poisson,p.IO_SA2_ctx_iPoisson_baseline_poisson,p.IO_SA2_ctx_iPoisson_DC_poisson,p.IO_SA2_ctx_iPoisson_AC_poisson,p.IO_SA2_ctx_iPoisson_slopedutycycle_poisson,p.IO_SA2_ctx_iPoisson_thresholddutycycle_poisson,p.IO_SA2_ctx_iPoisson_tau_poisson,p.IO_SA2_ctx_iPoisson_kick_poisson,T,p.IO_SA2_Npop);
IO_SB2_ctx_iPoisson_s_poisson = getPoissonDutyCycleGating(p.IO_SB2_ctx_iPoisson_onset_poisson,p.IO_SB2_ctx_iPoisson_offset_poisson,p.IO_SB2_ctx_iPoisson_latency_poisson,p.IO_SB2_ctx_iPoisson_f_poisson,p.IO_SB2_ctx_iPoisson_fsigma_poisson,p.IO_SB2_ctx_iPoisson_phi_poisson,p.IO_SB2_ctx_iPoisson_connsigma_poisson,p.IO_SB2_ctx_iPoisson_baseline_poisson,p.IO_SB2_ctx_iPoisson_DC_poisson,p.IO_SB2_ctx_iPoisson_AC_poisson,p.IO_SB2_ctx_iPoisson_slopedutycycle_poisson,p.IO_SB2_ctx_iPoisson_thresholddutycycle_poisson,p.IO_SB2_ctx_iPoisson_tau_poisson,p.IO_SB2_ctx_iPoisson_kick_poisson,T,p.IO_SB2_Npop);
IO_SC2_ctx_iPoisson_s_poisson = getPoissonDutyCycleGating(p.IO_SC2_ctx_iPoisson_onset_poisson,p.IO_SC2_ctx_iPoisson_offset_poisson,p.IO_SC2_ctx_iPoisson_latency_poisson,p.IO_SC2_ctx_iPoisson_f_poisson,p.IO_SC2_ctx_iPoisson_fsigma_poisson,p.IO_SC2_ctx_iPoisson_phi_poisson,p.IO_SC2_ctx_iPoisson_connsigma_poisson,p.IO_SC2_ctx_iPoisson_baseline_poisson,p.IO_SC2_ctx_iPoisson_DC_poisson,p.IO_SC2_ctx_iPoisson_AC_poisson,p.IO_SC2_ctx_iPoisson_slopedutycycle_poisson,p.IO_SC2_ctx_iPoisson_thresholddutycycle_poisson,p.IO_SC2_ctx_iPoisson_tau_poisson,p.IO_SC2_ctx_iPoisson_kick_poisson,T,p.IO_SC2_Npop);
IO_Cx1_ctx_iPoisson_s_poisson = getPoissonDutyCycleGating(p.IO_Cx1_ctx_iPoisson_onset_poisson,p.IO_Cx1_ctx_iPoisson_offset_poisson,p.IO_Cx1_ctx_iPoisson_latency_poisson,p.IO_Cx1_ctx_iPoisson_f_poisson,p.IO_Cx1_ctx_iPoisson_fsigma_poisson,p.IO_Cx1_ctx_iPoisson_phi_poisson,p.IO_Cx1_ctx_iPoisson_connsigma_poisson,p.IO_Cx1_ctx_iPoisson_baseline_poisson,p.IO_Cx1_ctx_iPoisson_DC_poisson,p.IO_Cx1_ctx_iPoisson_AC_poisson,p.IO_Cx1_ctx_iPoisson_slopedutycycle_poisson,p.IO_Cx1_ctx_iPoisson_thresholddutycycle_poisson,p.IO_Cx1_ctx_iPoisson_tau_poisson,p.IO_Cx1_ctx_iPoisson_kick_poisson,T,p.IO_Cx1_Npop);
IO_Cx2_ctx_iPoisson_s_poisson = getPoissonDutyCycleGating(p.IO_Cx2_ctx_iPoisson_onset_poisson,p.IO_Cx2_ctx_iPoisson_offset_poisson,p.IO_Cx2_ctx_iPoisson_latency_poisson,p.IO_Cx2_ctx_iPoisson_f_poisson,p.IO_Cx2_ctx_iPoisson_fsigma_poisson,p.IO_Cx2_ctx_iPoisson_phi_poisson,p.IO_Cx2_ctx_iPoisson_connsigma_poisson,p.IO_Cx2_ctx_iPoisson_baseline_poisson,p.IO_Cx2_ctx_iPoisson_DC_poisson,p.IO_Cx2_ctx_iPoisson_AC_poisson,p.IO_Cx2_ctx_iPoisson_slopedutycycle_poisson,p.IO_Cx2_ctx_iPoisson_thresholddutycycle_poisson,p.IO_Cx2_ctx_iPoisson_tau_poisson,p.IO_Cx2_ctx_iPoisson_kick_poisson,T,p.IO_Cx2_Npop);
IO_SB1_IO_SA1_iPoisson_s = getPoissonGating(p.IO_SB1_IO_SA1_iPoisson_baseline,p.IO_SB1_IO_SA1_iPoisson_DC,p.IO_SB1_IO_SA1_iPoisson_AC,p.IO_SB1_IO_SA1_iPoisson_f,p.IO_SB1_IO_SA1_iPoisson_phi,p.IO_SB1_IO_SA1_iPoisson_onset,p.IO_SB1_IO_SA1_iPoisson_offset,p.IO_SB1_IO_SA1_iPoisson_tau,T,p.IO_SB1_Npop);
IO_SA1_IO_SA1_iPoisson_s = getPoissonGating(p.IO_SA1_IO_SA1_iPoisson_baseline,p.IO_SA1_IO_SA1_iPoisson_DC,p.IO_SA1_IO_SA1_iPoisson_AC,p.IO_SA1_IO_SA1_iPoisson_f,p.IO_SA1_IO_SA1_iPoisson_phi,p.IO_SA1_IO_SA1_iPoisson_onset,p.IO_SA1_IO_SA1_iPoisson_offset,p.IO_SA1_IO_SA1_iPoisson_tau,T,p.IO_SA1_Npop);
IO_SA1_IO_SB1_iPoisson_s = getPoissonGating(p.IO_SA1_IO_SB1_iPoisson_baseline,p.IO_SA1_IO_SB1_iPoisson_DC,p.IO_SA1_IO_SB1_iPoisson_AC,p.IO_SA1_IO_SB1_iPoisson_f,p.IO_SA1_IO_SB1_iPoisson_phi,p.IO_SA1_IO_SB1_iPoisson_onset,p.IO_SA1_IO_SB1_iPoisson_offset,p.IO_SA1_IO_SB1_iPoisson_tau,T,p.IO_SA1_Npop);
IO_SB1_IO_SB1_iPoisson_s = getPoissonGating(p.IO_SB1_IO_SB1_iPoisson_baseline,p.IO_SB1_IO_SB1_iPoisson_DC,p.IO_SB1_IO_SB1_iPoisson_AC,p.IO_SB1_IO_SB1_iPoisson_f,p.IO_SB1_IO_SB1_iPoisson_phi,p.IO_SB1_IO_SB1_iPoisson_onset,p.IO_SB1_IO_SB1_iPoisson_offset,p.IO_SB1_IO_SB1_iPoisson_tau,T,p.IO_SB1_Npop);
IO_SA2_IO_SC1_iPoisson_s = getPoissonGating(p.IO_SA2_IO_SC1_iPoisson_baseline,p.IO_SA2_IO_SC1_iPoisson_DC,p.IO_SA2_IO_SC1_iPoisson_AC,p.IO_SA2_IO_SC1_iPoisson_f,p.IO_SA2_IO_SC1_iPoisson_phi,p.IO_SA2_IO_SC1_iPoisson_onset,p.IO_SA2_IO_SC1_iPoisson_offset,p.IO_SA2_IO_SC1_iPoisson_tau,T,p.IO_SA2_Npop);
IO_SC1_IO_SC1_iPoisson_s = getPoissonGating(p.IO_SC1_IO_SC1_iPoisson_baseline,p.IO_SC1_IO_SC1_iPoisson_DC,p.IO_SC1_IO_SC1_iPoisson_AC,p.IO_SC1_IO_SC1_iPoisson_f,p.IO_SC1_IO_SC1_iPoisson_phi,p.IO_SC1_IO_SC1_iPoisson_onset,p.IO_SC1_IO_SC1_iPoisson_offset,p.IO_SC1_IO_SC1_iPoisson_tau,T,p.IO_SC1_Npop);
IO_SC1_IO_SA2_iPoisson_s = getPoissonGating(p.IO_SC1_IO_SA2_iPoisson_baseline,p.IO_SC1_IO_SA2_iPoisson_DC,p.IO_SC1_IO_SA2_iPoisson_AC,p.IO_SC1_IO_SA2_iPoisson_f,p.IO_SC1_IO_SA2_iPoisson_phi,p.IO_SC1_IO_SA2_iPoisson_onset,p.IO_SC1_IO_SA2_iPoisson_offset,p.IO_SC1_IO_SA2_iPoisson_tau,T,p.IO_SC1_Npop);
IO_SA2_IO_SA2_iPoisson_s = getPoissonGating(p.IO_SA2_IO_SA2_iPoisson_baseline,p.IO_SA2_IO_SA2_iPoisson_DC,p.IO_SA2_IO_SA2_iPoisson_AC,p.IO_SA2_IO_SA2_iPoisson_f,p.IO_SA2_IO_SA2_iPoisson_phi,p.IO_SA2_IO_SA2_iPoisson_onset,p.IO_SA2_IO_SA2_iPoisson_offset,p.IO_SA2_IO_SA2_iPoisson_tau,T,p.IO_SA2_Npop);
IO_SC2_IO_SB2_iPoisson_s = getPoissonGating(p.IO_SC2_IO_SB2_iPoisson_baseline,p.IO_SC2_IO_SB2_iPoisson_DC,p.IO_SC2_IO_SB2_iPoisson_AC,p.IO_SC2_IO_SB2_iPoisson_f,p.IO_SC2_IO_SB2_iPoisson_phi,p.IO_SC2_IO_SB2_iPoisson_onset,p.IO_SC2_IO_SB2_iPoisson_offset,p.IO_SC2_IO_SB2_iPoisson_tau,T,p.IO_SC2_Npop);
IO_SB2_IO_SB2_iPoisson_s = getPoissonGating(p.IO_SB2_IO_SB2_iPoisson_baseline,p.IO_SB2_IO_SB2_iPoisson_DC,p.IO_SB2_IO_SB2_iPoisson_AC,p.IO_SB2_IO_SB2_iPoisson_f,p.IO_SB2_IO_SB2_iPoisson_phi,p.IO_SB2_IO_SB2_iPoisson_onset,p.IO_SB2_IO_SB2_iPoisson_offset,p.IO_SB2_IO_SB2_iPoisson_tau,T,p.IO_SB2_Npop);
IO_SB2_IO_SC2_iPoisson_s = getPoissonGating(p.IO_SB2_IO_SC2_iPoisson_baseline,p.IO_SB2_IO_SC2_iPoisson_DC,p.IO_SB2_IO_SC2_iPoisson_AC,p.IO_SB2_IO_SC2_iPoisson_f,p.IO_SB2_IO_SC2_iPoisson_phi,p.IO_SB2_IO_SC2_iPoisson_onset,p.IO_SB2_IO_SC2_iPoisson_offset,p.IO_SB2_IO_SC2_iPoisson_tau,T,p.IO_SB2_Npop);
IO_SC2_IO_SC2_iPoisson_s = getPoissonGating(p.IO_SC2_IO_SC2_iPoisson_baseline,p.IO_SC2_IO_SC2_iPoisson_DC,p.IO_SC2_IO_SC2_iPoisson_AC,p.IO_SC2_IO_SC2_iPoisson_f,p.IO_SC2_IO_SC2_iPoisson_phi,p.IO_SC2_IO_SC2_iPoisson_onset,p.IO_SC2_IO_SC2_iPoisson_offset,p.IO_SC2_IO_SC2_iPoisson_tau,T,p.IO_SC2_Npop);
IO_Cx2_IO_Cx1_iPoisson_s = getPoissonGating(p.IO_Cx2_IO_Cx1_iPoisson_baseline,p.IO_Cx2_IO_Cx1_iPoisson_DC,p.IO_Cx2_IO_Cx1_iPoisson_AC,p.IO_Cx2_IO_Cx1_iPoisson_f,p.IO_Cx2_IO_Cx1_iPoisson_phi,p.IO_Cx2_IO_Cx1_iPoisson_onset,p.IO_Cx2_IO_Cx1_iPoisson_offset,p.IO_Cx2_IO_Cx1_iPoisson_tau,T,p.IO_Cx2_Npop);
IO_Cx1_IO_Cx1_iPoisson_s = getPoissonGating(p.IO_Cx1_IO_Cx1_iPoisson_baseline,p.IO_Cx1_IO_Cx1_iPoisson_DC,p.IO_Cx1_IO_Cx1_iPoisson_AC,p.IO_Cx1_IO_Cx1_iPoisson_f,p.IO_Cx1_IO_Cx1_iPoisson_phi,p.IO_Cx1_IO_Cx1_iPoisson_onset,p.IO_Cx1_IO_Cx1_iPoisson_offset,p.IO_Cx1_IO_Cx1_iPoisson_tau,T,p.IO_Cx1_Npop);
IO_Cx1_IO_Cx2_iPoisson_s = getPoissonGating(p.IO_Cx1_IO_Cx2_iPoisson_baseline,p.IO_Cx1_IO_Cx2_iPoisson_DC,p.IO_Cx1_IO_Cx2_iPoisson_AC,p.IO_Cx1_IO_Cx2_iPoisson_f,p.IO_Cx1_IO_Cx2_iPoisson_phi,p.IO_Cx1_IO_Cx2_iPoisson_onset,p.IO_Cx1_IO_Cx2_iPoisson_offset,p.IO_Cx1_IO_Cx2_iPoisson_tau,T,p.IO_Cx1_Npop);
IO_Cx2_IO_Cx2_iPoisson_s = getPoissonGating(p.IO_Cx2_IO_Cx2_iPoisson_baseline,p.IO_Cx2_IO_Cx2_iPoisson_DC,p.IO_Cx2_IO_Cx2_iPoisson_AC,p.IO_Cx2_IO_Cx2_iPoisson_f,p.IO_Cx2_IO_Cx2_iPoisson_phi,p.IO_Cx2_IO_Cx2_iPoisson_onset,p.IO_Cx2_IO_Cx2_iPoisson_offset,p.IO_Cx2_IO_Cx2_iPoisson_tau,T,p.IO_Cx2_Npop);
midE_IO_SA1_iPoisson_s = getPoissonGating(p.midE_IO_SA1_iPoisson_baseline,p.midE_IO_SA1_iPoisson_DC,p.midE_IO_SA1_iPoisson_AC,p.midE_IO_SA1_iPoisson_f,p.midE_IO_SA1_iPoisson_phi,p.midE_IO_SA1_iPoisson_onset,p.midE_IO_SA1_iPoisson_offset,p.midE_IO_SA1_iPoisson_tau,T,p.midE_Npop);
midE_IO_SA2_iPoisson_s = getPoissonGating(p.midE_IO_SA2_iPoisson_baseline,p.midE_IO_SA2_iPoisson_DC,p.midE_IO_SA2_iPoisson_AC,p.midE_IO_SA2_iPoisson_f,p.midE_IO_SA2_iPoisson_phi,p.midE_IO_SA2_iPoisson_onset,p.midE_IO_SA2_iPoisson_offset,p.midE_IO_SA2_iPoisson_tau,T,p.midE_Npop);

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
supE_V_last =  -rand(1, p.supE_Npop)*17;
supE_V = zeros(nsamp,p.supE_Npop);
supE_V(1,:) = supE_V_last;
supE_iNa_m_last = p.supE_iNa_m_IC+p.supE_iNa_IC_noise*rand(1,p.supE_Npop);
supE_iNa_m = zeros(nsamp,p.supE_Npop);
supE_iNa_m(1,:) = supE_iNa_m_last;
supE_iNa_h_last = p.supE_iNa_h_IC+p.supE_iNa_IC_noise*rand(1,p.supE_Npop);
supE_iNa_h = zeros(nsamp,p.supE_Npop);
supE_iNa_h(1,:) = supE_iNa_h_last;
supE_iK_n_last = p.supE_iK_n_IC+p.supE_iK_IC_noise*rand(1,p.supE_Npop);
supE_iK_n = zeros(nsamp,p.supE_Npop);
supE_iK_n(1,:) = supE_iK_n_last;
supI_V_last =  -rand(1, p.supI_Npop)*17;
supI_V = zeros(nsamp,p.supI_Npop);
supI_V(1,:) = supI_V_last;
supI_iNa_m_last = p.supI_iNa_m_IC+p.supI_iNa_IC_noise*rand(1,p.supI_Npop);
supI_iNa_m = zeros(nsamp,p.supI_Npop);
supI_iNa_m(1,:) = supI_iNa_m_last;
supI_iNa_h_last = p.supI_iNa_h_IC+p.supI_iNa_IC_noise*rand(1,p.supI_Npop);
supI_iNa_h = zeros(nsamp,p.supI_Npop);
supI_iNa_h(1,:) = supI_iNa_h_last;
supI_iK_n_last = p.supI_iK_n_IC+p.supI_iK_IC_noise*rand(1,p.supI_Npop);
supI_iK_n = zeros(nsamp,p.supI_Npop);
supI_iK_n(1,:) = supI_iK_n_last;
midE_V_last =  -rand(1, p.midE_Npop)*17;
midE_V = zeros(nsamp,p.midE_Npop);
midE_V(1,:) = midE_V_last;
midE_iNa_m_last = p.midE_iNa_m_IC+p.midE_iNa_IC_noise*rand(1,p.midE_Npop);
midE_iNa_m = zeros(nsamp,p.midE_Npop);
midE_iNa_m(1,:) = midE_iNa_m_last;
midE_iNa_h_last = p.midE_iNa_h_IC+p.midE_iNa_IC_noise*rand(1,p.midE_Npop);
midE_iNa_h = zeros(nsamp,p.midE_Npop);
midE_iNa_h(1,:) = midE_iNa_h_last;
midE_iK_n_last = p.midE_iK_n_IC+p.midE_iK_IC_noise*rand(1,p.midE_Npop);
midE_iK_n = zeros(nsamp,p.midE_Npop);
midE_iK_n(1,:) = midE_iK_n_last;
midI_V_last =  -rand(1, p.midI_Npop)*17;
midI_V = zeros(nsamp,p.midI_Npop);
midI_V(1,:) = midI_V_last;
midI_iNa_m_last = p.midI_iNa_m_IC+p.midI_iNa_IC_noise*rand(1,p.midI_Npop);
midI_iNa_m = zeros(nsamp,p.midI_Npop);
midI_iNa_m(1,:) = midI_iNa_m_last;
midI_iNa_h_last = p.midI_iNa_h_IC+p.midI_iNa_IC_noise*rand(1,p.midI_Npop);
midI_iNa_h = zeros(nsamp,p.midI_Npop);
midI_iNa_h(1,:) = midI_iNa_h_last;
midI_iK_n_last = p.midI_iK_n_IC+p.midI_iK_IC_noise*rand(1,p.midI_Npop);
midI_iK_n = zeros(nsamp,p.midI_Npop);
midI_iK_n(1,:) = midI_iK_n_last;
deepE_V_last =  -rand(1, p.deepE_Npop)*17;
deepE_V = zeros(nsamp,p.deepE_Npop);
deepE_V(1,:) = deepE_V_last;
deepE_iNa_m_last = p.deepE_iNa_m_IC+p.deepE_iNa_IC_noise*rand(1,p.deepE_Npop);
deepE_iNa_m = zeros(nsamp,p.deepE_Npop);
deepE_iNa_m(1,:) = deepE_iNa_m_last;
deepE_iNa_h_last = p.deepE_iNa_h_IC+p.deepE_iNa_IC_noise*rand(1,p.deepE_Npop);
deepE_iNa_h = zeros(nsamp,p.deepE_Npop);
deepE_iNa_h(1,:) = deepE_iNa_h_last;
deepE_iK_n_last = p.deepE_iK_n_IC+p.deepE_iK_IC_noise*rand(1,p.deepE_Npop);
deepE_iK_n = zeros(nsamp,p.deepE_Npop);
deepE_iK_n(1,:) = deepE_iK_n_last;
deepI_V_last =  -rand(1, p.deepI_Npop)*17;
deepI_V = zeros(nsamp,p.deepI_Npop);
deepI_V(1,:) = deepI_V_last;
deepI_iNa_m_last = p.deepI_iNa_m_IC+p.deepI_iNa_IC_noise*rand(1,p.deepI_Npop);
deepI_iNa_m = zeros(nsamp,p.deepI_Npop);
deepI_iNa_m(1,:) = deepI_iNa_m_last;
deepI_iNa_h_last = p.deepI_iNa_h_IC+p.deepI_iNa_IC_noise*rand(1,p.deepI_Npop);
deepI_iNa_h = zeros(nsamp,p.deepI_Npop);
deepI_iNa_h(1,:) = deepI_iNa_h_last;
deepI_iK_n_last = p.deepI_iK_n_IC+p.deepI_iK_IC_noise*rand(1,p.deepI_Npop);
deepI_iK_n = zeros(nsamp,p.deepI_Npop);
deepI_iK_n(1,:) = deepI_iK_n_last;
IO_SA1_V_last =  -rand(1, p.IO_SA1_Npop)*17;
IO_SA1_V = zeros(nsamp,p.IO_SA1_Npop);
IO_SA1_V(1,:) = IO_SA1_V_last;
IO_SA1_iNa_m_last = p.IO_SA1_iNa_m_IC+p.IO_SA1_iNa_IC_noise*rand(1,p.IO_SA1_Npop);
IO_SA1_iNa_m = zeros(nsamp,p.IO_SA1_Npop);
IO_SA1_iNa_m(1,:) = IO_SA1_iNa_m_last;
IO_SA1_iNa_h_last = p.IO_SA1_iNa_h_IC+p.IO_SA1_iNa_IC_noise*rand(1,p.IO_SA1_Npop);
IO_SA1_iNa_h = zeros(nsamp,p.IO_SA1_Npop);
IO_SA1_iNa_h(1,:) = IO_SA1_iNa_h_last;
IO_SA1_iK_n_last = p.IO_SA1_iK_n_IC+p.IO_SA1_iK_IC_noise*rand(1,p.IO_SA1_Npop);
IO_SA1_iK_n = zeros(nsamp,p.IO_SA1_Npop);
IO_SA1_iK_n(1,:) = IO_SA1_iK_n_last;
IO_SB1_V_last =  -rand(1, p.IO_SB1_Npop)*17;
IO_SB1_V = zeros(nsamp,p.IO_SB1_Npop);
IO_SB1_V(1,:) = IO_SB1_V_last;
IO_SB1_iNa_m_last = p.IO_SB1_iNa_m_IC+p.IO_SB1_iNa_IC_noise*rand(1,p.IO_SB1_Npop);
IO_SB1_iNa_m = zeros(nsamp,p.IO_SB1_Npop);
IO_SB1_iNa_m(1,:) = IO_SB1_iNa_m_last;
IO_SB1_iNa_h_last = p.IO_SB1_iNa_h_IC+p.IO_SB1_iNa_IC_noise*rand(1,p.IO_SB1_Npop);
IO_SB1_iNa_h = zeros(nsamp,p.IO_SB1_Npop);
IO_SB1_iNa_h(1,:) = IO_SB1_iNa_h_last;
IO_SB1_iK_n_last = p.IO_SB1_iK_n_IC+p.IO_SB1_iK_IC_noise*rand(1,p.IO_SB1_Npop);
IO_SB1_iK_n = zeros(nsamp,p.IO_SB1_Npop);
IO_SB1_iK_n(1,:) = IO_SB1_iK_n_last;
IO_SC1_V_last =  -rand(1, p.IO_SC1_Npop)*17;
IO_SC1_V = zeros(nsamp,p.IO_SC1_Npop);
IO_SC1_V(1,:) = IO_SC1_V_last;
IO_SC1_iNa_m_last = p.IO_SC1_iNa_m_IC+p.IO_SC1_iNa_IC_noise*rand(1,p.IO_SC1_Npop);
IO_SC1_iNa_m = zeros(nsamp,p.IO_SC1_Npop);
IO_SC1_iNa_m(1,:) = IO_SC1_iNa_m_last;
IO_SC1_iNa_h_last = p.IO_SC1_iNa_h_IC+p.IO_SC1_iNa_IC_noise*rand(1,p.IO_SC1_Npop);
IO_SC1_iNa_h = zeros(nsamp,p.IO_SC1_Npop);
IO_SC1_iNa_h(1,:) = IO_SC1_iNa_h_last;
IO_SC1_iK_n_last = p.IO_SC1_iK_n_IC+p.IO_SC1_iK_IC_noise*rand(1,p.IO_SC1_Npop);
IO_SC1_iK_n = zeros(nsamp,p.IO_SC1_Npop);
IO_SC1_iK_n(1,:) = IO_SC1_iK_n_last;
IO_SA2_V_last =  -rand(1, p.IO_SA2_Npop)*17;
IO_SA2_V = zeros(nsamp,p.IO_SA2_Npop);
IO_SA2_V(1,:) = IO_SA2_V_last;
IO_SA2_iNa_m_last = p.IO_SA2_iNa_m_IC+p.IO_SA2_iNa_IC_noise*rand(1,p.IO_SA2_Npop);
IO_SA2_iNa_m = zeros(nsamp,p.IO_SA2_Npop);
IO_SA2_iNa_m(1,:) = IO_SA2_iNa_m_last;
IO_SA2_iNa_h_last = p.IO_SA2_iNa_h_IC+p.IO_SA2_iNa_IC_noise*rand(1,p.IO_SA2_Npop);
IO_SA2_iNa_h = zeros(nsamp,p.IO_SA2_Npop);
IO_SA2_iNa_h(1,:) = IO_SA2_iNa_h_last;
IO_SA2_iK_n_last = p.IO_SA2_iK_n_IC+p.IO_SA2_iK_IC_noise*rand(1,p.IO_SA2_Npop);
IO_SA2_iK_n = zeros(nsamp,p.IO_SA2_Npop);
IO_SA2_iK_n(1,:) = IO_SA2_iK_n_last;
IO_SB2_V_last =  -rand(1, p.IO_SB2_Npop)*17;
IO_SB2_V = zeros(nsamp,p.IO_SB2_Npop);
IO_SB2_V(1,:) = IO_SB2_V_last;
IO_SB2_iNa_m_last = p.IO_SB2_iNa_m_IC+p.IO_SB2_iNa_IC_noise*rand(1,p.IO_SB2_Npop);
IO_SB2_iNa_m = zeros(nsamp,p.IO_SB2_Npop);
IO_SB2_iNa_m(1,:) = IO_SB2_iNa_m_last;
IO_SB2_iNa_h_last = p.IO_SB2_iNa_h_IC+p.IO_SB2_iNa_IC_noise*rand(1,p.IO_SB2_Npop);
IO_SB2_iNa_h = zeros(nsamp,p.IO_SB2_Npop);
IO_SB2_iNa_h(1,:) = IO_SB2_iNa_h_last;
IO_SB2_iK_n_last = p.IO_SB2_iK_n_IC+p.IO_SB2_iK_IC_noise*rand(1,p.IO_SB2_Npop);
IO_SB2_iK_n = zeros(nsamp,p.IO_SB2_Npop);
IO_SB2_iK_n(1,:) = IO_SB2_iK_n_last;
IO_SC2_V_last =  -rand(1, p.IO_SC2_Npop)*17;
IO_SC2_V = zeros(nsamp,p.IO_SC2_Npop);
IO_SC2_V(1,:) = IO_SC2_V_last;
IO_SC2_iNa_m_last = p.IO_SC2_iNa_m_IC+p.IO_SC2_iNa_IC_noise*rand(1,p.IO_SC2_Npop);
IO_SC2_iNa_m = zeros(nsamp,p.IO_SC2_Npop);
IO_SC2_iNa_m(1,:) = IO_SC2_iNa_m_last;
IO_SC2_iNa_h_last = p.IO_SC2_iNa_h_IC+p.IO_SC2_iNa_IC_noise*rand(1,p.IO_SC2_Npop);
IO_SC2_iNa_h = zeros(nsamp,p.IO_SC2_Npop);
IO_SC2_iNa_h(1,:) = IO_SC2_iNa_h_last;
IO_SC2_iK_n_last = p.IO_SC2_iK_n_IC+p.IO_SC2_iK_IC_noise*rand(1,p.IO_SC2_Npop);
IO_SC2_iK_n = zeros(nsamp,p.IO_SC2_Npop);
IO_SC2_iK_n(1,:) = IO_SC2_iK_n_last;
IO_Cx1_V_last =  -rand(1, p.IO_Cx1_Npop)*17;
IO_Cx1_V = zeros(nsamp,p.IO_Cx1_Npop);
IO_Cx1_V(1,:) = IO_Cx1_V_last;
IO_Cx1_iNa_m_last = p.IO_Cx1_iNa_m_IC+p.IO_Cx1_iNa_IC_noise*rand(1,p.IO_Cx1_Npop);
IO_Cx1_iNa_m = zeros(nsamp,p.IO_Cx1_Npop);
IO_Cx1_iNa_m(1,:) = IO_Cx1_iNa_m_last;
IO_Cx1_iNa_h_last = p.IO_Cx1_iNa_h_IC+p.IO_Cx1_iNa_IC_noise*rand(1,p.IO_Cx1_Npop);
IO_Cx1_iNa_h = zeros(nsamp,p.IO_Cx1_Npop);
IO_Cx1_iNa_h(1,:) = IO_Cx1_iNa_h_last;
IO_Cx1_iK_n_last = p.IO_Cx1_iK_n_IC+p.IO_Cx1_iK_IC_noise*rand(1,p.IO_Cx1_Npop);
IO_Cx1_iK_n = zeros(nsamp,p.IO_Cx1_Npop);
IO_Cx1_iK_n(1,:) = IO_Cx1_iK_n_last;
IO_Cx2_V_last =  -rand(1, p.IO_Cx2_Npop)*17;
IO_Cx2_V = zeros(nsamp,p.IO_Cx2_Npop);
IO_Cx2_V(1,:) = IO_Cx2_V_last;
IO_Cx2_iNa_m_last = p.IO_Cx2_iNa_m_IC+p.IO_Cx2_iNa_IC_noise*rand(1,p.IO_Cx2_Npop);
IO_Cx2_iNa_m = zeros(nsamp,p.IO_Cx2_Npop);
IO_Cx2_iNa_m(1,:) = IO_Cx2_iNa_m_last;
IO_Cx2_iNa_h_last = p.IO_Cx2_iNa_h_IC+p.IO_Cx2_iNa_IC_noise*rand(1,p.IO_Cx2_Npop);
IO_Cx2_iNa_h = zeros(nsamp,p.IO_Cx2_Npop);
IO_Cx2_iNa_h(1,:) = IO_Cx2_iNa_h_last;
IO_Cx2_iK_n_last = p.IO_Cx2_iK_n_IC+p.IO_Cx2_iK_IC_noise*rand(1,p.IO_Cx2_Npop);
IO_Cx2_iK_n = zeros(nsamp,p.IO_Cx2_Npop);
IO_Cx2_iK_n(1,:) = IO_Cx2_iK_n_last;
supI_supE_iAMPActx_s_last =  p.supI_supE_iAMPActx_IC+p.supI_supE_iAMPActx_IC_noise.*rand(1,p.supE_Npop);
supI_supE_iAMPActx_s = zeros(nsamp,p.supE_Npop);
supI_supE_iAMPActx_s(1,:) = supI_supE_iAMPActx_s_last;
supE_supE_iAMPActx_s_last =  p.supE_supE_iAMPActx_IC+p.supE_supE_iAMPActx_IC_noise.*rand(1,p.supE_Npop);
supE_supE_iAMPActx_s = zeros(nsamp,p.supE_Npop);
supE_supE_iAMPActx_s(1,:) = supE_supE_iAMPActx_s_last;
supE_supI_iGABActx_s_last =  p.supE_supI_iGABActx_IC+p.supE_supI_iGABActx_IC_noise.*rand(1,p.supI_Npop);
supE_supI_iGABActx_s = zeros(nsamp,p.supI_Npop);
supE_supI_iGABActx_s(1,:) = supE_supI_iGABActx_s_last;
supI_supI_iGABActx_s_last =  p.supI_supI_iGABActx_IC+p.supI_supI_iGABActx_IC_noise.*rand(1,p.supI_Npop);
supI_supI_iGABActx_s = zeros(nsamp,p.supI_Npop);
supI_supI_iGABActx_s(1,:) = supI_supI_iGABActx_s_last;
midI_midE_iAMPActx_s_last =  p.midI_midE_iAMPActx_IC+p.midI_midE_iAMPActx_IC_noise.*rand(1,p.midE_Npop);
midI_midE_iAMPActx_s = zeros(nsamp,p.midE_Npop);
midI_midE_iAMPActx_s(1,:) = midI_midE_iAMPActx_s_last;
midE_midE_iAMPActx_s_last =  p.midE_midE_iAMPActx_IC+p.midE_midE_iAMPActx_IC_noise.*rand(1,p.midE_Npop);
midE_midE_iAMPActx_s = zeros(nsamp,p.midE_Npop);
midE_midE_iAMPActx_s(1,:) = midE_midE_iAMPActx_s_last;
midE_midI_iGABActx_s_last =  p.midE_midI_iGABActx_IC+p.midE_midI_iGABActx_IC_noise.*rand(1,p.midI_Npop);
midE_midI_iGABActx_s = zeros(nsamp,p.midI_Npop);
midE_midI_iGABActx_s(1,:) = midE_midI_iGABActx_s_last;
midI_midI_iGABActx_s_last =  p.midI_midI_iGABActx_IC+p.midI_midI_iGABActx_IC_noise.*rand(1,p.midI_Npop);
midI_midI_iGABActx_s = zeros(nsamp,p.midI_Npop);
midI_midI_iGABActx_s(1,:) = midI_midI_iGABActx_s_last;
deepI_deepE_iAMPActx_s_last =  p.deepI_deepE_iAMPActx_IC+p.deepI_deepE_iAMPActx_IC_noise.*rand(1,p.deepE_Npop);
deepI_deepE_iAMPActx_s = zeros(nsamp,p.deepE_Npop);
deepI_deepE_iAMPActx_s(1,:) = deepI_deepE_iAMPActx_s_last;
deepE_deepE_iAMPActx_s_last =  p.deepE_deepE_iAMPActx_IC+p.deepE_deepE_iAMPActx_IC_noise.*rand(1,p.deepE_Npop);
deepE_deepE_iAMPActx_s = zeros(nsamp,p.deepE_Npop);
deepE_deepE_iAMPActx_s(1,:) = deepE_deepE_iAMPActx_s_last;
deepE_deepI_iGABActx_s_last =  p.deepE_deepI_iGABActx_IC+p.deepE_deepI_iGABActx_IC_noise.*rand(1,p.deepI_Npop);
deepE_deepI_iGABActx_s = zeros(nsamp,p.deepI_Npop);
deepE_deepI_iGABActx_s(1,:) = deepE_deepI_iGABActx_s_last;
deepI_deepI_iGABActx_s_last =  p.deepI_deepI_iGABActx_IC+p.deepI_deepI_iGABActx_IC_noise.*rand(1,p.deepI_Npop);
deepI_deepI_iGABActx_s = zeros(nsamp,p.deepI_Npop);
deepI_deepI_iGABActx_s(1,:) = deepI_deepI_iGABActx_s_last;
midE_IO_SB1_iAMPActx_s_last =  p.midE_IO_SB1_iAMPActx_IC+p.midE_IO_SB1_iAMPActx_IC_noise.*rand(1,p.IO_SB1_Npop);
midE_IO_SB1_iAMPActx_s = zeros(nsamp,p.IO_SB1_Npop);
midE_IO_SB1_iAMPActx_s(1,:) = midE_IO_SB1_iAMPActx_s_last;
midE_IO_SB2_iAMPActx_s_last =  p.midE_IO_SB2_iAMPActx_IC+p.midE_IO_SB2_iAMPActx_IC_noise.*rand(1,p.IO_SB2_Npop);
midE_IO_SB2_iAMPActx_s = zeros(nsamp,p.IO_SB2_Npop);
midE_IO_SB2_iAMPActx_s(1,:) = midE_IO_SB2_iAMPActx_s_last;
midE_IO_SC1_iAMPActx_s_last =  p.midE_IO_SC1_iAMPActx_IC+p.midE_IO_SC1_iAMPActx_IC_noise.*rand(1,p.IO_SC1_Npop);
midE_IO_SC1_iAMPActx_s = zeros(nsamp,p.IO_SC1_Npop);
midE_IO_SC1_iAMPActx_s(1,:) = midE_IO_SC1_iAMPActx_s_last;
midE_IO_SC2_iAMPActx_s_last =  p.midE_IO_SC2_iAMPActx_IC+p.midE_IO_SC2_iAMPActx_IC_noise.*rand(1,p.IO_SC2_Npop);
midE_IO_SC2_iAMPActx_s = zeros(nsamp,p.IO_SC2_Npop);
midE_IO_SC2_iAMPActx_s(1,:) = midE_IO_SC2_iAMPActx_s_last;
midE_IO_Cx1_iAMPActx_s_last =  p.midE_IO_Cx1_iAMPActx_IC+p.midE_IO_Cx1_iAMPActx_IC_noise.*rand(1,p.IO_Cx1_Npop);
midE_IO_Cx1_iAMPActx_s = zeros(nsamp,p.IO_Cx1_Npop);
midE_IO_Cx1_iAMPActx_s(1,:) = midE_IO_Cx1_iAMPActx_s_last;
midE_IO_Cx2_iAMPActx_s_last =  p.midE_IO_Cx2_iAMPActx_IC+p.midE_IO_Cx2_iAMPActx_IC_noise.*rand(1,p.IO_Cx2_Npop);
midE_IO_Cx2_iAMPActx_s = zeros(nsamp,p.IO_Cx2_Npop);
midE_IO_Cx2_iAMPActx_s(1,:) = midE_IO_Cx2_iAMPActx_s_last;
supE_midE_iAMPActx_s_last =  p.supE_midE_iAMPActx_IC+p.supE_midE_iAMPActx_IC_noise.*rand(1,p.midE_Npop);
supE_midE_iAMPActx_s = zeros(nsamp,p.midE_Npop);
supE_midE_iAMPActx_s(1,:) = supE_midE_iAMPActx_s_last;
deepE_midE_iAMPActx_s_last =  p.deepE_midE_iAMPActx_IC+p.deepE_midE_iAMPActx_IC_noise.*rand(1,p.midE_Npop);
deepE_midE_iAMPActx_s = zeros(nsamp,p.midE_Npop);
deepE_midE_iAMPActx_s(1,:) = deepE_midE_iAMPActx_s_last;
deepE_midI_iGABActx_s_last =  p.deepE_midI_iGABActx_IC+p.deepE_midI_iGABActx_IC_noise.*rand(1,p.midI_Npop);
deepE_midI_iGABActx_s = zeros(nsamp,p.midI_Npop);
deepE_midI_iGABActx_s(1,:) = deepE_midI_iGABActx_s_last;
deepE_supE_iAMPActx_s_last =  p.deepE_supE_iAMPActx_IC+p.deepE_supE_iAMPActx_IC_noise.*rand(1,p.supE_Npop);
deepE_supE_iAMPActx_s = zeros(nsamp,p.supE_Npop);
deepE_supE_iAMPActx_s(1,:) = deepE_supE_iAMPActx_s_last;

% MONITORS:
supE_ctx_iPoisson_g_poisson = zeros(nsamp,p.supE_Npop);
supE_ctx_iPoisson_g_poisson(1,:)=p.supE_ctx_iPoisson_g_poisson.*supE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
supE_ctx_iPoisson_I_poisson = zeros(nsamp,p.supE_Npop);
supE_ctx_iPoisson_I_poisson(1,:)=-((p.supE_ctx_iPoisson_g_poisson.*supE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(supE_V_last-p.supE_ctx_iPoisson_E_poisson);
supI_ctx_iPoisson_g_poisson = zeros(nsamp,p.supI_Npop);
supI_ctx_iPoisson_g_poisson(1,:)=p.supI_ctx_iPoisson_g_poisson.*supI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
supI_ctx_iPoisson_I_poisson = zeros(nsamp,p.supI_Npop);
supI_ctx_iPoisson_I_poisson(1,:)=-((p.supI_ctx_iPoisson_g_poisson.*supI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(supI_V_last-p.supI_ctx_iPoisson_E_poisson);
midE_ctx_iPoisson_g_poisson = zeros(nsamp,p.midE_Npop);
midE_ctx_iPoisson_g_poisson(1,:)=p.midE_ctx_iPoisson_g_poisson.*midE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
midE_ctx_iPoisson_I_poisson = zeros(nsamp,p.midE_Npop);
midE_ctx_iPoisson_I_poisson(1,:)=-((p.midE_ctx_iPoisson_g_poisson.*midE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(midE_V_last-p.midE_ctx_iPoisson_E_poisson);
midI_ctx_iPoisson_g_poisson = zeros(nsamp,p.midI_Npop);
midI_ctx_iPoisson_g_poisson(1,:)=p.midI_ctx_iPoisson_g_poisson.*midI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
midI_ctx_iPoisson_I_poisson = zeros(nsamp,p.midI_Npop);
midI_ctx_iPoisson_I_poisson(1,:)=-((p.midI_ctx_iPoisson_g_poisson.*midI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(midI_V_last-p.midI_ctx_iPoisson_E_poisson);
deepE_ctx_iPoisson_g_poisson = zeros(nsamp,p.deepE_Npop);
deepE_ctx_iPoisson_g_poisson(1,:)=p.deepE_ctx_iPoisson_g_poisson.*deepE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
deepE_ctx_iPoisson_I_poisson = zeros(nsamp,p.deepE_Npop);
deepE_ctx_iPoisson_I_poisson(1,:)=-((p.deepE_ctx_iPoisson_g_poisson.*deepE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(deepE_V_last-p.deepE_ctx_iPoisson_E_poisson);
deepI_ctx_iPoisson_g_poisson = zeros(nsamp,p.deepI_Npop);
deepI_ctx_iPoisson_g_poisson(1,:)=p.deepI_ctx_iPoisson_g_poisson.*deepI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
deepI_ctx_iPoisson_I_poisson = zeros(nsamp,p.deepI_Npop);
deepI_ctx_iPoisson_I_poisson(1,:)=-((p.deepI_ctx_iPoisson_g_poisson.*deepI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(deepI_V_last-p.deepI_ctx_iPoisson_E_poisson);
IO_SA1_ctx_iPoisson_g_poisson = zeros(nsamp,p.IO_SA1_Npop);
IO_SA1_ctx_iPoisson_g_poisson(1,:)=p.IO_SA1_ctx_iPoisson_g_poisson.*IO_SA1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
IO_SA1_ctx_iPoisson_I_poisson = zeros(nsamp,p.IO_SA1_Npop);
IO_SA1_ctx_iPoisson_I_poisson(1,:)=-((p.IO_SA1_ctx_iPoisson_g_poisson.*IO_SA1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SA1_V_last-p.IO_SA1_ctx_iPoisson_E_poisson);
IO_SB1_ctx_iPoisson_g_poisson = zeros(nsamp,p.IO_SB1_Npop);
IO_SB1_ctx_iPoisson_g_poisson(1,:)=p.IO_SB1_ctx_iPoisson_g_poisson.*IO_SB1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
IO_SB1_ctx_iPoisson_I_poisson = zeros(nsamp,p.IO_SB1_Npop);
IO_SB1_ctx_iPoisson_I_poisson(1,:)=-((p.IO_SB1_ctx_iPoisson_g_poisson.*IO_SB1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SB1_V_last-p.IO_SB1_ctx_iPoisson_E_poisson);
IO_SC1_ctx_iPoisson_g_poisson = zeros(nsamp,p.IO_SC1_Npop);
IO_SC1_ctx_iPoisson_g_poisson(1,:)=p.IO_SC1_ctx_iPoisson_g_poisson.*IO_SC1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
IO_SC1_ctx_iPoisson_I_poisson = zeros(nsamp,p.IO_SC1_Npop);
IO_SC1_ctx_iPoisson_I_poisson(1,:)=-((p.IO_SC1_ctx_iPoisson_g_poisson.*IO_SC1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SC1_V_last-p.IO_SC1_ctx_iPoisson_E_poisson);
IO_SA2_ctx_iPoisson_g_poisson = zeros(nsamp,p.IO_SA2_Npop);
IO_SA2_ctx_iPoisson_g_poisson(1,:)=p.IO_SA2_ctx_iPoisson_g_poisson.*IO_SA2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
IO_SA2_ctx_iPoisson_I_poisson = zeros(nsamp,p.IO_SA2_Npop);
IO_SA2_ctx_iPoisson_I_poisson(1,:)=-((p.IO_SA2_ctx_iPoisson_g_poisson.*IO_SA2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SA2_V_last-p.IO_SA2_ctx_iPoisson_E_poisson);
IO_SB2_ctx_iPoisson_g_poisson = zeros(nsamp,p.IO_SB2_Npop);
IO_SB2_ctx_iPoisson_g_poisson(1,:)=p.IO_SB2_ctx_iPoisson_g_poisson.*IO_SB2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
IO_SB2_ctx_iPoisson_I_poisson = zeros(nsamp,p.IO_SB2_Npop);
IO_SB2_ctx_iPoisson_I_poisson(1,:)=-((p.IO_SB2_ctx_iPoisson_g_poisson.*IO_SB2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SB2_V_last-p.IO_SB2_ctx_iPoisson_E_poisson);
IO_SC2_ctx_iPoisson_g_poisson = zeros(nsamp,p.IO_SC2_Npop);
IO_SC2_ctx_iPoisson_g_poisson(1,:)=p.IO_SC2_ctx_iPoisson_g_poisson.*IO_SC2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
IO_SC2_ctx_iPoisson_I_poisson = zeros(nsamp,p.IO_SC2_Npop);
IO_SC2_ctx_iPoisson_I_poisson(1,:)=-((p.IO_SC2_ctx_iPoisson_g_poisson.*IO_SC2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SC2_V_last-p.IO_SC2_ctx_iPoisson_E_poisson);
IO_Cx1_ctx_iPoisson_g_poisson = zeros(nsamp,p.IO_Cx1_Npop);
IO_Cx1_ctx_iPoisson_g_poisson(1,:)=p.IO_Cx1_ctx_iPoisson_g_poisson.*IO_Cx1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
IO_Cx1_ctx_iPoisson_I_poisson = zeros(nsamp,p.IO_Cx1_Npop);
IO_Cx1_ctx_iPoisson_I_poisson(1,:)=-((p.IO_Cx1_ctx_iPoisson_g_poisson.*IO_Cx1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_Cx1_V_last-p.IO_Cx1_ctx_iPoisson_E_poisson);
IO_Cx2_ctx_iPoisson_g_poisson = zeros(nsamp,p.IO_Cx2_Npop);
IO_Cx2_ctx_iPoisson_g_poisson(1,:)=p.IO_Cx2_ctx_iPoisson_g_poisson.*IO_Cx2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
IO_Cx2_ctx_iPoisson_I_poisson = zeros(nsamp,p.IO_Cx2_Npop);
IO_Cx2_ctx_iPoisson_I_poisson(1,:)=-((p.IO_Cx2_ctx_iPoisson_g_poisson.*IO_Cx2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_Cx2_V_last-p.IO_Cx2_ctx_iPoisson_E_poisson);
IO_SB1_IO_SA1_iPoisson_gPoisson = zeros(nsamp,p.IO_SB1_Npop);
IO_SB1_IO_SA1_iPoisson_gPoisson(1,:)=p.IO_SB1_IO_SA1_iPoisson_gext.*IO_SB1_IO_SA1_iPoisson_s(k,:);
IO_SA1_IO_SA1_iPoisson_gPoisson = zeros(nsamp,p.IO_SA1_Npop);
IO_SA1_IO_SA1_iPoisson_gPoisson(1,:)=p.IO_SA1_IO_SA1_iPoisson_gext.*IO_SA1_IO_SA1_iPoisson_s(k,:);
IO_SA1_IO_SB1_iPoisson_gPoisson = zeros(nsamp,p.IO_SA1_Npop);
IO_SA1_IO_SB1_iPoisson_gPoisson(1,:)=p.IO_SA1_IO_SB1_iPoisson_gext.*IO_SA1_IO_SB1_iPoisson_s(k,:);
IO_SB1_IO_SB1_iPoisson_gPoisson = zeros(nsamp,p.IO_SB1_Npop);
IO_SB1_IO_SB1_iPoisson_gPoisson(1,:)=p.IO_SB1_IO_SB1_iPoisson_gext.*IO_SB1_IO_SB1_iPoisson_s(k,:);
IO_SA2_IO_SC1_iPoisson_gPoisson = zeros(nsamp,p.IO_SA2_Npop);
IO_SA2_IO_SC1_iPoisson_gPoisson(1,:)=p.IO_SA2_IO_SC1_iPoisson_gext.*IO_SA2_IO_SC1_iPoisson_s(k,:);
IO_SC1_IO_SC1_iPoisson_gPoisson = zeros(nsamp,p.IO_SC1_Npop);
IO_SC1_IO_SC1_iPoisson_gPoisson(1,:)=p.IO_SC1_IO_SC1_iPoisson_gext.*IO_SC1_IO_SC1_iPoisson_s(k,:);
IO_SC1_IO_SA2_iPoisson_gPoisson = zeros(nsamp,p.IO_SC1_Npop);
IO_SC1_IO_SA2_iPoisson_gPoisson(1,:)=p.IO_SC1_IO_SA2_iPoisson_gext.*IO_SC1_IO_SA2_iPoisson_s(k,:);
IO_SA2_IO_SA2_iPoisson_gPoisson = zeros(nsamp,p.IO_SA2_Npop);
IO_SA2_IO_SA2_iPoisson_gPoisson(1,:)=p.IO_SA2_IO_SA2_iPoisson_gext.*IO_SA2_IO_SA2_iPoisson_s(k,:);
IO_SC2_IO_SB2_iPoisson_gPoisson = zeros(nsamp,p.IO_SC2_Npop);
IO_SC2_IO_SB2_iPoisson_gPoisson(1,:)=p.IO_SC2_IO_SB2_iPoisson_gext.*IO_SC2_IO_SB2_iPoisson_s(k,:);
IO_SB2_IO_SB2_iPoisson_gPoisson = zeros(nsamp,p.IO_SB2_Npop);
IO_SB2_IO_SB2_iPoisson_gPoisson(1,:)=p.IO_SB2_IO_SB2_iPoisson_gext.*IO_SB2_IO_SB2_iPoisson_s(k,:);
IO_SB2_IO_SC2_iPoisson_gPoisson = zeros(nsamp,p.IO_SB2_Npop);
IO_SB2_IO_SC2_iPoisson_gPoisson(1,:)=p.IO_SB2_IO_SC2_iPoisson_gext.*IO_SB2_IO_SC2_iPoisson_s(k,:);
IO_SC2_IO_SC2_iPoisson_gPoisson = zeros(nsamp,p.IO_SC2_Npop);
IO_SC2_IO_SC2_iPoisson_gPoisson(1,:)=p.IO_SC2_IO_SC2_iPoisson_gext.*IO_SC2_IO_SC2_iPoisson_s(k,:);
IO_Cx2_IO_Cx1_iPoisson_gPoisson = zeros(nsamp,p.IO_Cx2_Npop);
IO_Cx2_IO_Cx1_iPoisson_gPoisson(1,:)=p.IO_Cx2_IO_Cx1_iPoisson_gext.*IO_Cx2_IO_Cx1_iPoisson_s(k,:);
IO_Cx1_IO_Cx1_iPoisson_gPoisson = zeros(nsamp,p.IO_Cx1_Npop);
IO_Cx1_IO_Cx1_iPoisson_gPoisson(1,:)=p.IO_Cx1_IO_Cx1_iPoisson_gext.*IO_Cx1_IO_Cx1_iPoisson_s(k,:);
IO_Cx1_IO_Cx2_iPoisson_gPoisson = zeros(nsamp,p.IO_Cx1_Npop);
IO_Cx1_IO_Cx2_iPoisson_gPoisson(1,:)=p.IO_Cx1_IO_Cx2_iPoisson_gext.*IO_Cx1_IO_Cx2_iPoisson_s(k,:);
IO_Cx2_IO_Cx2_iPoisson_gPoisson = zeros(nsamp,p.IO_Cx2_Npop);
IO_Cx2_IO_Cx2_iPoisson_gPoisson(1,:)=p.IO_Cx2_IO_Cx2_iPoisson_gext.*IO_Cx2_IO_Cx2_iPoisson_s(k,:);
midE_IO_SA1_iPoisson_gPoisson = zeros(nsamp,p.midE_Npop);
midE_IO_SA1_iPoisson_gPoisson(1,:)=p.midE_IO_SA1_iPoisson_gext.*midE_IO_SA1_iPoisson_s(k,:);
midE_IO_SA2_iPoisson_gPoisson = zeros(nsamp,p.midE_Npop);
midE_IO_SA2_iPoisson_gPoisson(1,:)=p.midE_IO_SA2_iPoisson_gext.*midE_IO_SA2_iPoisson_s(k,:);

% ###########################################################
% Memory check:
% ###########################################################
try 
  memoryUsed = memoryUsageCallerGB(); 
  fprintf('Total Memory Used <= %i GB \n', ceil(memoryUsed)); 
end 

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  supE_V_k1 = (p.supE_Iapp + ((((-p.supE_iNa_gNa.*supE_iNa_m_last.^3.*supE_iNa_h_last.*(supE_V_last-p.supE_iNa_ENa))))+((((-p.supE_iK_gK.*supE_iK_n_last.^4.*(supE_V_last-p.supE_iK_EK))))+((((-((p.supE_ctx_iPoisson_g_poisson.*supE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(supE_V_last-p.supE_ctx_iPoisson_E_poisson))))+((-(((p.supE_supE_iAMPActx_gAMPA.*(supE_supE_iAMPActx_s_last*p.supE_supE_iAMPActx_netcon).*(supE_V_last-p.supE_supE_iAMPActx_EAMPA)))))+((((-p.supE_supI_iGABActx_gGABAa.*(supE_supI_iGABActx_s_last*p.supE_supI_iGABActx_netcon).*(supE_V_last-p.supE_supI_iGABActx_EGABAa))))+((-(((p.supE_midE_iAMPActx_gAMPA.*(supE_midE_iAMPActx_s_last*p.supE_midE_iAMPActx_netcon).*(supE_V_last-p.supE_midE_iAMPActx_EAMPA))))))))))) + p.supE_noise*randn(1, p.supE_Npop))/p.supE_C;
  supE_iNa_m_k1 = (((2.5-.1*(supE_V_last+65))./(exp(2.5-.1*(supE_V_last+65))-1))).*(1-supE_iNa_m_last)-((4*exp(-(supE_V_last+65)/18))).*supE_iNa_m_last;
  supE_iNa_h_k1 = ((.07*exp(-(supE_V_last+65)/20))).*(1-supE_iNa_h_last)-((1./(exp(3-.1*(supE_V_last+65))+1))).*supE_iNa_h_last;
  supE_iK_n_k1 = (((.1-.01*(supE_V_last+65))./(exp(1-.1*(supE_V_last+65))-1))).*(1-supE_iK_n_last)-((.125*exp(-(supE_V_last+65)/80))).*supE_iK_n_last;
  supI_V_k1 = (p.supI_Iapp + ((((-p.supI_iNa_gNa.*supI_iNa_m_last.^3.*supI_iNa_h_last.*(supI_V_last-p.supI_iNa_ENa))))+((((-p.supI_iK_gK.*supI_iK_n_last.^4.*(supI_V_last-p.supI_iK_EK))))+((((-((p.supI_ctx_iPoisson_g_poisson.*supI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(supI_V_last-p.supI_ctx_iPoisson_E_poisson))))+((-(((p.supI_supE_iAMPActx_gAMPA.*(supI_supE_iAMPActx_s_last*p.supI_supE_iAMPActx_netcon).*(supI_V_last-p.supI_supE_iAMPActx_EAMPA)))))+((((-p.supI_supI_iGABActx_gGABAa.*(supI_supI_iGABActx_s_last*p.supI_supI_iGABActx_netcon).*(supI_V_last-p.supI_supI_iGABActx_EGABAa))))))))) + p.supI_noise*randn(1, p.supI_Npop))/p.supI_C;
  supI_iNa_m_k1 = (((2.5-.1*(supI_V_last+65))./(exp(2.5-.1*(supI_V_last+65))-1))).*(1-supI_iNa_m_last)-((4*exp(-(supI_V_last+65)/18))).*supI_iNa_m_last;
  supI_iNa_h_k1 = ((.07*exp(-(supI_V_last+65)/20))).*(1-supI_iNa_h_last)-((1./(exp(3-.1*(supI_V_last+65))+1))).*supI_iNa_h_last;
  supI_iK_n_k1 = (((.1-.01*(supI_V_last+65))./(exp(1-.1*(supI_V_last+65))-1))).*(1-supI_iK_n_last)-((.125*exp(-(supI_V_last+65)/80))).*supI_iK_n_last;
  midE_V_k1 = (p.midE_Iapp + ((((-p.midE_iNa_gNa.*midE_iNa_m_last.^3.*midE_iNa_h_last.*(midE_V_last-p.midE_iNa_ENa))))+((((-p.midE_iK_gK.*midE_iK_n_last.^4.*(midE_V_last-p.midE_iK_EK))))+((((-((p.midE_ctx_iPoisson_g_poisson.*midE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(midE_V_last-p.midE_ctx_iPoisson_E_poisson))))+((-(((p.midE_midE_iAMPActx_gAMPA.*(midE_midE_iAMPActx_s_last*p.midE_midE_iAMPActx_netcon).*(midE_V_last-p.midE_midE_iAMPActx_EAMPA)))))+((((-p.midE_midI_iGABActx_gGABAa.*(midE_midI_iGABActx_s_last*p.midE_midI_iGABActx_netcon).*(midE_V_last-p.midE_midI_iGABActx_EGABAa))))+((((-((p.midE_IO_SA1_iPoisson_gext.*midE_IO_SA1_iPoisson_s(k,:))).*(midE_V_last-p.midE_IO_SA1_iPoisson_Eext))))+((((-((p.midE_IO_SA2_iPoisson_gext.*midE_IO_SA2_iPoisson_s(k,:))).*(midE_V_last-p.midE_IO_SA2_iPoisson_Eext))))+((-(((p.midE_IO_SB1_iAMPActx_gAMPA.*(midE_IO_SB1_iAMPActx_s_last*p.midE_IO_SB1_iAMPActx_netcon).*(midE_V_last-p.midE_IO_SB1_iAMPActx_EAMPA)))))+((-(((p.midE_IO_SB2_iAMPActx_gAMPA.*(midE_IO_SB2_iAMPActx_s_last*p.midE_IO_SB2_iAMPActx_netcon).*(midE_V_last-p.midE_IO_SB2_iAMPActx_EAMPA)))))+((-(((p.midE_IO_SC1_iAMPActx_gAMPA.*(midE_IO_SC1_iAMPActx_s_last*p.midE_IO_SC1_iAMPActx_netcon).*(midE_V_last-p.midE_IO_SC1_iAMPActx_EAMPA)))))+((-(((p.midE_IO_SC2_iAMPActx_gAMPA.*(midE_IO_SC2_iAMPActx_s_last*p.midE_IO_SC2_iAMPActx_netcon).*(midE_V_last-p.midE_IO_SC2_iAMPActx_EAMPA)))))+((-(((p.midE_IO_Cx1_iAMPActx_gAMPA.*(midE_IO_Cx1_iAMPActx_s_last*p.midE_IO_Cx1_iAMPActx_netcon).*(midE_V_last-p.midE_IO_Cx1_iAMPActx_EAMPA)))))+((-(((p.midE_IO_Cx2_iAMPActx_gAMPA.*(midE_IO_Cx2_iAMPActx_s_last*p.midE_IO_Cx2_iAMPActx_netcon).*(midE_V_last-p.midE_IO_Cx2_iAMPActx_EAMPA)))))))))))))))))) + p.midE_noise*randn(1, p.midE_Npop))/p.midE_C;
  midE_iNa_m_k1 = (((2.5-.1*(midE_V_last+65))./(exp(2.5-.1*(midE_V_last+65))-1))).*(1-midE_iNa_m_last)-((4*exp(-(midE_V_last+65)/18))).*midE_iNa_m_last;
  midE_iNa_h_k1 = ((.07*exp(-(midE_V_last+65)/20))).*(1-midE_iNa_h_last)-((1./(exp(3-.1*(midE_V_last+65))+1))).*midE_iNa_h_last;
  midE_iK_n_k1 = (((.1-.01*(midE_V_last+65))./(exp(1-.1*(midE_V_last+65))-1))).*(1-midE_iK_n_last)-((.125*exp(-(midE_V_last+65)/80))).*midE_iK_n_last;
  midI_V_k1 = (p.midI_Iapp + ((((-p.midI_iNa_gNa.*midI_iNa_m_last.^3.*midI_iNa_h_last.*(midI_V_last-p.midI_iNa_ENa))))+((((-p.midI_iK_gK.*midI_iK_n_last.^4.*(midI_V_last-p.midI_iK_EK))))+((((-((p.midI_ctx_iPoisson_g_poisson.*midI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(midI_V_last-p.midI_ctx_iPoisson_E_poisson))))+((-(((p.midI_midE_iAMPActx_gAMPA.*(midI_midE_iAMPActx_s_last*p.midI_midE_iAMPActx_netcon).*(midI_V_last-p.midI_midE_iAMPActx_EAMPA)))))+((((-p.midI_midI_iGABActx_gGABAa.*(midI_midI_iGABActx_s_last*p.midI_midI_iGABActx_netcon).*(midI_V_last-p.midI_midI_iGABActx_EGABAa))))))))) + p.midI_noise*randn(1, p.midI_Npop))/p.midI_C;
  midI_iNa_m_k1 = (((2.5-.1*(midI_V_last+65))./(exp(2.5-.1*(midI_V_last+65))-1))).*(1-midI_iNa_m_last)-((4*exp(-(midI_V_last+65)/18))).*midI_iNa_m_last;
  midI_iNa_h_k1 = ((.07*exp(-(midI_V_last+65)/20))).*(1-midI_iNa_h_last)-((1./(exp(3-.1*(midI_V_last+65))+1))).*midI_iNa_h_last;
  midI_iK_n_k1 = (((.1-.01*(midI_V_last+65))./(exp(1-.1*(midI_V_last+65))-1))).*(1-midI_iK_n_last)-((.125*exp(-(midI_V_last+65)/80))).*midI_iK_n_last;
  deepE_V_k1 = (p.deepE_Iapp + ((((-p.deepE_iNa_gNa.*deepE_iNa_m_last.^3.*deepE_iNa_h_last.*(deepE_V_last-p.deepE_iNa_ENa))))+((((-p.deepE_iK_gK.*deepE_iK_n_last.^4.*(deepE_V_last-p.deepE_iK_EK))))+((((-((p.deepE_ctx_iPoisson_g_poisson.*deepE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(deepE_V_last-p.deepE_ctx_iPoisson_E_poisson))))+((-(((p.deepE_deepE_iAMPActx_gAMPA.*(deepE_deepE_iAMPActx_s_last*p.deepE_deepE_iAMPActx_netcon).*(deepE_V_last-p.deepE_deepE_iAMPActx_EAMPA)))))+((((-p.deepE_deepI_iGABActx_gGABAa.*(deepE_deepI_iGABActx_s_last*p.deepE_deepI_iGABActx_netcon).*(deepE_V_last-p.deepE_deepI_iGABActx_EGABAa))))+((-(((p.deepE_midE_iAMPActx_gAMPA.*(deepE_midE_iAMPActx_s_last*p.deepE_midE_iAMPActx_netcon).*(deepE_V_last-p.deepE_midE_iAMPActx_EAMPA)))))+((((-p.deepE_midI_iGABActx_gGABAa.*(deepE_midI_iGABActx_s_last*p.deepE_midI_iGABActx_netcon).*(deepE_V_last-p.deepE_midI_iGABActx_EGABAa))))+((-(((p.deepE_supE_iAMPActx_gAMPA.*(deepE_supE_iAMPActx_s_last*p.deepE_supE_iAMPActx_netcon).*(deepE_V_last-p.deepE_supE_iAMPActx_EAMPA))))))))))))) + p.deepE_noise*randn(1, p.deepE_Npop))/p.deepE_C;
  deepE_iNa_m_k1 = (((2.5-.1*(deepE_V_last+65))./(exp(2.5-.1*(deepE_V_last+65))-1))).*(1-deepE_iNa_m_last)-((4*exp(-(deepE_V_last+65)/18))).*deepE_iNa_m_last;
  deepE_iNa_h_k1 = ((.07*exp(-(deepE_V_last+65)/20))).*(1-deepE_iNa_h_last)-((1./(exp(3-.1*(deepE_V_last+65))+1))).*deepE_iNa_h_last;
  deepE_iK_n_k1 = (((.1-.01*(deepE_V_last+65))./(exp(1-.1*(deepE_V_last+65))-1))).*(1-deepE_iK_n_last)-((.125*exp(-(deepE_V_last+65)/80))).*deepE_iK_n_last;
  deepI_V_k1 = (p.deepI_Iapp + ((((-p.deepI_iNa_gNa.*deepI_iNa_m_last.^3.*deepI_iNa_h_last.*(deepI_V_last-p.deepI_iNa_ENa))))+((((-p.deepI_iK_gK.*deepI_iK_n_last.^4.*(deepI_V_last-p.deepI_iK_EK))))+((((-((p.deepI_ctx_iPoisson_g_poisson.*deepI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(deepI_V_last-p.deepI_ctx_iPoisson_E_poisson))))+((-(((p.deepI_deepE_iAMPActx_gAMPA.*(deepI_deepE_iAMPActx_s_last*p.deepI_deepE_iAMPActx_netcon).*(deepI_V_last-p.deepI_deepE_iAMPActx_EAMPA)))))+((((-p.deepI_deepI_iGABActx_gGABAa.*(deepI_deepI_iGABActx_s_last*p.deepI_deepI_iGABActx_netcon).*(deepI_V_last-p.deepI_deepI_iGABActx_EGABAa))))))))) + p.deepI_noise*randn(1, p.deepI_Npop))/p.deepI_C;
  deepI_iNa_m_k1 = (((2.5-.1*(deepI_V_last+65))./(exp(2.5-.1*(deepI_V_last+65))-1))).*(1-deepI_iNa_m_last)-((4*exp(-(deepI_V_last+65)/18))).*deepI_iNa_m_last;
  deepI_iNa_h_k1 = ((.07*exp(-(deepI_V_last+65)/20))).*(1-deepI_iNa_h_last)-((1./(exp(3-.1*(deepI_V_last+65))+1))).*deepI_iNa_h_last;
  deepI_iK_n_k1 = (((.1-.01*(deepI_V_last+65))./(exp(1-.1*(deepI_V_last+65))-1))).*(1-deepI_iK_n_last)-((.125*exp(-(deepI_V_last+65)/80))).*deepI_iK_n_last;
  IO_SA1_V_k1 = (p.IO_SA1_Iapp + ((((-p.IO_SA1_iNa_gNa.*IO_SA1_iNa_m_last.^3.*IO_SA1_iNa_h_last.*(IO_SA1_V_last-p.IO_SA1_iNa_ENa))))+((((-p.IO_SA1_iK_gK.*IO_SA1_iK_n_last.^4.*(IO_SA1_V_last-p.IO_SA1_iK_EK))))+((((-((p.IO_SA1_ctx_iPoisson_g_poisson.*IO_SA1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SA1_V_last-p.IO_SA1_ctx_iPoisson_E_poisson))))+((((-((p.IO_SA1_IO_SA1_iPoisson_gext.*IO_SA1_IO_SA1_iPoisson_s(k,:))).*(IO_SA1_V_last-p.IO_SA1_IO_SA1_iPoisson_Eext))))+((((-((p.IO_SA1_IO_SB1_iPoisson_gext.*IO_SA1_IO_SB1_iPoisson_s(k,:))).*(IO_SA1_V_last-p.IO_SA1_IO_SB1_iPoisson_Eext))))))))) + p.IO_SA1_noise*randn(1, p.IO_SA1_Npop))/p.IO_SA1_C;
  IO_SA1_iNa_m_k1 = (((2.5-.1*(IO_SA1_V_last+65))./(exp(2.5-.1*(IO_SA1_V_last+65))-1))).*(1-IO_SA1_iNa_m_last)-((4*exp(-(IO_SA1_V_last+65)/18))).*IO_SA1_iNa_m_last;
  IO_SA1_iNa_h_k1 = ((.07*exp(-(IO_SA1_V_last+65)/20))).*(1-IO_SA1_iNa_h_last)-((1./(exp(3-.1*(IO_SA1_V_last+65))+1))).*IO_SA1_iNa_h_last;
  IO_SA1_iK_n_k1 = (((.1-.01*(IO_SA1_V_last+65))./(exp(1-.1*(IO_SA1_V_last+65))-1))).*(1-IO_SA1_iK_n_last)-((.125*exp(-(IO_SA1_V_last+65)/80))).*IO_SA1_iK_n_last;
  IO_SB1_V_k1 = (p.IO_SB1_Iapp + ((((-p.IO_SB1_iNa_gNa.*IO_SB1_iNa_m_last.^3.*IO_SB1_iNa_h_last.*(IO_SB1_V_last-p.IO_SB1_iNa_ENa))))+((((-p.IO_SB1_iK_gK.*IO_SB1_iK_n_last.^4.*(IO_SB1_V_last-p.IO_SB1_iK_EK))))+((((-((p.IO_SB1_ctx_iPoisson_g_poisson.*IO_SB1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SB1_V_last-p.IO_SB1_ctx_iPoisson_E_poisson))))+((((-((p.IO_SB1_IO_SA1_iPoisson_gext.*IO_SB1_IO_SA1_iPoisson_s(k,:))).*(IO_SB1_V_last-p.IO_SB1_IO_SA1_iPoisson_Eext))))+((((-((p.IO_SB1_IO_SB1_iPoisson_gext.*IO_SB1_IO_SB1_iPoisson_s(k,:))).*(IO_SB1_V_last-p.IO_SB1_IO_SB1_iPoisson_Eext))))))))) + p.IO_SB1_noise*randn(1, p.IO_SB1_Npop))/p.IO_SB1_C;
  IO_SB1_iNa_m_k1 = (((2.5-.1*(IO_SB1_V_last+65))./(exp(2.5-.1*(IO_SB1_V_last+65))-1))).*(1-IO_SB1_iNa_m_last)-((4*exp(-(IO_SB1_V_last+65)/18))).*IO_SB1_iNa_m_last;
  IO_SB1_iNa_h_k1 = ((.07*exp(-(IO_SB1_V_last+65)/20))).*(1-IO_SB1_iNa_h_last)-((1./(exp(3-.1*(IO_SB1_V_last+65))+1))).*IO_SB1_iNa_h_last;
  IO_SB1_iK_n_k1 = (((.1-.01*(IO_SB1_V_last+65))./(exp(1-.1*(IO_SB1_V_last+65))-1))).*(1-IO_SB1_iK_n_last)-((.125*exp(-(IO_SB1_V_last+65)/80))).*IO_SB1_iK_n_last;
  IO_SC1_V_k1 = (p.IO_SC1_Iapp + ((((-p.IO_SC1_iNa_gNa.*IO_SC1_iNa_m_last.^3.*IO_SC1_iNa_h_last.*(IO_SC1_V_last-p.IO_SC1_iNa_ENa))))+((((-p.IO_SC1_iK_gK.*IO_SC1_iK_n_last.^4.*(IO_SC1_V_last-p.IO_SC1_iK_EK))))+((((-((p.IO_SC1_ctx_iPoisson_g_poisson.*IO_SC1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SC1_V_last-p.IO_SC1_ctx_iPoisson_E_poisson))))+((((-((p.IO_SC1_IO_SC1_iPoisson_gext.*IO_SC1_IO_SC1_iPoisson_s(k,:))).*(IO_SC1_V_last-p.IO_SC1_IO_SC1_iPoisson_Eext))))+((((-((p.IO_SC1_IO_SA2_iPoisson_gext.*IO_SC1_IO_SA2_iPoisson_s(k,:))).*(IO_SC1_V_last-p.IO_SC1_IO_SA2_iPoisson_Eext))))))))) + p.IO_SC1_noise*randn(1, p.IO_SC1_Npop))/p.IO_SC1_C;
  IO_SC1_iNa_m_k1 = (((2.5-.1*(IO_SC1_V_last+65))./(exp(2.5-.1*(IO_SC1_V_last+65))-1))).*(1-IO_SC1_iNa_m_last)-((4*exp(-(IO_SC1_V_last+65)/18))).*IO_SC1_iNa_m_last;
  IO_SC1_iNa_h_k1 = ((.07*exp(-(IO_SC1_V_last+65)/20))).*(1-IO_SC1_iNa_h_last)-((1./(exp(3-.1*(IO_SC1_V_last+65))+1))).*IO_SC1_iNa_h_last;
  IO_SC1_iK_n_k1 = (((.1-.01*(IO_SC1_V_last+65))./(exp(1-.1*(IO_SC1_V_last+65))-1))).*(1-IO_SC1_iK_n_last)-((.125*exp(-(IO_SC1_V_last+65)/80))).*IO_SC1_iK_n_last;
  IO_SA2_V_k1 = (p.IO_SA2_Iapp + ((((-p.IO_SA2_iNa_gNa.*IO_SA2_iNa_m_last.^3.*IO_SA2_iNa_h_last.*(IO_SA2_V_last-p.IO_SA2_iNa_ENa))))+((((-p.IO_SA2_iK_gK.*IO_SA2_iK_n_last.^4.*(IO_SA2_V_last-p.IO_SA2_iK_EK))))+((((-((p.IO_SA2_ctx_iPoisson_g_poisson.*IO_SA2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SA2_V_last-p.IO_SA2_ctx_iPoisson_E_poisson))))+((((-((p.IO_SA2_IO_SC1_iPoisson_gext.*IO_SA2_IO_SC1_iPoisson_s(k,:))).*(IO_SA2_V_last-p.IO_SA2_IO_SC1_iPoisson_Eext))))+((((-((p.IO_SA2_IO_SA2_iPoisson_gext.*IO_SA2_IO_SA2_iPoisson_s(k,:))).*(IO_SA2_V_last-p.IO_SA2_IO_SA2_iPoisson_Eext))))))))) + p.IO_SA2_noise*randn(1, p.IO_SA2_Npop))/p.IO_SA2_C;
  IO_SA2_iNa_m_k1 = (((2.5-.1*(IO_SA2_V_last+65))./(exp(2.5-.1*(IO_SA2_V_last+65))-1))).*(1-IO_SA2_iNa_m_last)-((4*exp(-(IO_SA2_V_last+65)/18))).*IO_SA2_iNa_m_last;
  IO_SA2_iNa_h_k1 = ((.07*exp(-(IO_SA2_V_last+65)/20))).*(1-IO_SA2_iNa_h_last)-((1./(exp(3-.1*(IO_SA2_V_last+65))+1))).*IO_SA2_iNa_h_last;
  IO_SA2_iK_n_k1 = (((.1-.01*(IO_SA2_V_last+65))./(exp(1-.1*(IO_SA2_V_last+65))-1))).*(1-IO_SA2_iK_n_last)-((.125*exp(-(IO_SA2_V_last+65)/80))).*IO_SA2_iK_n_last;
  IO_SB2_V_k1 = (p.IO_SB2_Iapp + ((((-p.IO_SB2_iNa_gNa.*IO_SB2_iNa_m_last.^3.*IO_SB2_iNa_h_last.*(IO_SB2_V_last-p.IO_SB2_iNa_ENa))))+((((-p.IO_SB2_iK_gK.*IO_SB2_iK_n_last.^4.*(IO_SB2_V_last-p.IO_SB2_iK_EK))))+((((-((p.IO_SB2_ctx_iPoisson_g_poisson.*IO_SB2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SB2_V_last-p.IO_SB2_ctx_iPoisson_E_poisson))))+((((-((p.IO_SB2_IO_SB2_iPoisson_gext.*IO_SB2_IO_SB2_iPoisson_s(k,:))).*(IO_SB2_V_last-p.IO_SB2_IO_SB2_iPoisson_Eext))))+((((-((p.IO_SB2_IO_SC2_iPoisson_gext.*IO_SB2_IO_SC2_iPoisson_s(k,:))).*(IO_SB2_V_last-p.IO_SB2_IO_SC2_iPoisson_Eext))))))))) + p.IO_SB2_noise*randn(1, p.IO_SB2_Npop))/p.IO_SB2_C;
  IO_SB2_iNa_m_k1 = (((2.5-.1*(IO_SB2_V_last+65))./(exp(2.5-.1*(IO_SB2_V_last+65))-1))).*(1-IO_SB2_iNa_m_last)-((4*exp(-(IO_SB2_V_last+65)/18))).*IO_SB2_iNa_m_last;
  IO_SB2_iNa_h_k1 = ((.07*exp(-(IO_SB2_V_last+65)/20))).*(1-IO_SB2_iNa_h_last)-((1./(exp(3-.1*(IO_SB2_V_last+65))+1))).*IO_SB2_iNa_h_last;
  IO_SB2_iK_n_k1 = (((.1-.01*(IO_SB2_V_last+65))./(exp(1-.1*(IO_SB2_V_last+65))-1))).*(1-IO_SB2_iK_n_last)-((.125*exp(-(IO_SB2_V_last+65)/80))).*IO_SB2_iK_n_last;
  IO_SC2_V_k1 = (p.IO_SC2_Iapp + ((((-p.IO_SC2_iNa_gNa.*IO_SC2_iNa_m_last.^3.*IO_SC2_iNa_h_last.*(IO_SC2_V_last-p.IO_SC2_iNa_ENa))))+((((-p.IO_SC2_iK_gK.*IO_SC2_iK_n_last.^4.*(IO_SC2_V_last-p.IO_SC2_iK_EK))))+((((-((p.IO_SC2_ctx_iPoisson_g_poisson.*IO_SC2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SC2_V_last-p.IO_SC2_ctx_iPoisson_E_poisson))))+((((-((p.IO_SC2_IO_SB2_iPoisson_gext.*IO_SC2_IO_SB2_iPoisson_s(k,:))).*(IO_SC2_V_last-p.IO_SC2_IO_SB2_iPoisson_Eext))))+((((-((p.IO_SC2_IO_SC2_iPoisson_gext.*IO_SC2_IO_SC2_iPoisson_s(k,:))).*(IO_SC2_V_last-p.IO_SC2_IO_SC2_iPoisson_Eext))))))))) + p.IO_SC2_noise*randn(1, p.IO_SC2_Npop))/p.IO_SC2_C;
  IO_SC2_iNa_m_k1 = (((2.5-.1*(IO_SC2_V_last+65))./(exp(2.5-.1*(IO_SC2_V_last+65))-1))).*(1-IO_SC2_iNa_m_last)-((4*exp(-(IO_SC2_V_last+65)/18))).*IO_SC2_iNa_m_last;
  IO_SC2_iNa_h_k1 = ((.07*exp(-(IO_SC2_V_last+65)/20))).*(1-IO_SC2_iNa_h_last)-((1./(exp(3-.1*(IO_SC2_V_last+65))+1))).*IO_SC2_iNa_h_last;
  IO_SC2_iK_n_k1 = (((.1-.01*(IO_SC2_V_last+65))./(exp(1-.1*(IO_SC2_V_last+65))-1))).*(1-IO_SC2_iK_n_last)-((.125*exp(-(IO_SC2_V_last+65)/80))).*IO_SC2_iK_n_last;
  IO_Cx1_V_k1 = (p.IO_Cx1_Iapp + ((((-p.IO_Cx1_iNa_gNa.*IO_Cx1_iNa_m_last.^3.*IO_Cx1_iNa_h_last.*(IO_Cx1_V_last-p.IO_Cx1_iNa_ENa))))+((((-p.IO_Cx1_iK_gK.*IO_Cx1_iK_n_last.^4.*(IO_Cx1_V_last-p.IO_Cx1_iK_EK))))+((((-((p.IO_Cx1_ctx_iPoisson_g_poisson.*IO_Cx1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_Cx1_V_last-p.IO_Cx1_ctx_iPoisson_E_poisson))))+((((-((p.IO_Cx1_IO_Cx1_iPoisson_gext.*IO_Cx1_IO_Cx1_iPoisson_s(k,:))).*(IO_Cx1_V_last-p.IO_Cx1_IO_Cx1_iPoisson_Eext))))+((((-((p.IO_Cx1_IO_Cx2_iPoisson_gext.*IO_Cx1_IO_Cx2_iPoisson_s(k,:))).*(IO_Cx1_V_last-p.IO_Cx1_IO_Cx2_iPoisson_Eext))))))))) + p.IO_Cx1_noise*randn(1, p.IO_Cx1_Npop))/p.IO_Cx1_C;
  IO_Cx1_iNa_m_k1 = (((2.5-.1*(IO_Cx1_V_last+65))./(exp(2.5-.1*(IO_Cx1_V_last+65))-1))).*(1-IO_Cx1_iNa_m_last)-((4*exp(-(IO_Cx1_V_last+65)/18))).*IO_Cx1_iNa_m_last;
  IO_Cx1_iNa_h_k1 = ((.07*exp(-(IO_Cx1_V_last+65)/20))).*(1-IO_Cx1_iNa_h_last)-((1./(exp(3-.1*(IO_Cx1_V_last+65))+1))).*IO_Cx1_iNa_h_last;
  IO_Cx1_iK_n_k1 = (((.1-.01*(IO_Cx1_V_last+65))./(exp(1-.1*(IO_Cx1_V_last+65))-1))).*(1-IO_Cx1_iK_n_last)-((.125*exp(-(IO_Cx1_V_last+65)/80))).*IO_Cx1_iK_n_last;
  IO_Cx2_V_k1 = (p.IO_Cx2_Iapp + ((((-p.IO_Cx2_iNa_gNa.*IO_Cx2_iNa_m_last.^3.*IO_Cx2_iNa_h_last.*(IO_Cx2_V_last-p.IO_Cx2_iNa_ENa))))+((((-p.IO_Cx2_iK_gK.*IO_Cx2_iK_n_last.^4.*(IO_Cx2_V_last-p.IO_Cx2_iK_EK))))+((((-((p.IO_Cx2_ctx_iPoisson_g_poisson.*IO_Cx2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_Cx2_V_last-p.IO_Cx2_ctx_iPoisson_E_poisson))))+((((-((p.IO_Cx2_IO_Cx1_iPoisson_gext.*IO_Cx2_IO_Cx1_iPoisson_s(k,:))).*(IO_Cx2_V_last-p.IO_Cx2_IO_Cx1_iPoisson_Eext))))+((((-((p.IO_Cx2_IO_Cx2_iPoisson_gext.*IO_Cx2_IO_Cx2_iPoisson_s(k,:))).*(IO_Cx2_V_last-p.IO_Cx2_IO_Cx2_iPoisson_Eext))))))))) + p.IO_Cx2_noise*randn(1, p.IO_Cx2_Npop))/p.IO_Cx2_C;
  IO_Cx2_iNa_m_k1 = (((2.5-.1*(IO_Cx2_V_last+65))./(exp(2.5-.1*(IO_Cx2_V_last+65))-1))).*(1-IO_Cx2_iNa_m_last)-((4*exp(-(IO_Cx2_V_last+65)/18))).*IO_Cx2_iNa_m_last;
  IO_Cx2_iNa_h_k1 = ((.07*exp(-(IO_Cx2_V_last+65)/20))).*(1-IO_Cx2_iNa_h_last)-((1./(exp(3-.1*(IO_Cx2_V_last+65))+1))).*IO_Cx2_iNa_h_last;
  IO_Cx2_iK_n_k1 = (((.1-.01*(IO_Cx2_V_last+65))./(exp(1-.1*(IO_Cx2_V_last+65))-1))).*(1-IO_Cx2_iK_n_last)-((.125*exp(-(IO_Cx2_V_last+65)/80))).*IO_Cx2_iK_n_last;
  supI_supE_iAMPActx_s_k1 = -supI_supE_iAMPActx_s_last./p.supI_supE_iAMPActx_tauAMPA + ((1-supI_supE_iAMPActx_s_last)/p.supI_supE_iAMPActx_tauAMPAr).*(1+tanh(supE_V_last/10));
  supE_supE_iAMPActx_s_k1 = -supE_supE_iAMPActx_s_last./p.supE_supE_iAMPActx_tauAMPA + ((1-supE_supE_iAMPActx_s_last)/p.supE_supE_iAMPActx_tauAMPAr).*(1+tanh(supE_V_last/10));
  supE_supI_iGABActx_s_k1 = -supE_supI_iGABActx_s_last./p.supE_supI_iGABActx_tauGABA + 1/2*(1+tanh(supI_V_last/10)).*((1-supE_supI_iGABActx_s_last)/p.supE_supI_iGABActx_tauGABAr);
  supI_supI_iGABActx_s_k1 = -supI_supI_iGABActx_s_last./p.supI_supI_iGABActx_tauGABA + 1/2*(1+tanh(supI_V_last/10)).*((1-supI_supI_iGABActx_s_last)/p.supI_supI_iGABActx_tauGABAr);
  midI_midE_iAMPActx_s_k1 = -midI_midE_iAMPActx_s_last./p.midI_midE_iAMPActx_tauAMPA + ((1-midI_midE_iAMPActx_s_last)/p.midI_midE_iAMPActx_tauAMPAr).*(1+tanh(midE_V_last/10));
  midE_midE_iAMPActx_s_k1 = -midE_midE_iAMPActx_s_last./p.midE_midE_iAMPActx_tauAMPA + ((1-midE_midE_iAMPActx_s_last)/p.midE_midE_iAMPActx_tauAMPAr).*(1+tanh(midE_V_last/10));
  midE_midI_iGABActx_s_k1 = -midE_midI_iGABActx_s_last./p.midE_midI_iGABActx_tauGABA + 1/2*(1+tanh(midI_V_last/10)).*((1-midE_midI_iGABActx_s_last)/p.midE_midI_iGABActx_tauGABAr);
  midI_midI_iGABActx_s_k1 = -midI_midI_iGABActx_s_last./p.midI_midI_iGABActx_tauGABA + 1/2*(1+tanh(midI_V_last/10)).*((1-midI_midI_iGABActx_s_last)/p.midI_midI_iGABActx_tauGABAr);
  deepI_deepE_iAMPActx_s_k1 = -deepI_deepE_iAMPActx_s_last./p.deepI_deepE_iAMPActx_tauAMPA + ((1-deepI_deepE_iAMPActx_s_last)/p.deepI_deepE_iAMPActx_tauAMPAr).*(1+tanh(deepE_V_last/10));
  deepE_deepE_iAMPActx_s_k1 = -deepE_deepE_iAMPActx_s_last./p.deepE_deepE_iAMPActx_tauAMPA + ((1-deepE_deepE_iAMPActx_s_last)/p.deepE_deepE_iAMPActx_tauAMPAr).*(1+tanh(deepE_V_last/10));
  deepE_deepI_iGABActx_s_k1 = -deepE_deepI_iGABActx_s_last./p.deepE_deepI_iGABActx_tauGABA + 1/2*(1+tanh(deepI_V_last/10)).*((1-deepE_deepI_iGABActx_s_last)/p.deepE_deepI_iGABActx_tauGABAr);
  deepI_deepI_iGABActx_s_k1 = -deepI_deepI_iGABActx_s_last./p.deepI_deepI_iGABActx_tauGABA + 1/2*(1+tanh(deepI_V_last/10)).*((1-deepI_deepI_iGABActx_s_last)/p.deepI_deepI_iGABActx_tauGABAr);
  midE_IO_SB1_iAMPActx_s_k1 = -midE_IO_SB1_iAMPActx_s_last./p.midE_IO_SB1_iAMPActx_tauAMPA + ((1-midE_IO_SB1_iAMPActx_s_last)/p.midE_IO_SB1_iAMPActx_tauAMPAr).*(1+tanh(IO_SB1_V_last/10));
  midE_IO_SB2_iAMPActx_s_k1 = -midE_IO_SB2_iAMPActx_s_last./p.midE_IO_SB2_iAMPActx_tauAMPA + ((1-midE_IO_SB2_iAMPActx_s_last)/p.midE_IO_SB2_iAMPActx_tauAMPAr).*(1+tanh(IO_SB2_V_last/10));
  midE_IO_SC1_iAMPActx_s_k1 = -midE_IO_SC1_iAMPActx_s_last./p.midE_IO_SC1_iAMPActx_tauAMPA + ((1-midE_IO_SC1_iAMPActx_s_last)/p.midE_IO_SC1_iAMPActx_tauAMPAr).*(1+tanh(IO_SC1_V_last/10));
  midE_IO_SC2_iAMPActx_s_k1 = -midE_IO_SC2_iAMPActx_s_last./p.midE_IO_SC2_iAMPActx_tauAMPA + ((1-midE_IO_SC2_iAMPActx_s_last)/p.midE_IO_SC2_iAMPActx_tauAMPAr).*(1+tanh(IO_SC2_V_last/10));
  midE_IO_Cx1_iAMPActx_s_k1 = -midE_IO_Cx1_iAMPActx_s_last./p.midE_IO_Cx1_iAMPActx_tauAMPA + ((1-midE_IO_Cx1_iAMPActx_s_last)/p.midE_IO_Cx1_iAMPActx_tauAMPAr).*(1+tanh(IO_Cx1_V_last/10));
  midE_IO_Cx2_iAMPActx_s_k1 = -midE_IO_Cx2_iAMPActx_s_last./p.midE_IO_Cx2_iAMPActx_tauAMPA + ((1-midE_IO_Cx2_iAMPActx_s_last)/p.midE_IO_Cx2_iAMPActx_tauAMPAr).*(1+tanh(IO_Cx2_V_last/10));
  supE_midE_iAMPActx_s_k1 = -supE_midE_iAMPActx_s_last./p.supE_midE_iAMPActx_tauAMPA + ((1-supE_midE_iAMPActx_s_last)/p.supE_midE_iAMPActx_tauAMPAr).*(1+tanh(midE_V_last/10));
  deepE_midE_iAMPActx_s_k1 = -deepE_midE_iAMPActx_s_last./p.deepE_midE_iAMPActx_tauAMPA + ((1-deepE_midE_iAMPActx_s_last)/p.deepE_midE_iAMPActx_tauAMPAr).*(1+tanh(midE_V_last/10));
  deepE_midI_iGABActx_s_k1 = -deepE_midI_iGABActx_s_last./p.deepE_midI_iGABActx_tauGABA + 1/2*(1+tanh(midI_V_last/10)).*((1-deepE_midI_iGABActx_s_last)/p.deepE_midI_iGABActx_tauGABAr);
  deepE_supE_iAMPActx_s_k1 = -deepE_supE_iAMPActx_s_last./p.deepE_supE_iAMPActx_tauAMPA + ((1-deepE_supE_iAMPActx_s_last)/p.deepE_supE_iAMPActx_tauAMPAr).*(1+tanh(supE_V_last/10));

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  supE_V_last = supE_V_last+dt*supE_V_k1;
  supE_iNa_m_last = supE_iNa_m_last+dt*supE_iNa_m_k1;
  supE_iNa_h_last = supE_iNa_h_last+dt*supE_iNa_h_k1;
  supE_iK_n_last = supE_iK_n_last+dt*supE_iK_n_k1;
  supI_V_last = supI_V_last+dt*supI_V_k1;
  supI_iNa_m_last = supI_iNa_m_last+dt*supI_iNa_m_k1;
  supI_iNa_h_last = supI_iNa_h_last+dt*supI_iNa_h_k1;
  supI_iK_n_last = supI_iK_n_last+dt*supI_iK_n_k1;
  midE_V_last = midE_V_last+dt*midE_V_k1;
  midE_iNa_m_last = midE_iNa_m_last+dt*midE_iNa_m_k1;
  midE_iNa_h_last = midE_iNa_h_last+dt*midE_iNa_h_k1;
  midE_iK_n_last = midE_iK_n_last+dt*midE_iK_n_k1;
  midI_V_last = midI_V_last+dt*midI_V_k1;
  midI_iNa_m_last = midI_iNa_m_last+dt*midI_iNa_m_k1;
  midI_iNa_h_last = midI_iNa_h_last+dt*midI_iNa_h_k1;
  midI_iK_n_last = midI_iK_n_last+dt*midI_iK_n_k1;
  deepE_V_last = deepE_V_last+dt*deepE_V_k1;
  deepE_iNa_m_last = deepE_iNa_m_last+dt*deepE_iNa_m_k1;
  deepE_iNa_h_last = deepE_iNa_h_last+dt*deepE_iNa_h_k1;
  deepE_iK_n_last = deepE_iK_n_last+dt*deepE_iK_n_k1;
  deepI_V_last = deepI_V_last+dt*deepI_V_k1;
  deepI_iNa_m_last = deepI_iNa_m_last+dt*deepI_iNa_m_k1;
  deepI_iNa_h_last = deepI_iNa_h_last+dt*deepI_iNa_h_k1;
  deepI_iK_n_last = deepI_iK_n_last+dt*deepI_iK_n_k1;
  IO_SA1_V_last = IO_SA1_V_last+dt*IO_SA1_V_k1;
  IO_SA1_iNa_m_last = IO_SA1_iNa_m_last+dt*IO_SA1_iNa_m_k1;
  IO_SA1_iNa_h_last = IO_SA1_iNa_h_last+dt*IO_SA1_iNa_h_k1;
  IO_SA1_iK_n_last = IO_SA1_iK_n_last+dt*IO_SA1_iK_n_k1;
  IO_SB1_V_last = IO_SB1_V_last+dt*IO_SB1_V_k1;
  IO_SB1_iNa_m_last = IO_SB1_iNa_m_last+dt*IO_SB1_iNa_m_k1;
  IO_SB1_iNa_h_last = IO_SB1_iNa_h_last+dt*IO_SB1_iNa_h_k1;
  IO_SB1_iK_n_last = IO_SB1_iK_n_last+dt*IO_SB1_iK_n_k1;
  IO_SC1_V_last = IO_SC1_V_last+dt*IO_SC1_V_k1;
  IO_SC1_iNa_m_last = IO_SC1_iNa_m_last+dt*IO_SC1_iNa_m_k1;
  IO_SC1_iNa_h_last = IO_SC1_iNa_h_last+dt*IO_SC1_iNa_h_k1;
  IO_SC1_iK_n_last = IO_SC1_iK_n_last+dt*IO_SC1_iK_n_k1;
  IO_SA2_V_last = IO_SA2_V_last+dt*IO_SA2_V_k1;
  IO_SA2_iNa_m_last = IO_SA2_iNa_m_last+dt*IO_SA2_iNa_m_k1;
  IO_SA2_iNa_h_last = IO_SA2_iNa_h_last+dt*IO_SA2_iNa_h_k1;
  IO_SA2_iK_n_last = IO_SA2_iK_n_last+dt*IO_SA2_iK_n_k1;
  IO_SB2_V_last = IO_SB2_V_last+dt*IO_SB2_V_k1;
  IO_SB2_iNa_m_last = IO_SB2_iNa_m_last+dt*IO_SB2_iNa_m_k1;
  IO_SB2_iNa_h_last = IO_SB2_iNa_h_last+dt*IO_SB2_iNa_h_k1;
  IO_SB2_iK_n_last = IO_SB2_iK_n_last+dt*IO_SB2_iK_n_k1;
  IO_SC2_V_last = IO_SC2_V_last+dt*IO_SC2_V_k1;
  IO_SC2_iNa_m_last = IO_SC2_iNa_m_last+dt*IO_SC2_iNa_m_k1;
  IO_SC2_iNa_h_last = IO_SC2_iNa_h_last+dt*IO_SC2_iNa_h_k1;
  IO_SC2_iK_n_last = IO_SC2_iK_n_last+dt*IO_SC2_iK_n_k1;
  IO_Cx1_V_last = IO_Cx1_V_last+dt*IO_Cx1_V_k1;
  IO_Cx1_iNa_m_last = IO_Cx1_iNa_m_last+dt*IO_Cx1_iNa_m_k1;
  IO_Cx1_iNa_h_last = IO_Cx1_iNa_h_last+dt*IO_Cx1_iNa_h_k1;
  IO_Cx1_iK_n_last = IO_Cx1_iK_n_last+dt*IO_Cx1_iK_n_k1;
  IO_Cx2_V_last = IO_Cx2_V_last+dt*IO_Cx2_V_k1;
  IO_Cx2_iNa_m_last = IO_Cx2_iNa_m_last+dt*IO_Cx2_iNa_m_k1;
  IO_Cx2_iNa_h_last = IO_Cx2_iNa_h_last+dt*IO_Cx2_iNa_h_k1;
  IO_Cx2_iK_n_last = IO_Cx2_iK_n_last+dt*IO_Cx2_iK_n_k1;
  supI_supE_iAMPActx_s_last = supI_supE_iAMPActx_s_last+dt*supI_supE_iAMPActx_s_k1;
  supE_supE_iAMPActx_s_last = supE_supE_iAMPActx_s_last+dt*supE_supE_iAMPActx_s_k1;
  supE_supI_iGABActx_s_last = supE_supI_iGABActx_s_last+dt*supE_supI_iGABActx_s_k1;
  supI_supI_iGABActx_s_last = supI_supI_iGABActx_s_last+dt*supI_supI_iGABActx_s_k1;
  midI_midE_iAMPActx_s_last = midI_midE_iAMPActx_s_last+dt*midI_midE_iAMPActx_s_k1;
  midE_midE_iAMPActx_s_last = midE_midE_iAMPActx_s_last+dt*midE_midE_iAMPActx_s_k1;
  midE_midI_iGABActx_s_last = midE_midI_iGABActx_s_last+dt*midE_midI_iGABActx_s_k1;
  midI_midI_iGABActx_s_last = midI_midI_iGABActx_s_last+dt*midI_midI_iGABActx_s_k1;
  deepI_deepE_iAMPActx_s_last = deepI_deepE_iAMPActx_s_last+dt*deepI_deepE_iAMPActx_s_k1;
  deepE_deepE_iAMPActx_s_last = deepE_deepE_iAMPActx_s_last+dt*deepE_deepE_iAMPActx_s_k1;
  deepE_deepI_iGABActx_s_last = deepE_deepI_iGABActx_s_last+dt*deepE_deepI_iGABActx_s_k1;
  deepI_deepI_iGABActx_s_last = deepI_deepI_iGABActx_s_last+dt*deepI_deepI_iGABActx_s_k1;
  midE_IO_SB1_iAMPActx_s_last = midE_IO_SB1_iAMPActx_s_last+dt*midE_IO_SB1_iAMPActx_s_k1;
  midE_IO_SB2_iAMPActx_s_last = midE_IO_SB2_iAMPActx_s_last+dt*midE_IO_SB2_iAMPActx_s_k1;
  midE_IO_SC1_iAMPActx_s_last = midE_IO_SC1_iAMPActx_s_last+dt*midE_IO_SC1_iAMPActx_s_k1;
  midE_IO_SC2_iAMPActx_s_last = midE_IO_SC2_iAMPActx_s_last+dt*midE_IO_SC2_iAMPActx_s_k1;
  midE_IO_Cx1_iAMPActx_s_last = midE_IO_Cx1_iAMPActx_s_last+dt*midE_IO_Cx1_iAMPActx_s_k1;
  midE_IO_Cx2_iAMPActx_s_last = midE_IO_Cx2_iAMPActx_s_last+dt*midE_IO_Cx2_iAMPActx_s_k1;
  supE_midE_iAMPActx_s_last = supE_midE_iAMPActx_s_last+dt*supE_midE_iAMPActx_s_k1;
  deepE_midE_iAMPActx_s_last = deepE_midE_iAMPActx_s_last+dt*deepE_midE_iAMPActx_s_k1;
  deepE_midI_iGABActx_s_last = deepE_midI_iGABActx_s_last+dt*deepE_midI_iGABActx_s_k1;
  deepE_supE_iAMPActx_s_last = deepE_supE_iAMPActx_s_last+dt*deepE_supE_iAMPActx_s_k1;

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    supE_V(n,:) = supE_V_last;
    supE_iNa_m(n,:) = supE_iNa_m_last;
    supE_iNa_h(n,:) = supE_iNa_h_last;
    supE_iK_n(n,:) = supE_iK_n_last;
    supI_V(n,:) = supI_V_last;
    supI_iNa_m(n,:) = supI_iNa_m_last;
    supI_iNa_h(n,:) = supI_iNa_h_last;
    supI_iK_n(n,:) = supI_iK_n_last;
    midE_V(n,:) = midE_V_last;
    midE_iNa_m(n,:) = midE_iNa_m_last;
    midE_iNa_h(n,:) = midE_iNa_h_last;
    midE_iK_n(n,:) = midE_iK_n_last;
    midI_V(n,:) = midI_V_last;
    midI_iNa_m(n,:) = midI_iNa_m_last;
    midI_iNa_h(n,:) = midI_iNa_h_last;
    midI_iK_n(n,:) = midI_iK_n_last;
    deepE_V(n,:) = deepE_V_last;
    deepE_iNa_m(n,:) = deepE_iNa_m_last;
    deepE_iNa_h(n,:) = deepE_iNa_h_last;
    deepE_iK_n(n,:) = deepE_iK_n_last;
    deepI_V(n,:) = deepI_V_last;
    deepI_iNa_m(n,:) = deepI_iNa_m_last;
    deepI_iNa_h(n,:) = deepI_iNa_h_last;
    deepI_iK_n(n,:) = deepI_iK_n_last;
    IO_SA1_V(n,:) = IO_SA1_V_last;
    IO_SA1_iNa_m(n,:) = IO_SA1_iNa_m_last;
    IO_SA1_iNa_h(n,:) = IO_SA1_iNa_h_last;
    IO_SA1_iK_n(n,:) = IO_SA1_iK_n_last;
    IO_SB1_V(n,:) = IO_SB1_V_last;
    IO_SB1_iNa_m(n,:) = IO_SB1_iNa_m_last;
    IO_SB1_iNa_h(n,:) = IO_SB1_iNa_h_last;
    IO_SB1_iK_n(n,:) = IO_SB1_iK_n_last;
    IO_SC1_V(n,:) = IO_SC1_V_last;
    IO_SC1_iNa_m(n,:) = IO_SC1_iNa_m_last;
    IO_SC1_iNa_h(n,:) = IO_SC1_iNa_h_last;
    IO_SC1_iK_n(n,:) = IO_SC1_iK_n_last;
    IO_SA2_V(n,:) = IO_SA2_V_last;
    IO_SA2_iNa_m(n,:) = IO_SA2_iNa_m_last;
    IO_SA2_iNa_h(n,:) = IO_SA2_iNa_h_last;
    IO_SA2_iK_n(n,:) = IO_SA2_iK_n_last;
    IO_SB2_V(n,:) = IO_SB2_V_last;
    IO_SB2_iNa_m(n,:) = IO_SB2_iNa_m_last;
    IO_SB2_iNa_h(n,:) = IO_SB2_iNa_h_last;
    IO_SB2_iK_n(n,:) = IO_SB2_iK_n_last;
    IO_SC2_V(n,:) = IO_SC2_V_last;
    IO_SC2_iNa_m(n,:) = IO_SC2_iNa_m_last;
    IO_SC2_iNa_h(n,:) = IO_SC2_iNa_h_last;
    IO_SC2_iK_n(n,:) = IO_SC2_iK_n_last;
    IO_Cx1_V(n,:) = IO_Cx1_V_last;
    IO_Cx1_iNa_m(n,:) = IO_Cx1_iNa_m_last;
    IO_Cx1_iNa_h(n,:) = IO_Cx1_iNa_h_last;
    IO_Cx1_iK_n(n,:) = IO_Cx1_iK_n_last;
    IO_Cx2_V(n,:) = IO_Cx2_V_last;
    IO_Cx2_iNa_m(n,:) = IO_Cx2_iNa_m_last;
    IO_Cx2_iNa_h(n,:) = IO_Cx2_iNa_h_last;
    IO_Cx2_iK_n(n,:) = IO_Cx2_iK_n_last;
    supI_supE_iAMPActx_s(n,:) = supI_supE_iAMPActx_s_last;
    supE_supE_iAMPActx_s(n,:) = supE_supE_iAMPActx_s_last;
    supE_supI_iGABActx_s(n,:) = supE_supI_iGABActx_s_last;
    supI_supI_iGABActx_s(n,:) = supI_supI_iGABActx_s_last;
    midI_midE_iAMPActx_s(n,:) = midI_midE_iAMPActx_s_last;
    midE_midE_iAMPActx_s(n,:) = midE_midE_iAMPActx_s_last;
    midE_midI_iGABActx_s(n,:) = midE_midI_iGABActx_s_last;
    midI_midI_iGABActx_s(n,:) = midI_midI_iGABActx_s_last;
    deepI_deepE_iAMPActx_s(n,:) = deepI_deepE_iAMPActx_s_last;
    deepE_deepE_iAMPActx_s(n,:) = deepE_deepE_iAMPActx_s_last;
    deepE_deepI_iGABActx_s(n,:) = deepE_deepI_iGABActx_s_last;
    deepI_deepI_iGABActx_s(n,:) = deepI_deepI_iGABActx_s_last;
    midE_IO_SB1_iAMPActx_s(n,:) = midE_IO_SB1_iAMPActx_s_last;
    midE_IO_SB2_iAMPActx_s(n,:) = midE_IO_SB2_iAMPActx_s_last;
    midE_IO_SC1_iAMPActx_s(n,:) = midE_IO_SC1_iAMPActx_s_last;
    midE_IO_SC2_iAMPActx_s(n,:) = midE_IO_SC2_iAMPActx_s_last;
    midE_IO_Cx1_iAMPActx_s(n,:) = midE_IO_Cx1_iAMPActx_s_last;
    midE_IO_Cx2_iAMPActx_s(n,:) = midE_IO_Cx2_iAMPActx_s_last;
    supE_midE_iAMPActx_s(n,:) = supE_midE_iAMPActx_s_last;
    deepE_midE_iAMPActx_s(n,:) = deepE_midE_iAMPActx_s_last;
    deepE_midI_iGABActx_s(n,:) = deepE_midI_iGABActx_s_last;
    deepE_supE_iAMPActx_s(n,:) = deepE_supE_iAMPActx_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  supE_ctx_iPoisson_g_poisson(n,:)=p.supE_ctx_iPoisson_g_poisson.*supE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
  supE_ctx_iPoisson_I_poisson(n,:)=-((p.supE_ctx_iPoisson_g_poisson.*supE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(supE_V(n,:)-p.supE_ctx_iPoisson_E_poisson);
  supI_ctx_iPoisson_g_poisson(n,:)=p.supI_ctx_iPoisson_g_poisson.*supI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
  supI_ctx_iPoisson_I_poisson(n,:)=-((p.supI_ctx_iPoisson_g_poisson.*supI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(supI_V(n,:)-p.supI_ctx_iPoisson_E_poisson);
  midE_ctx_iPoisson_g_poisson(n,:)=p.midE_ctx_iPoisson_g_poisson.*midE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
  midE_ctx_iPoisson_I_poisson(n,:)=-((p.midE_ctx_iPoisson_g_poisson.*midE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(midE_V(n,:)-p.midE_ctx_iPoisson_E_poisson);
  midI_ctx_iPoisson_g_poisson(n,:)=p.midI_ctx_iPoisson_g_poisson.*midI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
  midI_ctx_iPoisson_I_poisson(n,:)=-((p.midI_ctx_iPoisson_g_poisson.*midI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(midI_V(n,:)-p.midI_ctx_iPoisson_E_poisson);
  deepE_ctx_iPoisson_g_poisson(n,:)=p.deepE_ctx_iPoisson_g_poisson.*deepE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
  deepE_ctx_iPoisson_I_poisson(n,:)=-((p.deepE_ctx_iPoisson_g_poisson.*deepE_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(deepE_V(n,:)-p.deepE_ctx_iPoisson_E_poisson);
  deepI_ctx_iPoisson_g_poisson(n,:)=p.deepI_ctx_iPoisson_g_poisson.*deepI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
  deepI_ctx_iPoisson_I_poisson(n,:)=-((p.deepI_ctx_iPoisson_g_poisson.*deepI_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(deepI_V(n,:)-p.deepI_ctx_iPoisson_E_poisson);
  IO_SA1_ctx_iPoisson_g_poisson(n,:)=p.IO_SA1_ctx_iPoisson_g_poisson.*IO_SA1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
  IO_SA1_ctx_iPoisson_I_poisson(n,:)=-((p.IO_SA1_ctx_iPoisson_g_poisson.*IO_SA1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SA1_V(n,:)-p.IO_SA1_ctx_iPoisson_E_poisson);
  IO_SB1_ctx_iPoisson_g_poisson(n,:)=p.IO_SB1_ctx_iPoisson_g_poisson.*IO_SB1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
  IO_SB1_ctx_iPoisson_I_poisson(n,:)=-((p.IO_SB1_ctx_iPoisson_g_poisson.*IO_SB1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SB1_V(n,:)-p.IO_SB1_ctx_iPoisson_E_poisson);
  IO_SC1_ctx_iPoisson_g_poisson(n,:)=p.IO_SC1_ctx_iPoisson_g_poisson.*IO_SC1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
  IO_SC1_ctx_iPoisson_I_poisson(n,:)=-((p.IO_SC1_ctx_iPoisson_g_poisson.*IO_SC1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SC1_V(n,:)-p.IO_SC1_ctx_iPoisson_E_poisson);
  IO_SA2_ctx_iPoisson_g_poisson(n,:)=p.IO_SA2_ctx_iPoisson_g_poisson.*IO_SA2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
  IO_SA2_ctx_iPoisson_I_poisson(n,:)=-((p.IO_SA2_ctx_iPoisson_g_poisson.*IO_SA2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SA2_V(n,:)-p.IO_SA2_ctx_iPoisson_E_poisson);
  IO_SB2_ctx_iPoisson_g_poisson(n,:)=p.IO_SB2_ctx_iPoisson_g_poisson.*IO_SB2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
  IO_SB2_ctx_iPoisson_I_poisson(n,:)=-((p.IO_SB2_ctx_iPoisson_g_poisson.*IO_SB2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SB2_V(n,:)-p.IO_SB2_ctx_iPoisson_E_poisson);
  IO_SC2_ctx_iPoisson_g_poisson(n,:)=p.IO_SC2_ctx_iPoisson_g_poisson.*IO_SC2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
  IO_SC2_ctx_iPoisson_I_poisson(n,:)=-((p.IO_SC2_ctx_iPoisson_g_poisson.*IO_SC2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_SC2_V(n,:)-p.IO_SC2_ctx_iPoisson_E_poisson);
  IO_Cx1_ctx_iPoisson_g_poisson(n,:)=p.IO_Cx1_ctx_iPoisson_g_poisson.*IO_Cx1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
  IO_Cx1_ctx_iPoisson_I_poisson(n,:)=-((p.IO_Cx1_ctx_iPoisson_g_poisson.*IO_Cx1_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_Cx1_V(n,:)-p.IO_Cx1_ctx_iPoisson_E_poisson);
  IO_Cx2_ctx_iPoisson_g_poisson(n,:)=p.IO_Cx2_ctx_iPoisson_g_poisson.*IO_Cx2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:);
  IO_Cx2_ctx_iPoisson_I_poisson(n,:)=-((p.IO_Cx2_ctx_iPoisson_g_poisson.*IO_Cx2_ctx_iPoisson_s_poisson(1+floor(t/(0.5*dt)),:))).*(IO_Cx2_V(n,:)-p.IO_Cx2_ctx_iPoisson_E_poisson);
  IO_SB1_IO_SA1_iPoisson_gPoisson(n,:)=p.IO_SB1_IO_SA1_iPoisson_gext.*IO_SB1_IO_SA1_iPoisson_s(k,:);
  IO_SA1_IO_SA1_iPoisson_gPoisson(n,:)=p.IO_SA1_IO_SA1_iPoisson_gext.*IO_SA1_IO_SA1_iPoisson_s(k,:);
  IO_SA1_IO_SB1_iPoisson_gPoisson(n,:)=p.IO_SA1_IO_SB1_iPoisson_gext.*IO_SA1_IO_SB1_iPoisson_s(k,:);
  IO_SB1_IO_SB1_iPoisson_gPoisson(n,:)=p.IO_SB1_IO_SB1_iPoisson_gext.*IO_SB1_IO_SB1_iPoisson_s(k,:);
  IO_SA2_IO_SC1_iPoisson_gPoisson(n,:)=p.IO_SA2_IO_SC1_iPoisson_gext.*IO_SA2_IO_SC1_iPoisson_s(k,:);
  IO_SC1_IO_SC1_iPoisson_gPoisson(n,:)=p.IO_SC1_IO_SC1_iPoisson_gext.*IO_SC1_IO_SC1_iPoisson_s(k,:);
  IO_SC1_IO_SA2_iPoisson_gPoisson(n,:)=p.IO_SC1_IO_SA2_iPoisson_gext.*IO_SC1_IO_SA2_iPoisson_s(k,:);
  IO_SA2_IO_SA2_iPoisson_gPoisson(n,:)=p.IO_SA2_IO_SA2_iPoisson_gext.*IO_SA2_IO_SA2_iPoisson_s(k,:);
  IO_SC2_IO_SB2_iPoisson_gPoisson(n,:)=p.IO_SC2_IO_SB2_iPoisson_gext.*IO_SC2_IO_SB2_iPoisson_s(k,:);
  IO_SB2_IO_SB2_iPoisson_gPoisson(n,:)=p.IO_SB2_IO_SB2_iPoisson_gext.*IO_SB2_IO_SB2_iPoisson_s(k,:);
  IO_SB2_IO_SC2_iPoisson_gPoisson(n,:)=p.IO_SB2_IO_SC2_iPoisson_gext.*IO_SB2_IO_SC2_iPoisson_s(k,:);
  IO_SC2_IO_SC2_iPoisson_gPoisson(n,:)=p.IO_SC2_IO_SC2_iPoisson_gext.*IO_SC2_IO_SC2_iPoisson_s(k,:);
  IO_Cx2_IO_Cx1_iPoisson_gPoisson(n,:)=p.IO_Cx2_IO_Cx1_iPoisson_gext.*IO_Cx2_IO_Cx1_iPoisson_s(k,:);
  IO_Cx1_IO_Cx1_iPoisson_gPoisson(n,:)=p.IO_Cx1_IO_Cx1_iPoisson_gext.*IO_Cx1_IO_Cx1_iPoisson_s(k,:);
  IO_Cx1_IO_Cx2_iPoisson_gPoisson(n,:)=p.IO_Cx1_IO_Cx2_iPoisson_gext.*IO_Cx1_IO_Cx2_iPoisson_s(k,:);
  IO_Cx2_IO_Cx2_iPoisson_gPoisson(n,:)=p.IO_Cx2_IO_Cx2_iPoisson_gext.*IO_Cx2_IO_Cx2_iPoisson_s(k,:);
  midE_IO_SA1_iPoisson_gPoisson(n,:)=p.midE_IO_SA1_iPoisson_gext.*midE_IO_SA1_iPoisson_s(k,:);
  midE_IO_SA2_iPoisson_gPoisson(n,:)=p.midE_IO_SA2_iPoisson_gext.*midE_IO_SA2_iPoisson_s(k,:);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
